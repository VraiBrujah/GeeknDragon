<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation Int√©gration - Tests Syst√®me</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-green-400">
            ‚úÖ Validation de l'Int√©gration des Tests
        </h1>
        
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 text-blue-400">Status des Composants</h2>
            <div id="component-status"></div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 text-purple-400">Tests Critiques</h2>
            <button id="run-critical-tests" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded mb-4">
                üéØ Ex√©cuter Tests Critiques
            </button>
            <div id="critical-results"></div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 text-yellow-400">Test du Cas Probl√©matique (1661 cuivres)</h2>
            <button id="test-1661" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded mb-4">
                üîç Tester 1661 Cuivres
            </button>
            <div id="test-1661-results"></div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4 text-green-400">Validation Finale</h2>
            <button id="full-validation" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded mb-4">
                ‚úÖ Validation Compl√®te
            </button>
            <div id="validation-results"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/snipcart-utils.js"></script>
    <script src="/js/currency-converter.js"></script>
    <script src="/js/currency-converter-tests.js"></script>
    
    <script>
        let converter = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeSystem();
            checkComponentStatus();
        });
        
        async function initializeSystem() {
            try {
                const response = await fetch('http://192.168.2.33:8000/data/products.json');
                const products = await response.json();
                converter = new CurrencyConverterPremium(products);
                console.log('‚úÖ Syst√®me initialis√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur d\'initialisation:', error);
            }
        }
        
        function checkComponentStatus() {
            const statusDiv = document.getElementById('component-status');
            const status = [];
            
            // V√©rifier les composants critiques
            const components = [
                { name: 'CurrencyConverterPremium', obj: window.CurrencyConverterPremium },
                { name: 'CurrencyConverterTests', obj: window.CurrencyConverterTests },
                { name: 'SnipcartUtils', obj: window.SnipcartUtils },
                { name: 'Convertisseur initialis√©', obj: converter }
            ];
            
            components.forEach(comp => {
                const status_class = comp.obj ? 'text-green-400' : 'text-red-400';
                const icon = comp.obj ? '‚úÖ' : '‚ùå';
                status.push(`<div class="${status_class}">${icon} ${comp.name}</div>`);
            });
            
            statusDiv.innerHTML = status.join('');
        }
        
        document.getElementById('run-critical-tests').addEventListener('click', function() {
            if (!window.CurrencyConverterTests) {
                document.getElementById('critical-results').innerHTML = 
                    '<div class="text-red-400">‚ùå Tests non disponibles</div>';
                return;
            }
            
            const basicResults = window.CurrencyConverterTests.runBasicTests();
            const advancedResults = window.CurrencyConverterTests.runAdvancedTests();
            
            const allResults = [...basicResults, ...advancedResults];
            const passed = allResults.filter(r => r.passed).length;
            const total = allResults.length;
            
            const success = passed === total;
            const statusClass = success ? 'text-green-400' : 'text-red-400';
            const statusIcon = success ? '‚úÖ' : '‚ùå';
            
            let html = `<div class="${statusClass} font-semibold mb-4">
                ${statusIcon} ${passed}/${total} tests r√©ussis
            </div>`;
            
            if (!success) {
                const failed = allResults.filter(r => !r.passed);
                html += '<div class="text-red-300 text-sm">Tests √©chou√©s:</div>';
                failed.forEach(test => {
                    html += `<div class="text-red-300 text-xs pl-4">‚Ä¢ ${test.name}</div>`;
                });
            }
            
            document.getElementById('critical-results').innerHTML = html;
        });
        
        document.getElementById('test-1661').addEventListener('click', function() {
            if (!converter) {
                document.getElementById('test-1661-results').innerHTML = 
                    '<div class="text-red-400">‚ùå Convertisseur non initialis√©</div>';
                return;
            }
            
            try {
                const result = converter.findMinimalCoins(1661);
                const lots = converter.convertSolutionToLots(result);
                
                let html = '<div class="text-green-400 font-semibold">‚úÖ Test 1661 cuivres</div>';
                html += `<div class="text-sm mt-2">Pi√®ces optimales: ${result.totalPieces}</div>`;
                
                html += '<div class="text-sm mt-2">R√©partition:</div>';
                Object.entries(result.coins).forEach(([metal, data]) => {
                    if (data.total > 0) {
                        html += `<div class="text-xs pl-4">‚Ä¢ ${data.total} ${metal}`;
                        if (data.multiplier > 1) html += ` (√ó${data.multiplier})`;
                        html += `</div>`;
                    }
                });
                
                if (lots && lots.length > 0) {
                    const totalCost = lots.reduce((sum, lot) => sum + (lot.price * lot.quantity), 0);
                    html += `<div class="text-sm mt-2">Lots recommand√©s (${totalCost}$):</div>`;
                    lots.forEach(lot => {
                        html += `<div class="text-xs pl-4">‚Ä¢ ${lot.displayName}: ${lot.price}$ (qty: ${lot.quantity})</div>`;
                    });
                }
                
                document.getElementById('test-1661-results').innerHTML = html;
                
            } catch (error) {
                document.getElementById('test-1661-results').innerHTML = 
                    `<div class="text-red-400">‚ùå Erreur: ${error.message}</div>`;
            }
        });
        
        document.getElementById('full-validation').addEventListener('click', function() {
            const resultsDiv = document.getElementById('validation-results');
            resultsDiv.innerHTML = '<div class="text-yellow-400">üîÑ Validation en cours...</div>';
            
            setTimeout(() => {
                let allPassed = true;
                let report = [];
                
                // 1. Tests syst√®me
                if (window.CurrencyConverterTests) {
                    const basicResults = window.CurrencyConverterTests.runBasicTests();
                    const advancedResults = window.CurrencyConverterTests.runAdvancedTests();
                    const allResults = [...basicResults, ...advancedResults];
                    const passed = allResults.filter(r => r.passed).length;
                    const total = allResults.length;
                    
                    if (passed === total) {
                        report.push('‚úÖ Tous les tests automatiques passent');
                    } else {
                        report.push(`‚ùå ${total - passed}/${total} tests √©chouent`);
                        allPassed = false;
                    }
                } else {
                    report.push('‚ùå Module de tests non disponible');
                    allPassed = false;
                }
                
                // 2. Test du cas probl√©matique
                if (converter) {
                    try {
                        const result = converter.findMinimalCoins(1661);
                        if (result.totalPieces <= 6) { // Acceptable pour m√©taheuristique
                            report.push('‚úÖ Cas 1661 cuivres r√©solu optimalement');
                        } else {
                            report.push(`‚ùå Cas 1661 cuivres non optimal (${result.totalPieces} pi√®ces)`);
                            allPassed = false;
                        }
                    } catch (error) {
                        report.push(`‚ùå Erreur sur cas 1661: ${error.message}`);
                        allPassed = false;
                    }
                } else {
                    report.push('‚ùå Convertisseur non initialis√©');
                    allPassed = false;
                }
                
                // 3. Validation des composants
                const requiredComponents = [
                    'CurrencyConverterPremium',
                    'CurrencyConverterTests', 
                    'SnipcartUtils'
                ];
                
                const missingComponents = requiredComponents.filter(comp => !window[comp]);
                if (missingComponents.length === 0) {
                    report.push('‚úÖ Tous les composants sont charg√©s');
                } else {
                    report.push(`‚ùå Composants manquants: ${missingComponents.join(', ')}`);
                    allPassed = false;
                }
                
                // Affichage du rapport final
                const statusClass = allPassed ? 'text-green-400' : 'text-red-400';
                const statusIcon = allPassed ? '‚úÖ' : '‚ùå';
                
                let html = `<div class="${statusClass} font-semibold text-lg mb-4">
                    ${statusIcon} Validation ${allPassed ? 'R√âUSSIE' : '√âCHOU√âE'}
                </div>`;
                
                html += '<div class="space-y-2">';
                report.forEach(item => {
                    html += `<div class="text-sm">${item}</div>`;
                });
                html += '</div>';
                
                if (allPassed) {
                    html += `<div class="mt-6 p-4 bg-green-900/30 rounded border border-green-600">
                        <div class="font-semibold text-green-300">üéâ Syst√®me Valid√©!</div>
                        <div class="text-sm text-green-200 mt-2">
                            Le syst√®me m√©taheuristique de conversion et de recommandations de lots 
                            fonctionne correctement. L'int√©gration des tests est r√©ussie.
                        </div>
                        <div class="text-sm text-green-200 mt-2">
                            <strong>Acc√®s:</strong> Ctrl+Shift+T dans aide-jeux.php ou URL avec #debug
                        </div>
                    </div>`;
                }
                
                resultsDiv.innerHTML = html;
            }, 500);
        });
    </script>
</body>
</html>