class BoutiqueAsyncLoader{constructor(){this.apiEndpoint="/api/products-async.php",this.loadedSections=new Set,this.loading=!1,this.retryAttempts=3,this.retryDelay=1e3,this.init()}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.startLoading()):this.startLoading()}async startLoading(){if(!this.loading){this.loading=!0;try{const t=document.documentElement.lang||"fr",e=await this.fetchWithRetry(`${this.apiEndpoint}?category=all&lang=${t}`);if(e.error)throw new Error(e.error);this.injectProducts("pieces",e.pieces,e.counts.pieces),this.injectProducts("cartes",e.cards,e.counts.cards),this.injectProducts("triptyques",e.triptychs,e.counts.triptychs),this.initializeFeatures()}catch(t){this.showErrorState()}finally{this.loading=!1}}}async fetchWithRetry(t,e=1){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return await e.json()}catch(i){if(e<this.retryAttempts)return await new Promise(t=>setTimeout(t,this.retryDelay)),this.fetchWithRetry(t,e+1);throw i}}injectProducts(t,e,i){const n=document.querySelector(`#${t} .shop-grid`);n&&(n.innerHTML=e,this.animateProductsIn(n),this.loadedSections.add(t))}animateProductsIn(t){t.querySelectorAll(".product-card").forEach((t,e)=>{t.style.opacity="0",t.style.transform="translateY(20px)",setTimeout(()=>{t.style.transition="opacity 0.3s ease, transform 0.3s ease",t.style.opacity="1",t.style.transform="translateY(0)"},50*e)})}initializeFeatures(){this.initQuantitySelectors(),this.initCustomSelectors(),this.initSnipcartButtons(),this.initAsyncStock(),this.initTranslations(),this.initHorizontalScroll()}initHorizontalScroll(){document.querySelectorAll(".shop-grid").forEach(t=>{t.scrollLeft=0;if("ontouchstart"in window||navigator.maxTouchPoints>0)return;let e=!1,i=null;t.addEventListener("mouseenter",()=>{i=setTimeout(()=>{e=!0},1e3)}),t.addEventListener("mouseleave",()=>{clearTimeout(i),e=!1}),t.addEventListener("wheel",i=>{e&&Math.abs(i.deltaY)>0&&(i.preventDefault(),t.scrollBy({left:i.deltaY,behavior:"auto"}))},{passive:!1})})}initQuantitySelectors(){document.querySelectorAll(".quantity-selector").forEach(t=>{const e=t.querySelector(".minus"),i=t.querySelector(".plus"),n=t.querySelector(".qty-value");if(e&&i&&n){e.replaceWith(e.cloneNode(!0)),i.replaceWith(i.cloneNode(!0));const o=t.querySelector(".minus"),s=t.querySelector(".plus");o.addEventListener("click",()=>{const t=parseInt(n.textContent)||1;t>1&&(n.textContent=t-1)}),s.addEventListener("click",()=>{const t=parseInt(n.textContent)||1;t<999&&(n.textContent=t+1)})}})}initCustomSelectors(){this.syncSelectsWithSnipcart()}syncSelectsWithSnipcart(){const t=t=>{const e=t.dataset.target,{customIndex:i}=t.dataset,n=document.querySelector(`.snipcart-add-item[data-item-id="${e}"]`);n&&i&&n.setAttribute(`data-item-custom${i}-value`,t.value)};document.querySelectorAll("select[data-target][data-custom-index]").forEach(e=>{e.addEventListener("change",()=>t(e)),t(e)})}initSnipcartButtons(){document.querySelectorAll(".snipcart-add-item").forEach(t=>{t.addEventListener("click",()=>{this.playSound("media/sounds/coin-drop.mp3",.5)})})}playSound(t,e=.5){try{const i=new Audio(t);i.volume=Math.max(0,Math.min(1,e)),i.play().catch(t=>{console.debug("Audio autoplay bloqué:",t)})}catch(t){console.debug("Erreur lecture audio:",t)}}initAsyncStock(){window.asyncStockLoader&&window.asyncStockLoader.initAutoLoad()}initTranslations(){window.i18n&&window.i18n.applyTranslations&&window.i18n.applyTranslations()}showErrorState(){["pieces","cartes","triptyques"].forEach(t=>{const e=document.querySelector(`#${t} .shop-grid`);e&&(e.innerHTML='\n                    <div class="col-span-full text-center py-8 text-gray-400">\n                        <div class="text-4xl mb-4">⚠️</div>\n                        <p>Erreur lors du chargement</p>\n                        <button onclick="window.boutiqueLoader.startLoading()"\n                                class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">\n                            Réessayer\n                        </button>\n                    </div>\n                ')})}}window.boutiqueLoader=new BoutiqueAsyncLoader;