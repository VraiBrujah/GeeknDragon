function fullyVisible(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)}(()=>{const t=(t,e=document)=>e.querySelector(t),e=(t,e=document)=>Array.from(e.querySelectorAll(t)),n=window.location.search.includes("debug=1")||window.location.hash.includes("debug"),i=Object.freeze({language:1,multiplier:2}),o=t=>"string"==typeof t?t.trim().toLowerCase():"",s=(t,e)=>{const n=o(e);if(!t||!n)return null;const i=Array.from(t.attributes||[]);for(const t of i){const e=/^data-item-custom(\d+)-role$/i.exec(t.name);if(!e)continue;if(o(t.value)!==n)continue;const i=parseInt(e[1],10);if(Number.isFinite(i)&&i>0)return i}return null},r=["fr","en"],a="fr",c=window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches,l=()=>{const e=t("header");return e?e.offsetHeight:0};window.whenSnipcart=t=>{if(window.Snipcart&&window.Snipcart.store&&window.Snipcart.api)return void t();const e=setInterval(()=>{window.Snipcart&&window.Snipcart.store&&window.Snipcart.api&&(clearInterval(e),t())},200)},window.GD=Object.assign(window.GD||{},{qs:t,qsa:e,log:(...t)=>{if(n)try{console.log("[GD]",...t)}catch(t){}},throttle:(t,e=100)=>{let n=0,i=null;return function(...o){const s=Date.now();s-n>=e?(n=s,t.apply(this,o)):i||(i=setTimeout(()=>{n=Date.now(),i=null,t.apply(this,o)},e-(s-n)))}},debounce:(t,e=120)=>{let n;return function(...i){clearTimeout(n),n=setTimeout(()=>t.apply(this,i),e)}},createEl:(t,e={},n=[])=>{const i=document.createElement(t);return Object.entries(e).forEach(([t,e])=>{"class"===t?i.className=e:"style"===t?Object.assign(i.style,e):null!=e&&i.setAttribute(t,e)}),[].concat(n).forEach(t=>{"string"==typeof t?i.appendChild(document.createTextNode(t)):t&&i.appendChild(t)}),i},getLang:()=>{const t=localStorage.getItem("lang"),e=(t=>{try{const e=document.cookie.match(new RegExp(`(?:^|; )${t}=([^;]+)`));return e?e[1]:null}catch(t){return null}})("lang"),n=document.documentElement.lang,i=(t||e||n||a).toLowerCase();return r.includes(i)?i:a},setLang:t=>{const e=r.includes(t)?t:a;return localStorage.setItem("lang",e),localStorage.setItem("snipcartLanguage",e),((t,e,n=31536e3)=>{try{document.cookie=`${t}=${e};path=/;max-age=${n}`}catch(t){}})("lang",e),document.documentElement.lang=e,e},smoothScrollTo:(t,e={})=>{const n=Math.max(0,t.getBoundingClientRect().top+window.pageYOffset-(e.offset??l()+12));c?window.scrollTo(0,n):window.scrollTo({top:n,behavior:"smooth"})},getHeaderOffset:l,focusTrap:t=>{let n=[],i=null,o=null;const s=t=>{"Tab"===t.key&&n.length&&(t.shiftKey&&document.activeElement===i?(t.preventDefault(),o.focus()):t.shiftKey||document.activeElement!==o||(t.preventDefault(),i.focus()))};return{mount(){n=e('a[href], button:not([disabled]), select, textarea, input, [tabindex]:not([tabindex="-1"])',t),[i]=n,o=n[n.length-1],t.addEventListener("keydown",s)},unmount(){t.removeEventListener("keydown",s)}}},customFields:{indexesByRole:i,normalizeRole:o,findIndexOnButton:s,resolveIndex:(t,{button:e=null,fallbackIndexes:n=[],position:r=0}={})=>{if(!t)return null;const a=parseInt(t.dataset?.customIndex??"",10);if(Number.isFinite(a)&&a>0)return a;const c=o((t.dataset?.itemCustomRole??t.dataset?.customRole)||"");if(c){const t=s(e,c);if(Number.isFinite(t)&&t>0)return t;const n=i[c];if(Number.isFinite(n)&&n>0)return n}if(Array.isArray(n)&&n.length>0){const t=n[r];if(Number.isFinite(t)&&t>0)return t;const e=n[n.length-1];if(Number.isFinite(e)&&e>0)return e}return null}}})})(),document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector("header");if(!t)return;const e=()=>{const e=t.getBoundingClientRect().height||96;document.documentElement.style.setProperty("--header-height",`${e}px`),document.documentElement.style.setProperty("--gd-header-h",`${e}px`)};e(),new ResizeObserver(e).observe(t),window.addEventListener("resize",e)}),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("lang-switcher");let e=window.GD.getLang();["fr","en"].includes(e)||(e="fr"),e=window.GD.setLang(e);var n,i;n=e,document.querySelectorAll(".flag-btn[data-lang]").forEach(t=>{t.dataset.lang===n?t.setAttribute("aria-current","true"):t.removeAttribute("aria-current")}),whenSnipcart(()=>window.Snipcart.api.session.setLanguage(e)),document.querySelectorAll(".flag-btn[data-lang]").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.lang;window.GD.setLang(e);let n=window.location.pathname;if("fr"!==e){const t=new URLSearchParams(window.location.search);t.set("lang",e),n+="?"+t.toString()}window.location.hash&&(n+=window.location.hash),window.location.href=n})}),i=e,fetch(`/lang/${i}.json`).then(t=>t.ok?t.json():null).then(t=>{if(!t)return;window.i18n=t,document.querySelectorAll("[data-i18n]").forEach(e=>{const n=e.dataset.i18n.split(".");let i=t;n.forEach(t=>{i&&(i=i[t])}),null!=i&&(e.innerHTML=i)}),document.querySelectorAll("[data-name-fr]").forEach(t=>{const e="en"===i?t.dataset.nameEn:t.dataset.nameFr;e&&(t.innerHTML=e)}),document.querySelectorAll("[data-desc-fr]").forEach(t=>{}),document.querySelectorAll("[data-alt-fr]").forEach(t=>{const e="en"===i?t.dataset.altEn:t.dataset.altFr;e&&t.setAttribute("alt",e)});const e=/(multiplicat(eur|or)|multiplier)/i,n=window.GD?.customFields||{},o="function"==typeof n.findIndexOnButton?n.findIndexOnButton:()=>null;document.querySelectorAll(".snipcart-add-item").forEach(n=>{"en"===i?(n.dataset.itemNameEn&&n.setAttribute("data-item-name",n.dataset.itemNameEn),n.dataset.itemDescriptionEn&&(n.dataset.itemDescription=n.dataset.itemDescriptionEn,n.setAttribute("data-item-description",n.dataset.itemDescriptionEn))):(n.dataset.itemNameFr&&n.setAttribute("data-item-name",n.dataset.itemNameFr),n.dataset.itemDescriptionFr&&(n.dataset.itemDescription=n.dataset.itemDescriptionFr,n.setAttribute("data-item-description",n.dataset.itemDescriptionFr)));const s=o(n,"multiplier"),r=(()=>{const t=Number.parseInt(s,10);return Number.isFinite(t)&&t>0?t:null})();if(null!==r&&n.hasAttribute(`data-item-custom${r}-name`)&&t?.product?.multiplier){const i=n.getAttribute(`data-item-custom${r}-name`)||"",o=n.dataset[`itemCustom${r}Role`]||"",s=o&&"multiplier"===o.toLowerCase()||n.hasAttribute("data-multiplier-label")||n.dataset.multiplierLabel&&["1","true","yes","oui"].includes(n.dataset.multiplierLabel.toLowerCase()),a=e.test(i);(s||a)&&n.setAttribute(`data-item-custom${r}-name`,t.product.multiplier)}}),document.querySelectorAll('[data-role^="multiplier-"]').forEach(t=>{const{role:e}=t.dataset,n=e?.split("-")[1];n&&t.closest(".multiplier-wrapper")?.classList.toggle("hidden",n!==i)}),"function"==typeof window.updatePlus&&document.querySelectorAll(".btn-shop[data-item-id]").forEach(t=>{window.updatePlus(t.dataset.itemId)})}).catch(()=>{t&&t.classList.add("hidden")})}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".fade-up").forEach(t=>{new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&t.target.classList.add("animate")})},{threshold:.1}).observe(t)}),document.body.addEventListener("click",t=>{const e=t.target.closest('a[href^="#"]:not([href="#"])');if(!e)return;const n=e.getAttribute("href").slice(1),i=document.getElementById(n);i&&(t.preventDefault(),window.GD.smoothScrollTo(i),e.matches("nav .nav-link")&&(document.querySelectorAll("nav .nav-link.is-active").forEach(t=>t.classList.remove("is-active")),e.classList.add("is-active")))},{passive:!1})}),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("menu-btn"),e=document.getElementById("mobile-menu"),n=document.getElementById("menu-overlay"),i=document.getElementById("menu-close");if(!t||!e||!n)return;const o=window.GD.focusTrap(e),s=()=>{e.classList.add("translate-x-full"),e.classList.remove("translate-x-0"),n.classList.remove("opacity-100"),n.classList.add("opacity-0"),n.addEventListener("transitionend",()=>n.classList.add("hidden"),{once:!0}),e.addEventListener("transitionend",()=>{e.classList.add("hidden")},{once:!0}),t.setAttribute("aria-expanded","false"),e.setAttribute("aria-hidden","true"),o.unmount(),t.focus()};t.addEventListener("click",()=>{"true"===t.getAttribute("aria-expanded")?s():(()=>{e.classList.remove("hidden"),n.classList.remove("hidden"),requestAnimationFrame(()=>{e.classList.remove("translate-x-full"),e.classList.add("translate-x-0"),n.classList.remove("opacity-0"),n.classList.add("opacity-100")}),t.setAttribute("aria-expanded","true"),e.setAttribute("aria-hidden","false"),o.mount();const i=e.querySelector("a,button");i&&i.focus()})()}),e.querySelectorAll("a").forEach(t=>t.addEventListener("click",s)),n.addEventListener("click",s),i&&i.addEventListener("click",s),document.addEventListener("keydown",e=>{"Escape"===e.key&&"true"===t.getAttribute("aria-expanded")&&s()})}),document.addEventListener("DOMContentLoaded",()=>{const t=t=>{document.querySelectorAll('nav .nav-link.is-active, nav .nav-link[aria-current="page"]').forEach(t=>{t.classList.remove("is-active"),t.removeAttribute("aria-current")}),t&&(t.classList.add("is-active"),t.setAttribute("aria-current","page"))};document.querySelectorAll("nav .nav-link").forEach(e=>{e.addEventListener("click",n=>{n.metaKey||n.ctrlKey||n.shiftKey||n.altKey||t(e)})});const e=new Map;if(document.querySelectorAll('nav .nav-link[href*="#"]').forEach(t=>{const n=t.getAttribute("href").split("#")[1],i=n&&document.getElementById(n);i&&e.set(i,t)}),e.size){const n=new IntersectionObserver(n=>{let i=null;for(const t of n)t.isIntersecting&&(!i||t.intersectionRatio>i.intersectionRatio)&&(i=t);i&&t(e.get(i.target))},{rootMargin:"0px 0px -55% 0px",threshold:[.25,.5,.75]});e.forEach((t,e)=>n.observe(e))}document.querySelectorAll("nav .relative.group").forEach(t=>{const e=t.querySelector("ul");e&&(t.addEventListener("focusin",()=>e.classList.remove("hidden")),t.addEventListener("focusout",n=>{t.contains(n.relatedTarget)||e.classList.add("hidden")}))})}),document.addEventListener("DOMContentLoaded",()=>{const t=["video1","video2","video3"].map(t=>document.getElementById(t)).filter(Boolean).filter(t=>!t.closest(".hero-videos"));let e,n=0,i=!1;t.forEach(t=>{if(t.closest(".hero-videos"))return void console.log("[GD] Skipping hero video from app.js management:",t);t.dataset.userPaused="false",t.dataset.autoPaused="false";const e=()=>t.classList.add("scale-105","z-10"),n=()=>t.classList.remove("scale-105","z-10");t.addEventListener("play",()=>{e(),t.dataset.userPaused="false",t.dataset.autoPaused="false"}),t.addEventListener("playing",e),t.addEventListener("pause",()=>{n(),"true"===t.dataset.autopausing?t.dataset.autopausing="false":t.dataset.userPaused="true"}),t.addEventListener("ended",n)});const o=new IntersectionObserver(t=>{t.forEach(t=>{const e=t.target;e.closest('[data-managed-by="hero-videos"]')||(t.isIntersecting?"true"===e.dataset.autoPaused&&"true"!==e.dataset.userPaused&&(e.play(),e.dataset.autoPaused="false"):e.paused||(e.dataset.autopausing="true",e.dataset.autoPaused="true",e.pause(),e.classList.remove("scale-105","z-10")))})},{threshold:.2});function s(t){const e=document.querySelector(`.mute-btn[data-video="${t.id}"]`);e&&(e.textContent=t.muted?"üîá":"üîä")}t.forEach(t=>{t.closest('[data-managed-by="hero-videos"]')||t.closest(".hero-videos")||o.observe(t)});const r=()=>{if(i)return;i=!0;const e=t[n];e&&!e.paused&&(e.muted=!1,s(e))};function a(o){o.muted=!i,o.currentTime=0,o.play().then(()=>{i&&(o.muted=!1),s(o)}).catch(()=>{o.muted=!0,o.play(),s(o)}),o.onended=()=>{n+=1,n<t.length&&e(n)}}["click","touchstart","keydown","wheel"].forEach(t=>window.addEventListener(t,r,{once:!0,passive:!0})),document.querySelectorAll(".mute-btn").forEach(e=>{const n=t.find(t=>t.id===e.dataset.video);n&&e.addEventListener("click",t=>{t.stopPropagation(),n.muted=!n.muted,s(n)})}),e=e=>{const n=t[e];if(!n)return;t.forEach((t,n)=>{n!==e&&(t.pause(),t.currentTime=0)});const i=new IntersectionObserver(t=>{t[0].isIntersecting&&fullyVisible(n)&&(i.disconnect(),a(n))},{threshold:1});i.observe(n)},t.forEach((t,e)=>{t.addEventListener("click",()=>{t.paused?(i||r(),n=e,a(t)):t.pause()})}),t.length&&e(n)}),document.addEventListener("DOMContentLoaded",()=>{const t=window.stock||{},e=t=>{const e=Number.parseInt(t,10);return Number.isFinite(e)&&e>0?e:null},n=window.GD?.customFields||{},i="function"==typeof n.resolveIndex?n.resolveIndex:null,o=e=>{const n=t[e],i=parseInt(document.getElementById(`qty-${e}`)?.textContent||"1",10),o=document.querySelector(`.quantity-btn.plus[data-target="${e}"]`),s=document.querySelector(`.btn-shop[data-item-id="${e}"]`),r=null!=n&&(n<=0||i>=n),a=void 0!==s?.dataset.hidePrice,c=s?parseFloat(s.dataset.itemPrice||"0"):0,l=window.i18n?.product||{},u=l.add||"Ajouter",d=l.insufficientStock||"Stock insuffisant";if(o){const t=i+1;o.disabled=null!=n&&(n<=0||t>n),o.title=o.disabled?d:""}if(s){const t=s.querySelector('[data-i18n="product.add"]');let e=s.querySelector(".price-text");e||(e=document.createElement("span"),e.className="price-text",s.append(" ",e)),s.disabled=r,s.title=r?d:"",t&&(t.textContent=r?d:u),e.textContent=r||a||!c?"":`‚Äî ${c*i} $`}};window.updatePlus=o,document.querySelectorAll(".quantity-btn").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.target,i=document.getElementById(`qty-${n}`);if(!i)return;let s=parseInt(i.textContent,10)||1;const r=t[n];e.classList.contains("minus")?s=Math.max(1,s-1):(null==r||s+1<=r)&&(s+=1),i.textContent=s;const a=document.querySelector(`.btn-shop[data-item-id="${n}"]`);a&&a.setAttribute("data-item-quantity",String(s)),o(n)})}),document.querySelectorAll(".quantity-selector").forEach(t=>{o(t.dataset.id)}),document.querySelectorAll(".btn-shop[data-item-id]").forEach(t=>{const e=t.dataset.itemId;document.querySelector(`.quantity-selector[data-id="${e}"]`)||o(e)});const s=(t,{onUpdate:n}={})=>{document.querySelectorAll(t).forEach(t=>{const s=t.dataset.target;if(!s)return;const r=document.querySelector(`.btn-shop[data-item-id="${s}"]`),a=i?i(t,{button:r}):null;let c=e(a);c||(c=e(t.dataset.customIndex)??1),t.dataset.customIndex=String(c);const l=()=>{const e=parseInt(document.getElementById(`qty-${s}`)?.textContent||"1",10);r&&(r.setAttribute(`data-item-custom${c}-value`,t.value),r.setAttribute("data-item-quantity",String(e)),"function"==typeof n&&n({id:s,addBtn:r,select:t,value:t.value,index:c})),o(s)};l(),t.addEventListener("change",l)})};s(".multiplier-select",{onUpdate:({addBtn:t})=>{const e="en"===document.documentElement.lang?"itemNameEn":"itemNameFr",n=t.dataset.gdBaseName||t.getAttribute("data-item-name")||"";!t.dataset.gdBaseName&&n&&(t.dataset.gdBaseName=n);const i=t.dataset[e]||t.dataset.gdBaseName||n;i&&t.setAttribute("data-item-name",i)}}),s(".language-select"),s(".triptych-select"),document.querySelectorAll(".swiper").forEach(t=>{if(t.classList.contains("swiper-thumbs"))return;const e=t.parentElement.querySelector(".swiper-thumbs");if(e){const n=new Swiper(e,{slidesPerView:4,freeMode:!0,watchSlidesProgress:!0});new Swiper(t,{loop:!0,autoplay:{delay:5e3},navigation:{nextEl:t.querySelector(".swiper-button-next"),prevEl:t.querySelector(".swiper-button-prev")},thumbs:{swiper:n}})}else new Swiper(t,{loop:!0,autoplay:{delay:5e3},navigation:{nextEl:t.querySelector(".swiper-button-next"),prevEl:t.querySelector(".swiper-button-prev")}})}),window.Fancybox&&Fancybox.bind("[data-fancybox]",{backdrop:"blur",dragToClose:!0,closeButton:"top",placeFocusBack:!0,on:{close:()=>window.history.back()}})}),document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelectorAll(".snipcart-checkout"),e=document.querySelectorAll(".snipcart-customer-signin"),n=()=>"visible"===window.Snipcart?.store?.getState()?.cart?.status,i=()=>"visible"===window.Snipcart?.store?.getState()?.customer?.status;t.forEach(t=>t.addEventListener("click",t=>{window.Snipcart?.store&&window.Snipcart?.api?.theme&&n()&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),window.Snipcart.api.theme.cart.close(),t.currentTarget.blur())})),e.forEach(t=>t.addEventListener("click",t=>{window.Snipcart?.store&&window.Snipcart?.api?.theme&&i()&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),window.Snipcart.api.theme.customer.close(),t.currentTarget.blur())}));const o=()=>{const o=n(),s=i();t.forEach(t=>t.classList.toggle("is-active",o)),e.forEach(t=>t.classList.toggle("is-active",s))};window.addEventListener("snipcart.ready",o),window.addEventListener("snipcart.opened",o),window.addEventListener("snipcart.closed",o);!function t(){window.Snipcart&&window.Snipcart.store?(()=>{try{const{store:t}=window.Snipcart;t&&t.subscribe(()=>o())}catch(t){}})():setTimeout(t,300)}()}),document.addEventListener("DOMContentLoaded",()=>{if(!("loading"in HTMLImageElement.prototype)){const t=document.querySelectorAll('img[loading="lazy"]');if(!t.length)return;const e=new IntersectionObserver((t,e)=>{t.forEach(t=>{if(!t.isIntersecting)return;const n=t.target,{src:i}=n.dataset,{srcset:o}=n.dataset;i&&(n.src=i),o&&(n.srcset=o),e.unobserve(n)})},{rootMargin:"100px 0px"});t.forEach(t=>e.observe(t))}}),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("back-to-top");if(t){t.addEventListener("click",t=>{t.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})});const e=throttle(()=>{t.classList.toggle("opacity-0",window.pageYOffset<500),t.classList.toggle("pointer-events-none",window.pageYOffset<500)},100);window.addEventListener("scroll",e,{passive:!0}),e()}document.querySelectorAll("[data-collapse]").forEach(t=>{const e=document.querySelector(t.dataset.collapse);if(!e)return;t.setAttribute("aria-expanded","false"),e.hidden=!0;const n=()=>{e.hidden=!1,t.setAttribute("aria-expanded","true"),e.style.height="auto";const n=`${e.clientHeight}px`;e.style.height="0px",requestAnimationFrame(()=>{e.style.height=n}),e.addEventListener("transitionend",()=>{e.style.height="auto"},{once:!0})},i=()=>{t.setAttribute("aria-expanded","false"),e.style.height=`${e.clientHeight}px`,requestAnimationFrame(()=>{e.style.height="0px"}),e.addEventListener("transitionend",()=>{e.hidden=!0,e.style.height=""},{once:!0})};t.addEventListener("click",e=>{e.preventDefault(),("true"===t.getAttribute("aria-expanded")?i:n)()})})}),document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector("header");if(!t)return;const e=((t,e=80)=>{let n=0;return()=>{const i=Date.now();i-n>e&&(n=i,t())}})(()=>{t.classList.toggle("shadow-2xl",window.pageYOffset>8),t.classList.toggle("backdrop-blur-md",window.pageYOffset>8)});window.addEventListener("scroll",e,{passive:!0}),e()}),(()=>{const t=window.GD?.customFields||{},e="function"==typeof t.resolveIndex?t.resolveIndex:null,n=()=>{!0!==window.__snipcartQtyPatch&&(document.addEventListener("click",t=>{const n=t.target.closest(".snipcart-add-item");if(!n)return;const i=n.getAttribute("data-item-id")||n.dataset.itemId;if(!i)return;const o=document.getElementById(`qty-${i}`);if(o){const t=parseInt(o.textContent,10);!Number.isNaN(t)&&t>0&&n.setAttribute("data-item-quantity",String(t))}const s=Array.from(document.querySelectorAll("select[data-target]")).filter(t=>t.dataset.target===i);if(s.length){const t=(t=>{const e=[];return Array.from(t.attributes).forEach(t=>{const n=/^data-item-custom(\d+)-/i.exec(t.name);if(!n)return;const i=parseInt(n[1],10);Number.isFinite(i)&&e.push(i)}),e.sort((t,e)=>t-e)})(n),i=n.getAttribute("data-item-name")||"",o=n.dataset.itemNameFr||i,r=n.dataset.itemNameEn||i;s.forEach((s,a)=>{let c=null;if(e&&(c=e(s,{button:n,fallbackIndexes:t,position:a})),!Number.isFinite(c)||c<=0){c=(t=>{const e=parseInt(t,10);return Number.isFinite(e)&&e>0?e:null})(s.dataset.customIndex||"")??t[a]??t[t.length-1]??a+1}s.dataset.customIndex=String(c);const l=null==s.value?"":`${s.value}`;let u=l;if(s.classList.contains("multiplier-select")){const t=l&&""!==`${l}`.trim()?`${l}`:"1";u=t,o&&!n.dataset.gdBaseNameFr&&(n.dataset.gdBaseNameFr=o),r&&!n.dataset.gdBaseNameEn&&(n.dataset.gdBaseNameEn=r);const e=("en"===("en"===document.documentElement.lang?"en":"fr")?n.dataset.gdBaseNameEn||r:n.dataset.gdBaseNameFr||o)||n.dataset.gdBaseName||i||n.getAttribute("data-item-name")||"";e&&(n.dataset.gdBaseName||(n.dataset.gdBaseName=e),n.setAttribute("data-item-name",e)),n.dataset.gdMultiplier=t}n.setAttribute(`data-item-custom${c}-value`,u)})}},{passive:!0}),window.__snipcartQtyPatch=!0)};window.__ensureSnipcartQtyPatch=n;document.addEventListener("DOMContentLoaded",()=>{const t=t=>{const e=t.dataset.target,n=t.dataset.customIndex,i=document.querySelector(`.snipcart-add-item[data-item-id="${e}"]`);i&&n&&i.setAttribute(`data-item-custom${n}-value`,t.value)};document.querySelectorAll("select[data-target][data-custom-index]").forEach(e=>{e.addEventListener("change",()=>t(e)),t(e)}),document.querySelectorAll(".snipcart-add-item").forEach(e=>{e.addEventListener("click",n=>{const i=e.dataset.itemId||e.getAttribute("data-item-id");document.querySelectorAll(`select[data-target="${i}"]`).forEach(e=>t(e))})})}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()})(),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("snipcart")});const toggleSnipcartScroll=()=>{const t=document.getElementById("snipcart"),e=!!t?.querySelector(".snipcart-order"),n="visible"===window.Snipcart?.store?.getState()?.cart?.status;document.body.classList.toggle("snipcart-open",n&&!e)};window.addEventListener("snipcart.opened",toggleSnipcartScroll),window.addEventListener("snipcart.closed",toggleSnipcartScroll),window.addEventListener("snipcart.ready",()=>{const t=document.getElementById("snipcart");t&&new MutationObserver(toggleSnipcartScroll).observe(t,{childList:!0,subtree:!0}),toggleSnipcartScroll()}),document.addEventListener("DOMContentLoaded",()=>{const t=()=>{const t=document.documentElement.getAttribute("data-cmp-status"),e="#debug"===window.location.hash||window.location.search.includes("debug=1");"error"===t?console.warn("[GD] CMP: Erreur de chargement - Mode d√©grad√© activ√©"):"timeout"===t&&e&&console.warn("[GD] CMP: Timeout - Fonctionnement en mode essentiel (debug)")};document.addEventListener("cmpConsentUpdate",t=>{const e=t.detail?.purposes||{};e.analytics,e.marketing,document.dispatchEvent(new CustomEvent("gdConsentUpdate",{detail:{purposes:e,timestamp:Date.now()}}))}),t(),["snipcart_*","PHPSESSID","lang_preference","cart_session"].forEach(t=>{document.documentElement.setAttribute(`data-cookie-essential-${t.replace("*","all")}`,"true")});const e=setInterval(()=>{const n=document.documentElement.getAttribute("data-cmp-status");n&&"unknown"!==n&&(clearInterval(e),t())},500);setTimeout(()=>clearInterval(e),1e4)}),(()=>{function t(t=".hero-text h1",e=50,n=500){const i=document.querySelector(t);if(i&&!i.dataset.typed){const t=i.textContent.trim();i.textContent="",i.dataset.typed="true",i.hasAttribute("data-i18n")&&(i.dataset.originalI18n=i.getAttribute("data-i18n"),i.removeAttribute("data-i18n"));let o=0;const s=()=>{o<t.length&&(i.textContent+=t.charAt(o),o++,setTimeout(s,e))};setTimeout(s,n)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>t()):t(),document.addEventListener("languageChanged",()=>{const e=document.querySelector(".hero-text h1");e&&(e.dataset.typed=!1,e.dataset.originalI18n&&e.setAttribute("data-i18n",e.dataset.originalI18n),setTimeout(()=>t(),100))}),window.initTypewriterTitle=t})(),(()=>{class t{constructor(){this.nav=document.querySelector(".shop-quick-links"),this.hero=document.querySelector("section.min-h-screen"),this.links=this.nav?Array.from(this.nav.querySelectorAll('a[href^="#"]')):[],this.sections=[],this.isSticky=!1,this.scrollThreshold=0,this.nav&&this.hero&&this.init()}init(){this.updateScrollThreshold(),this.links.forEach(t=>{const e=t.getAttribute("href").substring(1),n=document.getElementById(e);n&&this.sections.push({id:e,element:n,link:t})}),window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),window.addEventListener("resize",this.debounce(()=>this.updateScrollThreshold(),200)),this.links.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("href").substring(1),i=document.getElementById(n);if(i){const t=i.offsetTop-(this.isSticky?this.nav.offsetHeight+parseInt(getComputedStyle(document.documentElement).getPropertyValue("--header-height")||"0"):0);window.scrollTo({top:t,behavior:"smooth"})}})}),this.handleScroll()}updateScrollThreshold(){this.hero&&(this.scrollThreshold=this.hero.offsetHeight-100)}handleScroll(){const t=window.scrollY||window.pageYOffset;t>this.scrollThreshold&&!this.isSticky?(this.nav.classList.add("sticky-active"),this.isSticky=!0):t<=this.scrollThreshold&&this.isSticky&&(this.nav.classList.remove("sticky-active"),this.isSticky=!1),this.isSticky&&this.updateActiveSection(t)}updateActiveSection(t){let e=null;const n=this.nav.offsetHeight+parseInt(getComputedStyle(document.documentElement).getPropertyValue("--header-height")||"0")+50;for(let i=this.sections.length-1;i>=0;i--){const o=this.sections[i];if(t>=o.element.offsetTop-n){e=o;break}}this.links.forEach(t=>t.classList.remove("active")),e&&e.link.classList.add("active")}debounce(t,e){let n;return function(...i){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),t(...i)},e)}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>new t):new t})();class CurrencyConverterPremium{constructor(){this.rates={copper:1,silver:10,electrum:50,gold:100,platinum:1e3},this.multipliers=[1,10,100,1e3,1e4],this.nf=new Intl.NumberFormat("fr-FR"),this.editMode=!0,this.productPrices={single:10,trio:25,septuple:50},this.sourceInputs=null,this.multiplierInputs=null,this.bestDisplay=null,this.metalCards={},this.currencyData={copper:{name:"Cuivre",nameEn:"Copper",emoji:"ü™ô",color:"amber"},silver:{name:"Argent",nameEn:"Silver",emoji:"ü•à",color:"gray"},electrum:{name:"√âlectrum",nameEn:"Electrum",emoji:"‚ö°",color:"yellow"},gold:{name:"Or",nameEn:"Gold",emoji:"ü•á",color:"yellow"},platinum:{name:"Platine",nameEn:"Platinum",emoji:"üíé",color:"cyan"}},this.changeCallbacks=[],this.init()}init(){this.loadProductPrices(),this.addTranslationSupport(),this.refreshDOMReferences(),this.setupEventListeners(),this.updateDisplay(),this.displayDefaultRecommendationMessage()}async loadProductPrices(){try{window.products&&(this.productPrices.single=window.products["coin-custom-single"]?.price||10,this.productPrices.trio=window.products["coin-trio-customizable"]?.price||25,this.productPrices.septuple=window.products["coin-septuple-free"]?.price||50)}catch(t){console.warn("Impossible de charger les prix dynamiques, utilisation des prix par d√©faut")}}refreshDOMReferences(){const t=document.getElementById("currency-converter-premium");t&&(this.sourceInputs=t.querySelectorAll("input[data-currency]"),this.multiplierInputs=t.querySelectorAll(".multiplier-input"),this.bestDisplay=document.getElementById("currency-best"),Object.keys(this.currencyData).forEach(t=>{const e=document.getElementById(`${t}-card`);e&&(this.metalCards[t]=e)}))}onChange(t){"function"==typeof t&&this.changeCallbacks.push(t)}notifyChange(t){this.changeCallbacks.forEach(e=>{try{e(t)}catch(t){console.warn("Erreur dans callback du convertisseur:",t)}})}getCurrentLang(){return document.documentElement.lang||"fr"}getTranslation(t,e=""){if(window.i18n){const n=t.split(".");let i=window.i18n;for(const t of n){if(!i||"object"!=typeof i||!(t in i))return e;i=i[t]}return"string"==typeof i?i:e}return e}getCurrencyName(t){const e=this.getCurrentLang(),n=this.currencyData[t];return"en"===e?n.nameEn:n.name}setupEventListeners(){const t=document.getElementById("currency-converter-premium");if(!t)return void console.warn("Container currency-converter-premium non trouv√©");const e=(t,e)=>{let n;return(...i)=>{clearTimeout(n),n=setTimeout(()=>t.apply(this,i),e)}},n=e(()=>{this.updateFromSources(),this.notifyChange(this.getCurrentValues())},150),i=e(()=>{this.updateFromMultipliers(),this.notifyChange(this.getCurrentValues())},150);t.addEventListener("input",t=>{t.target.matches("input[data-currency]")?(t.target.value=t.target.value.replace(/[^0-9]/g,""),n()):t.target.matches(".multiplier-input")&&(t.target.value=t.target.value.replace(/[^0-9]/g,""),i())},{passive:!0}),t.addEventListener("focus",t=>{t.target.matches("input[data-currency]")&&"0"===t.target.value&&(t.target.value="")},{passive:!0})}getCurrentValues(){this.sourceInputs||this.refreshDOMReferences();const t={copper:0,silver:0,electrum:0,gold:0,platinum:0},e=this.getTotalBaseValue();return this.sourceInputs&&this.sourceInputs.forEach(e=>{const{currency:n}=e.dataset,i=Math.max(0,parseInt(e.value)||0);t[n]=i}),{values:t,baseValue:e,breakdown:this.getOptimalBreakdown(e)}}getTotalBaseValue(){return this.sourceInputs||this.refreshDOMReferences(),this.sourceInputs&&0!==this.sourceInputs.length?Array.from(this.sourceInputs).reduce((t,e)=>{const{currency:n}=e.dataset;return t+Math.max(0,parseInt(e.value)||0)*this.rates[n]},0):0}updateFromSources(){const t=this.getTotalBaseValue();this.updateMultiplierTableWithOptimization(t),this.updateMetalCards(t),this.updateOptimalRecommendations(t),this.updateCoinLotsRecommendations(t)}updateFromMultipliers(){let t=0;this.multiplierInputs.forEach(e=>{const{currency:n}=e.closest("tr").dataset,i=parseInt(e.dataset.multiplier),o=parseInt(e.value.replace(/\s/g,""))||0;t+=o*this.rates[n]*i}),this.sourceInputs.forEach(t=>{t.value="0"}),this.distributeOptimally(t),this.updateMetalCards(t),this.updateOptimalRecommendationsFromUser(t),this.updateCoinLotsRecommendations(t,!0)}updateMultiplierTableWithOptimization(t){if(0===t)return void this.multiplierInputs.forEach(t=>{t.value=""});const e=this.findMinimalCoins(t,!1);this.multiplierInputs.forEach(t=>{t.value=""}),e.forEach(t=>{const e=Array.from(this.multiplierInputs).find(e=>{const{currency:n}=e.closest("tr").dataset,i=parseInt(e.dataset.multiplier);return n===t.currency&&i===t.multiplier});e&&t.quantity>0&&(e.value=this.nf.format(t.quantity))})}distributeOptimally(t){let e=t;["platinum","gold","electrum","silver","copper"].forEach(t=>{const n=document.querySelector(`input[data-currency="${t}"]`),i=this.rates[t],o=Math.floor(e/i);o>0&&(n.value=o.toString(),e-=o*i)})}updateMetalCards(t){0!==t?Object.keys(this.rates).forEach(e=>{if(!this.metalCards[e])return;const n=this.currencyData[e],i=this.rates[e],o=Math.floor(t/i);if(0===o)return void(this.metalCards[e].innerHTML="");const s=this.getMinimalCoinsBreakdown(o),r=t%i;let a="";r>0&&(a=this.getOptimalBreakdown(r)),this.metalCards[e].innerHTML=`\n        <div class="currency-total-card bg-gradient-to-br from-${n.color}-900/20 to-${n.color}-800/20 rounded-xl p-6 border border-${n.color}-700/30">\n          <div class="flex items-center justify-between mb-4">\n            <h6 class="text-${n.color}-300 font-bold text-lg">${n.emoji} ${this.getCurrencyName(e)}</h6>\n            <span class="text-2xl font-bold text-${n.color}-300">${this.nf.format(o)}</span>\n          </div>\n          \n          <div class="space-y-2 mb-4">\n            <div class="text-sm">\n              <span class="text-gray-300">${this.getTranslation("shop.converter.minimalCoins","Nombre minimal de pi√®ces")}:</span>\n            </div>\n            ${s.map(t=>`\n              <div class="flex justify-between text-sm pl-2">\n                <span class="text-gray-300">${1===t.multiplier?this.getTranslation("shop.converter.units","Unit√©s"):`Multiplicateur √ó${this.nf.format(t.multiplier)}`}:</span>\n                <span class="text-${n.color}-300 font-medium">${this.nf.format(t.quantity)}</span>\n              </div>\n            `).join("")}\n            <div class="border-t border-${n.color}-700/30 pt-2 mt-3">\n              <div class="flex justify-between text-sm">\n                <span class="text-gray-300">${this.getTranslation("shop.converter.totalCoins","Total pi√®ces")}:</span>\n                <span class="text-${n.color}-300 font-bold">${this.nf.format(s.reduce((t,e)=>t+e.quantity,0))}</span>\n              </div>\n            </div>\n          </div>\n          \n          ${a?`\n            <div class="border-t border-${n.color}-700/30 pt-3">\n              <p class="text-xs text-gray-400">${this.getTranslation("shop.converter.remainder","Reste")}: ${a}</p>\n            </div>\n          `:""}\n        </div>\n      `}):Object.keys(this.metalCards).forEach(t=>{this.metalCards[t]&&(this.metalCards[t].innerHTML="")})}getMinimalCoinsBreakdown(t){const e=[];let n=t;return this.multipliers.slice().reverse().forEach(t=>{const i=Math.floor(n/t);i>0&&(e.push({multiplier:t,quantity:i}),n-=i*t)}),e}getOptimalBreakdown(t){if(t<=0)return"";const e=this.findMinimalCoins(t,!1);return e&&0!==e.length?this.formatSolutionForDisplay(e):""}findMinimalCoins(t,e=!1){let n=null,i=1/0;const o=this.findMetalPrioritySolution(t,e);if(o&&o.length>0){const t=this.calculateSolutionCost(o);t<i&&(i=t,n=o)}const s=this.findCostOptimalSolution(t,e);if(s&&s.length>0){const t=this.calculateSolutionCost(s);t<i&&(i=t,n=s)}if(!n){const e=this.findFallbackSolution(t);e&&e.length>0&&(n=e)}return n}findCostOptimalSolution(t,e=!1){const n=this.convertValueToCoins(t,e);return this.applyBulkDiscounts(n)}findMetalPrioritySolution(t,e=!1){const n=[];let i=t;return e?this.getUserMultiplierBreakdown():(["platinum","gold","electrum","silver","copper"].forEach(t=>{if(i<=0)return;const e=this.rates[t];for(const o of this.multipliers){const s=e*o;if(i>=s){const e=Math.floor(i/s);if(e>0){const r=this.optimizeQuantityForBulk(e,t,o);n.push({currency:t,multiplier:o,quantity:r.quantity,value:s}),i-=r.totalValue;break}}}}),n)}applyBulkDiscounts(t){const e=[];return t.forEach(t=>{const{currency:n,multiplier:i,quantity:o}=t;if(o>=7){const n=Math.floor(o/7),i=o%7;if(n>0&&e.push({...t,quantity:n,lotType:"septuple",economyGained:n*(7*this.productPrices.single-this.productPrices.septuple)}),i>=3){const n=Math.floor(i/3),o=i%3;n>0&&e.push({...t,quantity:n,lotType:"trio",economyGained:n*(3*this.productPrices.single-this.productPrices.trio)}),o>0&&e.push({...t,quantity:o,lotType:"single"})}else i>0&&e.push({...t,quantity:i,lotType:"single"})}else if(o>=3){const n=Math.floor(o/3),i=o%3;e.push({...t,quantity:n,lotType:"trio",economyGained:n*(3*this.productPrices.single-this.productPrices.trio)}),i>0&&e.push({...t,quantity:i,lotType:"single"})}else e.push({...t,lotType:"single"})}),e}calculateSolutionCost(t){return t.reduce((t,e)=>{const{quantity:n,lotType:i}=e;switch(i){case"septuple":return t+n*this.productPrices.septuple;case"trio":return t+n*this.productPrices.trio;default:return t+n*this.productPrices.single}},0)}convertValueToCoins(t,e=!1){const n=[];let i=t;return["platinum","gold","electrum","silver","copper"].forEach(t=>{if(i<=0)return;const e=this.rates[t];for(const o of this.multipliers){const s=e*o;if(i>=s){const e=Math.floor(i/s);if(e>0){n.push({currency:t,multiplier:o,quantity:e,value:s}),i-=e*s;break}}}}),n}optimizeQuantityForBulk(t,e,n){const i=this.rates[e]*n;return t>=7||t>=3?{quantity:t,totalValue:t*i,hasBulkDiscount:!0}:{quantity:t,totalValue:t*i,hasBulkDiscount:!1}}addTranslationSupport(){if(window.i18n&&window.i18n.shop&&window.i18n.shop.converter){const{converter:t}=window.i18n.shop;t.cost||(t.cost="Co√ªt"),t.economy||(t.economy="√âconomie"),t.bulkDiscount||(t.bulkDiscount="Remise sur quantit√©"),t.lotType||(t.lotType="Type de lot")}}findFallbackSolution(t){const e=[];return["platinum","gold","electrum","silver","copper"].forEach(t=>{this.multipliers.forEach(n=>{e.push({currency:t,multiplier:n,value:this.rates[t]*n})})}),e.sort((t,e)=>e.value-t.value),this.greedyFallback(t,e)}greedyFallback(t,e){const n=[];let i=t;return e.forEach(t=>{if(i>=t.value){const e=Math.floor(i/t.value);e>0&&(n.push({...t,quantity:e}),i-=e*t.value)}}),n}balancedDistributionStrategy(t,e){const n=[];let i=t;for(const t of this.multipliers.slice().reverse()){const o=["platinum","gold","electrum","silver","copper"];for(const s of o){const o=e.find(e=>e.currency===s&&e.multiplier===t);o&&i>=o.value&&(n.push({...o,quantity:1}),i-=o.value)}}if(n.reduce((t,e)=>t+e.value*e.quantity,0)/t>=.9&&n.length>=20&&t>=5e4)return i>0&&e.forEach(t=>{if(i>=t.value){const e=Math.floor(i/t.value);if(e>0){const o=n.find(e=>e.currency===t.currency&&e.multiplier===t.multiplier);o?o.quantity+=e:n.push({...t,quantity:e}),i-=e*t.value}}}),n;if(t>=1e5){const n=[];let i=t;const o=["platinum","gold","electrum","silver","copper"];for(const t of o){const o=e.find(e=>e.currency===t&&1===e.multiplier);o&&i>=o.value&&(n.push({...o,quantity:1}),i-=o.value)}for(const t of[100,1e4]){let s=!1;for(const r of o){const o=e.find(e=>e.currency===r&&e.multiplier===t);o&&i>=o.value&&(n.push({...o,quantity:1}),i-=o.value,s=!0)}if(!s)break}return e.forEach(t=>{if(i>=t.value){const e=Math.floor(i/t.value);if(e>0){const o=n.find(e=>e.currency===t.currency&&e.multiplier===t.multiplier);o?o.quantity+=e:n.push({...t,quantity:e}),i-=e*t.value}}}),n}return null}calculateRemainderPieces(t){let e=0,n=t;return["platinum","gold","electrum","silver","copper"].forEach(t=>{const i=this.rates[t],o=Math.floor(n/i);o>0&&(e+=o,n-=o*i)}),e}getRemainderBreakdown(t){const e=[];let n=t;return["platinum","gold","electrum","silver"].forEach(t=>{const i=this.rates[t],o=Math.floor(n/i);if(o>0){const s=this.currencyData[t];e.push(`${o} ${s.emoji} ${this.getCurrencyName(t).toLowerCase()}`),n-=o*i}}),n>0&&e.push(`${n} ${this.currencyData.copper.emoji} ${this.getCurrencyName("copper").toLowerCase()}`),e.join(", ")}updateOptimalRecommendations(t){if(this.bestDisplay||this.refreshDOMReferences(),!this.bestDisplay)return;if(0===t){const t=this.getTranslation("shop.converter.enterAmounts","Entrez des montants pour voir les recommandations optimales");return void(this.bestDisplay.innerHTML=t)}const e=this.findMinimalCoins(t,!1),n=this.formatSolutionForDisplay(e),i=this.calculateTotalPiecesFromSolution(e),o=this.calculateSolutionCost(e),s=this.calculateEconomyGained(e),r=Math.floor(t/this.rates.gold),a=t%this.rates.gold;let c="";if(r>0){if(c=`${this.nf.format(r)} ü•á ${this.getCurrencyName("gold").toLowerCase()}`,a>0){const t=this.getOptimalBreakdown(a);c+=` ${this.getTranslation("shop.converter.and","et")} ${t}`}}else c=this.getOptimalBreakdown(t);const l=this.getTranslation("shop.converter.optimalConversion","Conversion optimale"),u=this.getTranslation("shop.converter.total","Total"),d=this.getTranslation("shop.converter.cost","Co√ªt"),m=this.getTranslation("shop.converter.economy","√âconomie"),p=this.getTranslation("shop.converter.value","Valeur");let h="";s>0&&(h=`<p class="text-sm text-green-400">üí∞ ${m}: $${s.toFixed(2)}</p>`),this.bestDisplay.innerHTML=`\n      <div class="text-center">\n        <p class="text-lg mb-2"><strong>${l}:</strong> üéØ</p>\n        <p class="text-indigo-300 font-medium mb-2">${n}</p>\n        <p class="text-sm text-gray-400">${u}: ${this.nf.format(i)} ${this.getTranslation("shop.converter.coins","pi√®ces")}</p>\n        <p class="text-sm text-gray-400">${d}: $${o.toFixed(2)}</p>\n        ${h}\n        <p class="text-sm text-gray-400"><br>${p}: ${c}</p>\n      </div>\n    `}formatSolutionForDisplay(t){if(!t||0===t.length)return"";const e={};t.forEach(t=>{const n=`${t.currency}_${t.multiplier}`;e[n]||(e[n]={currency:t.currency,multiplier:t.multiplier,totalQuantity:0,lotTypes:[]}),e[n].totalQuantity+=t.quantity,t.lotType&&e[n].lotTypes.push(t.lotType)});const n=Object.values(e).map(t=>{const e=this.currencyData[t.currency],n=t.lotTypes.some(t=>"trio"===t||"septuple"===t)?"üì¶":"";return 1===t.multiplier?`${this.nf.format(t.totalQuantity)} ${e.emoji} ${this.getCurrencyName(t.currency).toLowerCase()} ${n}`:`${this.nf.format(t.totalQuantity)} ${e.emoji} ${this.getCurrencyName(t.currency).toLowerCase()}(√ó${this.nf.format(t.multiplier)}) ${n}`});if(n.length>1){const t=n.pop();return`${n.join(", ")} ${this.getTranslation("shop.converter.and","et")} ${t}`}return n.join("")}calculateTotalPiecesFromSolution(t){return t&&0!==t.length?t.reduce((t,e)=>t+e.quantity,0):0}calculateEconomyGained(t){return t&&0!==t.length?t.reduce((t,e)=>t+(e.economyGained||0),0):0}calculateTotalPieces(t){if(t<=0)return 0;const e=this.findMinimalCoins(t,!1);return e&&0!==e.length?this.calculateTotalPiecesFromSolution(e):0}updateCoinLotsRecommendations(t,e=!1){const n=document.getElementById("coin-lots-recommendations");n&&(n.style.display="block",0!==t?window.CoinLotOptimizer?(this.showCalculatingIndicator(),setTimeout(()=>{try{const n={};if(e){this.getUserMultiplierBreakdown().forEach(t=>{const e=`${t.currency}_${t.multiplier}`;n[e]=(n[e]||0)+t.quantity})}else{this.findMinimalCoins(t,!1).forEach(t=>{const e=`${t.currency}_${t.multiplier}`;n[e]=(n[e]||0)+t.quantity})}const i=(new window.CoinLotOptimizer).findOptimalProductCombination(n);i&&i.length>0?this.displayRecommendations(i):this.displayNoRecommendationsMessage()}catch(t){console.error("Erreur calcul recommandations:",t),this.displayNoRecommendationsMessage()}finally{this.hideCalculatingIndicator()}},100)):(console.warn("CoinLotOptimizer non disponible"),this.displayNoRecommendationsMessage()):this.displayDefaultRecommendationMessage())}showCalculatingIndicator(){const t=document.getElementById("coin-lots-content");if(!t)return;const e="en"===this.getCurrentLang()?"Calculating optimal lots...":"Calcul des lots optimaux...";t.innerHTML=`\n      <div class="calculating-indicator flex items-center justify-center p-8">\n        <div class="text-center">\n          <div class="abacus-animation mb-4">\n            <div class="text-6xl animate-bounce">üßÆ</div>\n          </div>\n          <p class="text-amber-300 font-medium">${e}</p>\n          <div class="flex justify-center mt-2 space-x-1">\n            <div class="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></div>\n            <div class="w-2 h-2 bg-amber-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>\n            <div class="w-2 h-2 bg-amber-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>\n          </div>\n        </div>\n      </div>\n    `}displayDefaultRecommendationMessage(){const t=document.getElementById("coin-lots-content"),e=document.getElementById("add-all-lots-to-cart");t&&(t.innerHTML='\n        <div class="text-center py-8">\n          <div class="text-6xl mb-4">ü™ô</div>\n          <p class="text-gray-300 text-lg mb-2">Entrez des montants dans le convertisseur</p>\n          <p class="text-gray-400 text-sm">pour voir les lots de pi√®ces recommand√©s</p>\n        </div>\n      '),e&&(e.style.display="none")}displayNoRecommendationsMessage(){const t=document.getElementById("coin-lots-content"),e=document.getElementById("add-all-lots-to-cart");t&&(t.innerHTML='\n        <div class="text-center py-8">\n          <div class="text-6xl mb-4">üîç</div>\n          <p class="text-gray-300 text-lg mb-2">Aucune recommandation trouv√©e</p>\n          <p class="text-gray-400 text-sm">Essayez avec d\'autres montants</p>\n        </div>\n      '),e&&(e.style.display="none")}displayRecommendations(t){const e=document.getElementById("coin-lots-content"),n=document.getElementById("add-all-lots-to-cart");if(!e)return;this.getCurrentLang();let i='<div class="space-y-4">',o=0;t.forEach((t,e)=>{const n=t.totalCost||t.price*t.quantity;o+=n,i+=`\n        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-600/30">\n          <div class="flex justify-between items-center">\n            <div class="flex-1">\n              <h6 class="font-medium text-gray-200">${t.displayName}</h6>\n              <p class="text-sm text-gray-400">Quantit√©: ${t.quantity}</p>\n            </div>\n            <div class="text-right">\n              <p class="font-bold text-green-400">$${n.toFixed(2)}</p>\n              <p class="text-xs text-gray-400">$${t.price.toFixed(2)} / unit√©</p>\n            </div>\n          </div>\n        </div>\n      `}),i+=`\n      <div class="border-t border-gray-600/30 pt-4">\n        <div class="flex justify-between items-center text-lg font-bold">\n          <span class="text-gray-200">Total:</span>\n          <span class="text-green-400">$${o.toFixed(2)}</span>\n        </div>\n      </div>\n    </div>`,e.innerHTML=i,n&&(n.style.display="block",n.dataset.lotsData=JSON.stringify(t),n.textContent="Ajouter tous les lots au panier")}hideCalculatingIndicator(){}updateDisplay(){this.updateFromSources()}destroy(){const t=document.getElementById("currency-converter-premium");if(t){const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t)}}getUserMultiplierBreakdown(){this.multiplierInputs||this.refreshDOMReferences();const t=[];return this.multiplierInputs&&this.multiplierInputs.forEach(e=>{const{currency:n}=e.closest("tr").dataset,i=parseInt(e.dataset.multiplier),o=parseInt(e.value.replace(/\s/g,""))||0;o>0&&t.push({currency:n,multiplier:i,quantity:o,value:this.rates[n]*i})}),t}formatBreakdownText(t){if(!t||0===t.length)return"";const e=t.map(t=>{const e=this.currencyData[t.currency];return 1===t.multiplier?`${this.nf.format(t.quantity)} ${e.emoji} ${this.getCurrencyName(t.currency).toLowerCase()}`:`${this.nf.format(t.quantity)} ${e.emoji} ${this.getCurrencyName(t.currency).toLowerCase()}(√ó${this.nf.format(t.multiplier)})`});if(e.length>1){const t=e.pop();return`${e.join(", ")} ${this.getTranslation("shop.converter.and","et")} ${t}`}return e.join("")}updateOptimalRecommendationsFromUser(t){if(this.bestDisplay||this.refreshDOMReferences(),!this.bestDisplay)return;if(0===t){const t=this.getTranslation("shop.converter.enterAmounts","Entrez des montants pour voir les recommandations optimales");return void(this.bestDisplay.innerHTML=t)}const e=this.getUserMultiplierBreakdown(),n=e.reduce((t,e)=>t+e.quantity,0),i=this.findMinimalCoins(t,!1),o=i?i.reduce((t,e)=>t+e.quantity,0):1/0;let s,r,a;n>0&&n<=o?(s=e,r=n,a="user"):i?(s=i,r=o,a="algorithm"):(s=e.length>0?e:[],r=n,a="user");const c=this.formatBreakdownText(s),l="user"===a?'<span class="text-blue-600">‚úèÔ∏è</span>':'<span class="text-green-600">ü§ñ</span>',u=Math.floor(t/this.rates.gold),d=t%this.rates.gold;let m="";if(u>0){if(m=`${this.nf.format(u)} ü•á ${this.getCurrencyName("gold").toLowerCase()}`,d>0){const t=this.getOptimalBreakdown(d);m+=` ${this.getTranslation("shop.converter.and","et")} ${t}`}}else m=this.getOptimalBreakdown(t);const p=this.getTranslation("shop.converter.optimalConversion","Conversion optimale"),h=this.getTranslation("shop.converter.total","Total"),g=this.getTranslation("shop.converter.value","Valeur");this.bestDisplay.innerHTML=`\n      <div class="text-center">\n        <p class="text-lg mb-2"><strong>${p}:</strong> ${l}</p>\n        <p class="text-indigo-300 font-medium mb-2">${c}</p>\n        <p class="text-sm text-gray-400">${h}: ${this.nf.format(r)} ${this.getTranslation("shop.converter.coins","pi√®ces")}</p>\n        <p class="text-sm text-gray-400"><br>${g}: ${m}</p>\n      </div>\n    `}}function logOptimizationInfo(){console.log("üí∞ Nouvelles r√®gles d'optimisation activ√©es:"),console.log("1. üì¶ Lots 3/7 pi√®ces: 4‚Üí(3+1), 6‚Üí(3+3), 8‚Üí(7+1), 10‚Üí(7+3)"),console.log("2. ü•á Priorit√© m√©tal > multiplicateur: Platine > Or > √âlectrum > Argent > Cuivre"),console.log("3. ‚úèÔ∏è Mode tableau: pr√©serve m√©taux utilisateur, optimise multiplicateurs"),console.log("4. üí∏ √âconomies: Trio 25$ vs 30$, Septuple 50$ vs 70$")}window.addEventListener("beforeunload",()=>{window.converterInstance&&"function"==typeof window.converterInstance.destroy&&window.converterInstance.destroy()}),("#debug"===window.location.hash||window.location.search.includes("debug=1"))&&setTimeout(logOptimizationInfo,1e3);let converterInitialized=!1;const initConverter=()=>{converterInitialized||(converterInitialized=!0,setTimeout(()=>{document.getElementById("currency-converter-premium")&&(window.converterInstance=new CurrencyConverterPremium,window.currencyConverter=window.converterInstance,("#debug"===window.location.hash||window.location.search.includes("debug=1"))&&console.log("‚úÖ CurrencyConverterPremium initialis√© avec nouvelles r√®gles d'optimisation"))},100))};document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("currency-converter-premium");if(!t)return;const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(initConverter(),e.disconnect())})},{threshold:.1});e.observe(t),["click","scroll","touchstart"].forEach(t=>{document.addEventListener(t,()=>{setTimeout(initConverter,500)},{once:!0,passive:!0})})});class CoinLotOptimizer{constructor(){this.DEBUG_MODE=!1,this.rates={copper:1,silver:10,electrum:50,gold:100,platinum:1e3},this.multipliers=[1,10,100,1e3,1e4],this.metalNames={fr:{copper:"Cuivre",silver:"Argent",electrum:"√âlectrum",gold:"Or",platinum:"Platine"},en:{copper:"Copper",silver:"Silver",electrum:"Electrum",gold:"Gold",platinum:"Platinum"}}}debugLog(...t){this.DEBUG_MODE&&console.log(...t)}getCurrentLang(){return document.documentElement?.lang||"fr"}findOptimalProductCombination(t){if(this.debugLog("üéØ CoinLotOptimizer: Recherche solution optimale pour:",t),!t||0===Object.keys(t).length)return[];if(!window.products)return[];const e=this.generateAllProductVariations();this.debugLog(`üì¶ CoinLotOptimizer: ${e.length} variations g√©n√©r√©es`);const n=this.knapsackOptimize(t,e);return this.formatSolution(n)}generateAllProductVariations(){const t=[];return Object.entries(window.products).forEach(([e,n])=>{n&&"pieces"===n.category&&(n.customizable?this.generateCustomizableVariations(e,n,t):this.generateFixedVariations(e,n,t))}),this.debugLog(`‚úÖ CoinLotOptimizer: ${t.length} variations g√©n√©r√©es au total`),t}generateCustomizableVariations(t,e,n){const i=e.metals_en||["copper","silver","electrum","gold","platinum"],o=e.multipliers||[1,10,100,1e3,1e4];if("coin-quintessence-metals"===t)this.debugLog(`üî∏ CoinLotOptimizer: ${e.name} - Type Quintessence (${o.length} variations)`),o.forEach(o=>{const s={};i.forEach(t=>{s[`${t}_${o}`]=1}),n.push({productId:t,name:e.name,price:e.price,type:"quintessence",multiplier:o,capacity:s,coinsProvided:i.length})});else{const s=Object.values(e.coin_lots)[0]||1;this.debugLog(`üîπ CoinLotOptimizer: ${e.name} - Type normal (${i.length*o.length} variations, ${s} pi√®ces par lot)`),i.forEach(i=>{o.forEach(o=>{if(e.coin_lots[i]){const s={};s[`${i}_${o}`]=e.coin_lots[i],n.push({productId:t,name:e.name,price:e.price,type:"normal",metal:i,multiplier:o,capacity:s,coinsProvided:e.coin_lots[i]})}})})}}generateFixedVariations(t,e,n){this.debugLog(`üî≥ CoinLotOptimizer: ${e.name} - Produit fixe`);const i=e.multipliers||[];if(i.length>0)i.forEach(i=>{const o={};let s=0;e.coin_lots&&Object.entries(e.coin_lots).forEach(([t,e])=>{"number"==typeof e&&e>0&&(o[`${t}_${i}`]=e,s+=e)}),Object.keys(o).length>0&&n.push({productId:t,name:e.name,price:e.price,type:"fixed_multiplier",multiplier:i,capacity:o,coinsProvided:s})});else{const i={};let o=0;e.coin_lots&&Object.entries(e.coin_lots).forEach(([t,e])=>{"number"==typeof e?(i[`${t}_1`]=e,o+=e):"object"==typeof e&&null!==e&&Object.entries(e).forEach(([e,n])=>{n>0&&(i[`${t}_${e}`]=n,o+=n)})}),Object.keys(i).length>0&&n.push({productId:t,name:e.name,price:e.price,type:"fixed_complete",capacity:i,coinsProvided:o})}}knapsackOptimize(t,e){this.debugLog("üßÆ CoinLotOptimizer: Algorithme de sac √† dos...");const n=[];this.findBruteForceOptimal(t,e).forEach(t=>n.push(t)),e.forEach(e=>{if(this.canCoverAllNeeds(e,t)){const i=this.calculateRequiredQuantity(e,t),o=e.price*i;n.push({items:[{variation:e,quantity:i}],totalCost:o,type:"single"}),this.debugLog(`üí° CoinLotOptimizer: Solution unique: ${e.name} (${e.type}) x${i} = ${o}$`)}});const i=e.filter(t=>"quintessence"===t.type);this.findQuintessenceCombinations(t,i).forEach(t=>{const e=t.reduce((t,e)=>t+e.variation.price*e.quantity,0);n.push({items:t,totalCost:e,type:"quintessence_multiple"}),this.debugLog(`üåü CoinLotOptimizer: Combinaison Quintessence: ${e}$ (${t.length} Quintessences)`)});if(this.findDecompositionSolutions(t,e).forEach(t=>{n.push({items:t,totalCost:t.reduce((t,e)=>t+e.variation.price*e.quantity,0),type:"decomposition"});const e=t.reduce((t,e)=>t+e.variation.price*e.quantity,0);this.debugLog(`üß© CoinLotOptimizer: D√©composition intelligente: ${e}$ (${t.length} produits)`)}),i.forEach(i=>{const o=this.calculateCoverage(i,t,1),s=this.calculateRemainingNeeds(t,o);if(Object.keys(s).length>0){const t=this.findComplementSolution(s,e);if(t){const e=[{variation:i,quantity:1},...t],o=e.reduce((t,e)=>t+e.variation.price*e.quantity,0);n.push({items:e,totalCost:o,type:"combined"}),this.debugLog(`üîó CoinLotOptimizer: Solution combin√©e: ${o}$ (${e.length} produits)`)}}}),n.length<3){const i=this.findCustomCoinsSolution(t,e);if(i&&i.length>0){const t=i.reduce((t,e)=>t+e.variation.price*e.quantity,0);n.push({items:i,totalCost:t,type:"custom_fallback"}),this.debugLog(`üîß CoinLotOptimizer: Solution pi√®ces personnalis√©es (fallback): ${t}$ (${i.length} produits)`)}}this.findBulkOptimizedSolutions(t,e).forEach(t=>{n.push({items:t,totalCost:t.reduce((t,e)=>t+e.variation.price*e.quantity,0),type:"bulk_optimized"})});const o=n.filter(e=>this.validateSolution(e.items,t)).map(t=>{const n=this.optimizeWithBulkLots(t.items,e),i=this.calculateSolutionCost(n);return{...t,items:n,totalCost:i,type:`${t.type}_bulk_optimized`}});if(o.sort((t,e)=>t.totalCost-e.totalCost),o.length>0){const t=o[0];return this.debugLog(`üèÜ CoinLotOptimizer: Solution optimale: ${t.totalCost}$ (${t.type})`),t.items}return[]}canCoverAllNeeds(t,e){for(const[n,i]of Object.entries(e))if(i>0&&(!t.capacity[n]||0===t.capacity[n]))return!1;return!0}calculateRequiredQuantity(t,e){let n=1;for(const[i,o]of Object.entries(e))if(o>0&&t.capacity[i]){const e=Math.ceil(o/t.capacity[i]);n=Math.max(n,e)}return n}calculateCoverage(t,e,n=1){const i={};for(const[o,s]of Object.entries(e)){const e=(t.capacity[o]||0)*n;e>0&&(i[o]=Math.min(s,e))}return i}calculateRemainingNeeds(t,e){const n={};for(const[i,o]of Object.entries(t)){const t=o-(e[i]||0);t>0&&(n[i]=t)}return n}findBruteForceOptimal(t,e){this.debugLog("üöÄ CoinLotOptimizer: Brute-force intelligent...");const n=[],i=this.calculateMaxReasonableQuantity(t);if(this.debugLog(`üîç CoinLotOptimizer: Test quantit√©s jusqu'√† ${i} par produit`),e.forEach(e=>{for(let o=1;o<=i;o++)if(this.canCoverWithQuantity(e,t,o)){if(this.isWastefulSolution(e,t,o)){this.debugLog(`‚ö†Ô∏è CoinLotOptimizer: ${e.name} x${o} rejet√© (gaspillage excessif)`);continue}const i=e.price*o;n.push({items:[{variation:e,quantity:o}],totalCost:i,type:"brute_force_single"}),this.debugLog(`‚úÖ CoinLotOptimizer: ${e.name} x${o} = ${i}$ (couvre avec surplus acceptable)`)}}),Object.keys(t).length>1&&n.length<5&&this.findBruteForce2Products(t,e,n,i),0===n.length||n.every(t=>t.totalCost>50)){this.debugLog("üîÑ CoinLotOptimizer: Fallback vers pi√®ces individuelles");const i=this.createIndividualSolution(t,e);i&&n.push(i)}return n.sort((t,e)=>t.totalCost-e.totalCost)}findBruteForce2Products(t,e,n,i){const o=Math.min(e.length,10);for(let i=0;i<o;i++)for(let s=i+1;s<o;s++){const o=e[i],r=e[s];for(let e=1;e<=3;e++)for(let i=1;i<=3;i++)if(this.canCoverWith2Products(o,e,r,i,t)){const t=o.price*e+r.price*i;n.push({items:[{variation:o,quantity:e},{variation:r,quantity:i}],totalCost:t,type:"brute_force_double"}),this.debugLog(`‚úÖ CoinLotOptimizer: ${o.name} x${e} + ${r.name} x${i} = ${t}$`)}}}canCoverWithQuantity(t,e,n){const i={};return Object.entries(t.capacity).forEach(([t,e])=>{i[t]=e*n}),Object.entries(e).every(([t,e])=>e<=(i[t]||0))}isWastefulSolution(t,e,n){if("quintessence"===t.type){const i=Object.keys(e).map(t=>t.split("_")[0]),o=[...new Set(i)];if(o.length<=2)return this.debugLog(`üö´ Anti-gaspillage: Quintessence rejet√©e (${o.length} m√©taux vs 5 fournis)`),!0;const s=Object.values(e).reduce((t,e)=>t+e,0),r=t.price*n,a=10*s;if(a<r)return this.debugLog(`üö´ Anti-gaspillage: Quintessence rejet√©e (${o.length} m√©taux, $${r} vs $${a} individuel)`),!0;if(s<=3&&o.length<=2)return this.debugLog(`üö´ Anti-gaspillage: Quintessence rejet√©e (${s} pi√®ces, ${o.length} m√©taux)`),!0}const i=Object.values(t.capacity).reduce((t,e)=>t+e*n,0),o=(i-Object.values(e).reduce((t,e)=>t+e,0))/i;return o>.7&&(this.debugLog(`üö´ Anti-gaspillage: ${t.name} rejet√© (${Math.round(100*o)}% gaspillage)`),!0)}createIndividualSolution(t,e){const n=[];let i=0;for(const[o,s]of Object.entries(t)){if(s<=0)continue;const[t,r]=o.split("_"),a=e.find(t=>"normal"===t.type&&"coin-custom-single"===t.productId&&1===t.capacity[o]);if(!a)return this.debugLog(`‚ö†Ô∏è CoinLotOptimizer: Pi√®ce individuelle non trouv√©e pour ${o}`),null;n.push({variation:a,quantity:s}),i+=a.price*s,this.debugLog(`  + ${s}x ${a.name} ($${a.price})`)}return 0===n.length?null:(this.debugLog(`üèóÔ∏è CoinLotOptimizer: Solution individuelle cr√©√©e - $${i}`),{items:n,totalCost:i,type:"individual_fallback"})}canCoverWith2Products(t,e,n,i,o){const s={};return Object.entries(t.capacity).forEach(([t,n])=>{s[t]=(s[t]||0)+n*e}),Object.entries(n.capacity).forEach(([t,e])=>{s[t]=(s[t]||0)+e*i}),Object.entries(o).every(([t,e])=>e<=(s[t]||0))}calculateMaxReasonableQuantity(t){const e=Object.values(t).reduce((t,e)=>t+e,0);return e<=5?8:e<=10?5:e<=20?3:2}findCustomCoinsSolution(t,e){const n=e.filter(t=>"coin-custom-single"===t.productId&&"normal"===t.type),i=[];for(const[e,o]of Object.entries(t)){if(o<=0)continue;const[t,s]=e.split("_"),r=n.find(e=>e.metal===t&&e.multiplier==s);if(!r)return null;i.push({variation:r,quantity:o})}return i.length>0?i:null}findComplementSolution(t,e){return this.findCustomCoinsSolution(t,e)}formatSolution(t){if(!t||0===t.length)return[];const e=[],n=this.getCurrentLang();for(const i of t){const{variation:t}=i;let o=t.name;const s={};if("quintessence"===t.type)o+=` (√ó${t.multiplier})`,s[`multiplier-${t.productId}`]={role:"multiplier",value:t.multiplier};else if("normal"===t.type&&t.metal&&t.multiplier){o+=` (${this.metalNames[n][t.metal]||t.metal} √ó${t.multiplier})`,s[`metal-${t.productId}`]={role:"metal",value:t.metal},s[`multiplier-${t.productId}`]={role:"multiplier",value:t.multiplier}}else"fixed_multiplier"===t.type&&(o+=` (√ó${t.multiplier})`,s[`multiplier-${t.productId}`]={role:"multiplier",value:t.multiplier});e.push({productId:t.productId,displayName:o,price:t.price,quantity:i.quantity,totalCost:t.price*i.quantity,customFields:s,url:`/${n}/products/${t.productId}/`,image:window.products[t.productId]?.images?.[0]||null,description:window.products[t.productId]?.description||""})}return e}findQuintessenceCombinations(t,e){const n=[],i=this.multipliers.map(e=>this.identifyQuintessencePattern(t,e)).filter(t=>t.matches>=4);this.debugLog(`üîç CoinLotOptimizer: ${i.length} patterns Quintessence d√©tect√©s`);for(let o=0;o<i.length;o++)for(let s=o+1;s<i.length;s++){const r=i[o],a=i[s];if(r.multiplier!==a.multiplier&&r.matches>=4&&a.matches>=4){const i=e.find(t=>t.multiplier===r.multiplier),o=e.find(t=>t.multiplier===a.multiplier);if(i&&o){const e=[{variation:i,quantity:1},{variation:o,quantity:1}],s={...t};e.forEach(t=>{Object.entries(t.variation.capacity).forEach(([t,e])=>{s[t]&&(s[t]=Math.max(0,s[t]-e))})});const c=this.generateAllProductVariations().filter(t=>"normal"===t.type&&"coin-custom-single"===t.productId),l=this.findCustomCoinsSolution(s,c);if(l){const i=[...e,...l],o=i.reduce((t,e)=>t+e.variation.price*e.quantity,0);this.validateSolution(i,t)&&(this.debugLog(`üåü CoinLotOptimizer: Combo optimal Quintessence √ó${r.multiplier} + √ó${a.multiplier} + custom: ${o}$`),n.push(i))}}}}for(let i=2;i<=Math.min(3,e.length);i++){this.generateCombinations(e,i).forEach(e=>{const i=this.testQuintessenceCombination(t,e);i&&i.length>0&&n.push(i)})}return n}generateCombinations(t,e){if(1===e)return t.map(t=>[t]);if(e>t.length)return[];const n=[];for(let i=0;i<=t.length-e;i++){this.generateCombinations(t.slice(i+1),e-1).forEach(e=>{n.push([t[i],...e])})}return n}testQuintessenceCombination(t,e){const n={};e.forEach(t=>{Object.entries(t.capacity).forEach(([t,e])=>{n[t]=(n[t]||0)+e})});for(const[e,i]of Object.entries(t))if(i>0&&(!n[e]||n[e]<i))return null;return e.map(t=>({variation:t,quantity:1}))}findDecompositionSolutions(t,e){const n=[],i=(e.filter(t=>"quintessence"===t.type),this.multipliers.map(e=>this.identifyQuintessencePattern(t,e)).filter(t=>t.matches>=4));for(let o=0;o<i.length;o++){const s=this.buildMultiPatternSolution(t,[i[o]],e);s&&s.length>0&&n.push(s);for(let s=o+1;s<i.length;s++){const r=this.buildMultiPatternSolution(t,[i[o],i[s]],e);r&&r.length>0&&n.push(r);for(let r=s+1;r<i.length;r++){const a=this.buildMultiPatternSolution(t,[i[o],i[s],i[r]],e);a&&a.length>0&&n.push(a)}}}return n}identifyQuintessencePattern(t,e){let n=0;const i=[];return["platinum","gold","electrum","silver","copper"].forEach(o=>{const s=`${o}_${e}`;t[s]&&t[s]>=1&&(n++,i.push(o))}),{multiplier:e,matches:n,matchingMetals:i,isComplete:5===n,isPartial:n>=4&&n<5}}buildMultiPatternSolution(t,e,n){const i=[],o={...t};e.forEach(t=>{if(t.matches>=4){const e=n.find(e=>"quintessence"===e.type&&e.multiplier===t.multiplier);e&&(i.push({variation:e,quantity:1}),Object.entries(e.capacity).forEach(([t,e])=>{o[t]&&(o[t]=Math.max(0,o[t]-e))}))}});const s=n.filter(t=>"normal"===t.type&&"coin-custom-single"===t.productId);return Object.entries(o).forEach(([t,e])=>{if(e>0){const[n,o]=t.split("_"),r=s.find(t=>t.metal===n&&t.multiplier===parseInt(o));r&&i.push({variation:r,quantity:e})}}),i.length>0&&this.validateSolution(i,t)?i:null}validateSolution(t,e){const n={};t.forEach(t=>{t.variation&&t.variation.capacity&&Object.entries(t.variation.capacity).forEach(([e,i])=>{n[e]=(n[e]||0)+i*t.quantity})});let i=!0;const o=[];for(const[t,s]of Object.entries(e))if(s>0){const e=n[t]||0;e<s&&(i=!1,o.push(`${t} (besoin ${s}, couvert ${e})`))}return!!i}findBulkOptimizedSolutions(t,e){this.debugLog("üéØ CoinLotOptimizer: Recherche solutions avec lots trio/septuple...");const n=[],i=this.groupIdenticalNeeds(t);return Object.entries(i).forEach(([i,o])=>{if(o>=3){const[s,r]=i.split("_"),a=this.findBestBulkSolution(s,parseInt(r),o,e);if(a&&a.length>0){const o={...t};delete o[i];const s=this.findComplementSolution(o,e);s?n.push([...a,...s]):0===Object.keys(o).length&&n.push(a)}}}),n}groupIdenticalNeeds(t){return t}findBestBulkSolution(t,e,n,i){const o=[],s=i.find(n=>"coin-trio-customizable"===n.productId&&n.metal===t&&n.multiplier===e),r=i.find(n=>"coin-septuple-free"===n.productId&&n.metal===t&&n.multiplier===e),a=i.find(n=>"coin-custom-single"===n.productId&&n.metal===t&&n.multiplier===e);if(n>=7&&r){const t=Math.floor(n/7),e=n%7,i=[];if(t>0&&i.push({variation:r,quantity:t}),e>=3&&s){const t=Math.floor(e/3),n=e%3;t>0&&i.push({variation:s,quantity:t}),n>0&&a&&i.push({variation:a,quantity:n})}else e>0&&a&&i.push({variation:a,quantity:e});o.push(i)}if(n>=3&&s){const t=Math.floor(n/3),e=n%3,i=[];t>0&&i.push({variation:s,quantity:t}),e>0&&a&&i.push({variation:a,quantity:e}),o.push(i)}if(a&&o.push([{variation:a,quantity:n}]),o.length>0){const i=o.reduce((t,e)=>e.reduce((t,e)=>t+e.variation.price*e.quantity,0)<t.reduce((t,e)=>t+e.variation.price*e.quantity,0)?e:t),s=i.reduce((t,e)=>t+e.variation.price*e.quantity,0),r=n*(a?.price||10);return this.debugLog(`üí∞ CoinLotOptimizer: ${t}√ó${e} x${n} - Lots: ${s}$ vs Individuelles: ${r}$`),i}return null}optimizeWithBulkLots(t,e){const n={};t.forEach(t=>{const e=`${t.variation.productId}_${t.variation.metal||"none"}_${t.variation.multiplier||"none"}`;n[e]||(n[e]={variation:t.variation,totalQuantity:0,items:[]}),n[e].totalQuantity+=t.quantity,n[e].items.push(t)});const i=[];return Object.values(n).forEach(t=>{const{variation:n,totalQuantity:o}=t;if("coin-custom-single"===n.productId&&o>=3){const{metal:t}=n,{multiplier:s}=n;if(t&&s){const r=this.findBestBulkSolution(t,s,o,e);if(r){const e=r.reduce((t,e)=>t+e.variation.price*e.quantity,0),a=o*n.price;if(e<a)return this.debugLog(`üéØ CoinLotOptimizer: Optimisation ${t}√ó${s} x${o}: ${a}$ ‚Üí ${e}$ (√©conomie ${a-e}$)`),void i.push(...r)}}}i.push(...t.items)}),i}calculateSolutionCost(t){return t.reduce((t,e)=>t+e.variation.price*e.quantity,0)}completeWithCustomPieces(t,e){const n=[...t],i=[];if(window.products&&window.products["coin-custom-single"]){const t=window.products["coin-custom-single"],e=t.metals_en||["copper","silver","electrum","gold","platinum"],n=t.multipliers||[1,10,100,1e3,1e4];e.forEach(e=>{n.forEach(n=>{t.coin_lots[e]&&i.push({productId:"coin-custom-single",name:t.name,price:t.price,type:"normal",metal:e,multiplier:n,capacity:{[`${e}_${n}`]:t.coin_lots[e]},coinsProvided:t.coin_lots[e]})})})}return Object.entries(e).forEach(([t,e])=>{if(e>0){const[o,s]=t.split("_"),r=i.find(t=>t.metal===o&&t.multiplier===parseInt(s));r&&n.push({variation:r,quantity:e})}}),n.length>0&&this.validateSolution(n,originalNeeds)?n:null}}window.CoinLotOptimizer=CoinLotOptimizer;