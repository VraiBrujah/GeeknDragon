class SnipcartUtils{static get debugMode(){return!0===window.DEBUG_MODE}static debugLog(...t){this.debugMode&&console.log(...t)}static createAddToCartButton(t,e={}){const{quantity:i=1,customFields:a={},className:o="snipcart-add-item btn-cart-icon",text:n="Ajouter au panier",useIconButton:s=!0,...r}=e,u=document.createElement("button");if(u.className=o,s){const t=document.createElement("img");t.src="/media/branding/icons/ajout.webp",t.alt=n,t.className="btn-cart-icon-img",t.loading="lazy",u.appendChild(t),u.setAttribute("aria-label",n),u.setAttribute("title",n)}else u.textContent=n;const c={"data-item-id":t.id,"data-item-name":t.name,"data-item-description":t.summary||t.description||"","data-item-price":t.price.toString(),"data-item-quantity":i.toString()};t.name_en&&(c["data-item-name-en"]=t.name_en),t.summary_en&&(c["data-item-description-en"]=t.summary_en),t.url&&(c["data-item-url"]=t.url),t.image&&(c["data-item-image"]=t.image),Object.entries(c).forEach(([t,e])=>{u.setAttribute(t,e)}),this.debugLog("DEBUG createAddToCartButton - customFields reçus:",a);const d=this.normalizeCustomFields(a);if(this.debugLog("DEBUG createAddToCartButton - normalizedFields:",d),Object.entries(d).forEach(([t,e])=>{const i=t.replace("custom","");u.setAttribute(`data-item-custom${i}-name`,e.name),u.setAttribute(`data-item-custom${i}-type`,e.type),u.setAttribute(`data-item-custom${i}-options`,e.options),u.setAttribute(`data-item-custom${i}-value`,e.value),e.role&&u.setAttribute(`data-item-custom${i}-role`,e.role)}),Object.entries(r).forEach(([t,e])=>{u.setAttribute(t,e)}),this.debugMode){this.debugLog("DEBUG - Attributs du bouton créé:");for(let t of u.attributes)t.name.startsWith("data-item")&&this.debugLog(`  ${t.name} = "${t.value}"`)}return u}static playSound(t,e=.5){try{const i=new Audio(t);i.volume=Math.max(0,Math.min(1,e)),i.play().catch(()=>{})}catch(t){}}static async addToCart(t,e={}){if(this.playSound("media/sounds/coin-drop.mp3",.5),window.Snipcart&&window.Snipcart.api&&window.Snipcart.api.cart)try{this.debugLog("=== AVANT CRÉATION BOUTON ==="),this.debugLog("productData:",t),this.debugLog("options:",e);const i=this.createAddToCartButton(t,e);this.debugLog("✅ Bouton créé");const a=this.extractProductDataFromButton(i);if(this.debugLog("✅ Données extraites - snipcartData:",a),this.debugLog("=== SNIPCART API DATA ==="),this.debugLog("snipcartData.customFields type:",typeof a.customFields),this.debugLog("snipcartData.customFields isArray:",Array.isArray(a.customFields)),this.debugLog("snipcartData.customFields contenu:",a.customFields),this.debugLog("snipcartData.customFields length:",a.customFields?.length),Array.isArray(a.customFields)&&a.customFields.length>0){const t=document.documentElement?.lang||"fr";a.customFields=a.customFields.map(e=>{const i={name:e.name,value:this.translateValue(e.value,t)};return e.type&&(i.type=e.type),e.options&&"string"==typeof e.options&&(i.options=e.options.split("|").map(e=>{const i=e.split("[")[0];return{name:this.translateValue(i,t)}})),i}),this.debugLog("customFields transformé:",a.customFields)}return await window.Snipcart.api.cart.items.add(a),this.debugLog("✅ Ajouté à Snipcart via API"),!0}catch(t){this.debugLog("❌ ERREUR API SNIPCART:",t),this.debugLog("→ Fallback vers méthode HTML")}const i=this.createAddToCartButton(t,e);return i.style.display="none",document.body.appendChild(i),i.click(),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300),!0}static addFromButton(t,e=null){e&&(e.preventDefault(),e.stopPropagation()),this.playSound("media/sounds/coin-drop.mp3",.5);const i=this.extractProductDataFromButton(t);if(window.Snipcart&&window.Snipcart.api&&window.Snipcart.api.cart)try{return window.Snipcart.api.cart.items.add(i),!0}catch(t){}const a=t.cloneNode(!0);return a.style.display="none",document.body.appendChild(a),setTimeout(()=>{a.click(),document.body.removeChild(a)},10),!0}static extractProductDataFromButton(t){if(this.debugMode){this.debugLog("=== EXTRACTION DEPUIS BOUTON ==="),this.debugLog("Attributs du bouton:");for(let e of t.attributes)e.name.startsWith("data-item")&&this.debugLog(`  ${e.name}: ${e.value}`)}const e={id:t.getAttribute("data-item-id"),name:t.getAttribute("data-item-name"),price:parseFloat(t.getAttribute("data-item-price")||"0"),url:t.getAttribute("data-item-url")||window.location.href,quantity:parseInt(t.getAttribute("data-item-quantity")||"1"),description:t.getAttribute("data-item-description")},i=t.getAttribute("data-item-image");i&&(e.image=i),e.customFields=[];for(let i=1;i<=5;i++){const a=t.getAttribute(`data-item-custom${i}-name`),o=t.getAttribute(`data-item-custom${i}-value`),n=t.getAttribute(`data-item-custom${i}-type`),s=t.getAttribute(`data-item-custom${i}-options`);if(a&&o){const t={name:a,value:o};n&&(t.type=n),s&&(t.options=s),e.customFields.push(t)}}return e}static async addMultipleToCart(t,e=null){if(!t||0===t.length)return void(e&&e(0,0));let i=0,a=0;const o=()=>{if(window.Snipcart&&window.Snipcart.api&&window.Snipcart.api.cart)try{return window.Snipcart.api.cart.items.count()||0}catch(t){return 0}return 0};for(let n=0;n<t.length;n++){const s=t[n],r=o();try{if(await this.addToCart(s.product,{quantity:s.quantity,customFields:s.customFields||{}})){let t=0;const e=3;for(;t<e;){await new Promise(t=>setTimeout(t,150));if(o()>r){a++;break}t++}}i++,e&&e(a,t.length,i),n<t.length-1&&await new Promise(t=>setTimeout(t,400))}catch(o){i++,e&&e(a,t.length,i),n<t.length-1&&await new Promise(t=>setTimeout(t,600))}}}static updateCartButton(t,e={}){const{quantity:i,metal:a,multiplier:o,triptych:n,language:s}=e;void 0!==i&&t.setAttribute("data-item-quantity",i.toString()),this.updateCustomFields(t,e)}static updateCustomFields(t,e){const{metal:i,multiplier:a,triptych:o,language:n}=e;if(void 0!==i){const e=this.findCustomFieldByRole(t,"metal");e&&t.setAttribute(`data-item-custom${e}-value`,i)}if(void 0!==a){const e=this.findCustomFieldByRole(t,"multiplier");e&&t.setAttribute(`data-item-custom${e}-value`,a.toString())}if(void 0!==o){const e=this.findCustomFieldByRole(t,"triptych");e&&t.setAttribute(`data-item-custom${e}-value`,o)}if(void 0!==n){const e=this.findCustomFieldByRole(t,"language");e&&t.setAttribute(`data-item-custom${e}-value`,n)}}static findCustomFieldByRole(t,e){const i=Array.from(t.attributes);for(const t of i){const i=t.name.match(/^data-item-custom(\d+)-role$/);if(i&&t.value===e)return i[1]}return null}static normalizeCustomFields(t){const e={};let i=1;if(t.custom1||t.custom2)return t;const a=Object.entries(t).find(([t])=>t.includes("metal")),o=Object.entries(t).find(([t])=>t.includes("multiplier")),n=document.documentElement?.lang||"fr";if(a){const[,t]=a;e.custom1={name:"fr"===n?"Métal":"Metal",type:"dropdown",options:"copper[+0.00]|silver[+0.00]|electrum[+0.00]|gold[+0.00]|platinum[+0.00]",value:t.value,role:"metal"},i++}if(o){const[,t]=o;e[`custom${i}`]={name:"fr"===n?"Multiplicateur":"Multiplier",type:"dropdown",options:"1|10|100|1000|10000",value:t.value.toString(),role:"multiplier"}}return e}static createLotProductData(t){const{product:e,quantity:i,customFields:a,displayName:o}=t;return{product:{id:e.id,name:o||e.name,summary:e.summary,price:e.price,url:`product.php?id=${encodeURIComponent(e.id)}`},quantity:i,customFields:a||{}}}static translateValue(t,e="fr"){return isNaN(t)?this.translateMetal(t,e):t.toString()}static translateMetal(t,e="fr"){const i=`shop.converter.metals.${t}`,a=this.getTranslation(i);if(a)return a;return{fr:{copper:"cuivre",silver:"argent",electrum:"électrum",gold:"or",platinum:"platine"},en:{copper:"copper",silver:"silver",electrum:"electrum",gold:"gold",platinum:"platinum"}}[e]?.[t]||t}static getCurrentLang(){return document.documentElement.lang||"fr"}static getTranslation(t,e=""){if(window.i18n){const i=t.split(".");let a=window.i18n;for(const t of i){if(!a||"object"!=typeof a||!(t in a))return e;a=a[t]}return"string"==typeof a?a:e}return e}}window.SnipcartUtils=SnipcartUtils;