class SnipcartUtils{static createAddToCartButton(t,e={}){const{quantity:i=1,customFields:o={},className:a="snipcart-add-item btn-cart-icon",text:n="Ajouter au panier",useIconButton:r=!0,...s}=e,c=document.createElement("button");if(c.className=a,r){const t=document.createElement("img");t.src="/media/branding/icons/ajout.webp",t.alt=n,t.className="btn-cart-icon-img",t.loading="lazy",c.appendChild(t),c.setAttribute("aria-label",n),c.setAttribute("title",n)}else c.textContent=n;const l={"data-item-id":t.id,"data-item-name":t.name,"data-item-description":t.summary||t.description||"","data-item-price":t.price.toString(),"data-item-quantity":i.toString()};t.name_en&&(l["data-item-name-en"]=t.name_en),t.summary_en&&(l["data-item-description-en"]=t.summary_en),t.url&&(l["data-item-url"]=t.url),t.image&&(l["data-item-image"]=t.image),Object.entries(l).forEach(([t,e])=>{c.setAttribute(t,e)}),console.log("DEBUG createAddToCartButton - customFields reçus:",o);const u=this.normalizeCustomFields(o);console.log("DEBUG createAddToCartButton - normalizedFields:",u),Object.entries(u).forEach(([t,e])=>{const i=t.replace("custom","");c.setAttribute(`data-item-custom${i}-name`,e.name),c.setAttribute(`data-item-custom${i}-type`,e.type),c.setAttribute(`data-item-custom${i}-options`,e.options),c.setAttribute(`data-item-custom${i}-value`,e.value),e.role&&c.setAttribute(`data-item-custom${i}-role`,e.role)}),Object.entries(s).forEach(([t,e])=>{c.setAttribute(t,e)}),console.log("DEBUG - Attributs du bouton créé:");for(let t of c.attributes)t.name.startsWith("data-item")&&console.log(`  ${t.name} = "${t.value}"`);return c}static playSound(t,e=.5){try{const i=new Audio(t);i.volume=Math.max(0,Math.min(1,e)),i.play().catch(t=>{console.debug("Audio autoplay bloqué:",t)})}catch(t){console.debug("Erreur lecture audio:",t)}}static async addToCart(t,e={}){if(this.playSound("media/sounds/coin-drop.mp3",.5),window.Snipcart&&window.Snipcart.api&&window.Snipcart.api.cart)try{console.log("=== AVANT CRÉATION BOUTON ==="),console.log("productData:",t),console.log("options:",e);const i=this.createAddToCartButton(t,e);console.log("✅ Bouton créé");const o=this.extractProductDataFromButton(i);if(console.log("✅ Données extraites - snipcartData:",o),console.log("=== SNIPCART API DATA ==="),console.log("snipcartData.customFields type:",typeof o.customFields),console.log("snipcartData.customFields isArray:",Array.isArray(o.customFields)),console.log("snipcartData.customFields contenu:",o.customFields),console.log("snipcartData.customFields length:",o.customFields?.length),Array.isArray(o.customFields)&&o.customFields.length>0){const t=document.documentElement?.lang||"fr";o.customFields=o.customFields.map(e=>{const i={name:e.name,value:this.translateValue(e.value,t)};return e.type&&(i.type=e.type),e.options&&"string"==typeof e.options&&(i.options=e.options.split("|").map(e=>{const i=e.split("[")[0];return{name:this.translateValue(i,t)}})),i}),console.log("customFields transformé:",o.customFields)}return await window.Snipcart.api.cart.items.add(o),console.log("✅ Ajouté à Snipcart via API"),!0}catch(t){console.error("❌ ERREUR API SNIPCART:",t),console.log("→ Fallback vers méthode HTML")}const i=this.createAddToCartButton(t,e);return i.style.display="none",document.body.appendChild(i),i.click(),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300),!0}static addFromButton(t,e=null){e&&(e.preventDefault(),e.stopPropagation()),this.playSound("media/sounds/coin-drop.mp3",.5);const i=this.extractProductDataFromButton(t);if(window.Snipcart&&window.Snipcart.api&&window.Snipcart.api.cart)try{return window.Snipcart.api.cart.items.add(i),!0}catch(t){}const o=t.cloneNode(!0);return o.style.display="none",document.body.appendChild(o),setTimeout(()=>{o.click(),document.body.removeChild(o)},10),!0}static extractProductDataFromButton(t){console.log("=== EXTRACTION DEPUIS BOUTON ==="),console.log("Attributs du bouton:");for(let e of t.attributes)e.name.startsWith("data-item")&&console.log(`  ${e.name}: ${e.value}`);const e={id:t.getAttribute("data-item-id"),name:t.getAttribute("data-item-name"),price:parseFloat(t.getAttribute("data-item-price")||"0"),url:t.getAttribute("data-item-url")||window.location.href,quantity:parseInt(t.getAttribute("data-item-quantity")||"1"),description:t.getAttribute("data-item-description")},i=t.getAttribute("data-item-image");i&&(e.image=i),e.customFields=[];for(let i=1;i<=5;i++){const o=t.getAttribute(`data-item-custom${i}-name`),a=t.getAttribute(`data-item-custom${i}-value`),n=t.getAttribute(`data-item-custom${i}-type`),r=t.getAttribute(`data-item-custom${i}-options`);if(o&&a){const t={name:o,value:a};n&&(t.type=n),r&&(t.options=r),e.customFields.push(t)}}return e}static async addMultipleToCart(t,e=null){if(!t||0===t.length)return void(e&&e(0,0));let i=0,o=0;const a=()=>{if(window.Snipcart&&window.Snipcart.api&&window.Snipcart.api.cart)try{return window.Snipcart.api.cart.items.count()||0}catch(t){return 0}return 0};for(let n=0;n<t.length;n++){const r=t[n],s=a();try{if(await this.addToCart(r.product,{quantity:r.quantity,customFields:r.customFields||{}})){let t=0;const e=3;for(;t<e;){await new Promise(t=>setTimeout(t,150));if(a()>s){o++;break}t++}}i++,e&&e(o,t.length,i),n<t.length-1&&await new Promise(t=>setTimeout(t,400))}catch(a){i++,e&&e(o,t.length,i),n<t.length-1&&await new Promise(t=>setTimeout(t,600))}}}static updateCartButton(t,e={}){const{quantity:i,metal:o,multiplier:a,triptych:n,language:r}=e;void 0!==i&&t.setAttribute("data-item-quantity",i.toString()),this.updateCustomFields(t,e)}static updateCustomFields(t,e){const{metal:i,multiplier:o,triptych:a,language:n}=e;if(void 0!==i){const e=this.findCustomFieldByRole(t,"metal");e&&t.setAttribute(`data-item-custom${e}-value`,i)}if(void 0!==o){const e=this.findCustomFieldByRole(t,"multiplier");e&&t.setAttribute(`data-item-custom${e}-value`,o.toString())}if(void 0!==a){const e=this.findCustomFieldByRole(t,"triptych");e&&t.setAttribute(`data-item-custom${e}-value`,a)}if(void 0!==n){const e=this.findCustomFieldByRole(t,"language");e&&t.setAttribute(`data-item-custom${e}-value`,n)}}static findCustomFieldByRole(t,e){const i=Array.from(t.attributes);for(const t of i){const i=t.name.match(/^data-item-custom(\d+)-role$/);if(i&&t.value===e)return i[1]}return null}static normalizeCustomFields(t){const e={};let i=1;if(t.custom1||t.custom2)return t;const o=Object.entries(t).find(([t])=>t.includes("metal")),a=Object.entries(t).find(([t])=>t.includes("multiplier")),n=document.documentElement?.lang||"fr";if(o){const[,t]=o;e.custom1={name:"fr"===n?"Métal":"Metal",type:"dropdown",options:"copper[+0.00]|silver[+0.00]|electrum[+0.00]|gold[+0.00]|platinum[+0.00]",value:t.value,role:"metal"},i++}if(a){const[,t]=a;e[`custom${i}`]={name:"fr"===n?"Multiplicateur":"Multiplier",type:"dropdown",options:"1[+0.00]|10[+10.00]|100[+95.00]|1000[+950.00]|10000[+9500.00]",value:t.value.toString(),role:"multiplier"}}return e}static createLotProductData(t){const{product:e,quantity:i,customFields:o,displayName:a}=t;return{product:{id:e.id,name:a||e.name,summary:e.summary,price:e.price,url:`product.php?id=${encodeURIComponent(e.id)}`},quantity:i,customFields:o||{}}}static translateValue(t,e="fr"){return isNaN(t)?this.translateMetal(t,e):t.toString()}static translateMetal(t,e="fr"){const i=`shop.converter.metals.${t}`,o=this.getTranslation(i);if(o)return o;return{fr:{copper:"cuivre",silver:"argent",electrum:"électrum",gold:"or",platinum:"platine"},en:{copper:"copper",silver:"silver",electrum:"electrum",gold:"gold",platinum:"platinum"}}[e]?.[t]||t}static getCurrentLang(){return document.documentElement.lang||"fr"}static getTranslation(t,e=""){if(window.i18n){const i=t.split(".");let o=window.i18n;for(const t of i){if(!o||"object"!=typeof o||!(t in o))return e;o=o[t]}return"string"==typeof o?o:e}return e}}window.SnipcartUtils=SnipcartUtils;