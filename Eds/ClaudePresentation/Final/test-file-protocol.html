<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Protocole File:// - √âditeur Atomique</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            min-height: 100vh;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.8);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .test-success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .test-error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .test-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .icon { font-size: 24px; }
        h1 { text-align: center; color: #fbbf24; }
        .protocol-info {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Protocole File:// - Architecture Atomique</h1>
        
        <div class="protocol-info">
            <strong>üìç Protocole d√©tect√©:</strong> <span id="protocol-detected"></span><br>
            <strong>üåê URL compl√®te:</strong> <span id="full-url"></span><br>
            <strong>üìÇ R√©pertoire base:</strong> <span id="base-path"></span>
        </div>
        
        <div id="test-results"></div>
        
        <div class="summary" id="test-summary"></div>
    </div>

    <!-- Biblioth√®ques int√©gr√©es (identiques √† index.html) -->
    <script>
        // D√©tection protocole file:// et adaptation
        window.isFileProtocol = window.location.protocol === 'file:';
        
        // Parser Markdown simple int√©gr√© (remplace marked.js)
        window.marked = {
            parse: function(markdown) {
                if (!markdown) return '';
                
                // Conversions Markdown ‚Üí HTML basiques mais fonctionnelles
                let html = markdown
                    // Headers
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    // Formatage
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    // Liens
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                    // Paragraphes
                    .replace(/\n\n/g, '</p><p>')
                    // Listes
                    .replace(/^- (.*$)/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                    // Citations
                    .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
                    
                // Enveloppement paragraphe si n√©cessaire
                if (!html.includes('<h') && !html.includes('<ul') && !html.includes('<blockquote')) {
                    html = '<p>' + html + '</p>';
                }
                
                return html;
            }
        };
        
        // S√©curisation HTML simple (remplace DOMPurify)
        window.DOMPurify = {
            sanitize: function(dirty) {
                if (!dirty) return '';
                
                // Suppression tags dangereux de base
                const cleanHtml = dirty
                    .replace(/<script[^>]*>.*?<\/script>/gi, '')
                    .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
                    .replace(/javascript:/gi, '')
                    .replace(/on\w+="[^"]*"/gi, '')
                    .replace(/on\w+='[^']*'/gi, '');
                    
                return cleanHtml;
            }
        };
        
        // Export simple (remplace JSZip + FileSaver)
        window.saveAs = function(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };
        
        // Helper pour cr√©er blobs
        window.createBlob = function(content, type = 'text/html') {
            return new Blob([content], {type: type});
        };
    </script>

    <!-- Scripts de test d'architecture -->
    <script>
        class FileProtocolTester {
            constructor() {
                this.results = [];
                this.init();
            }

            init() {
                // Info protocole
                document.getElementById('protocol-detected').textContent = window.location.protocol;
                document.getElementById('full-url').textContent = window.location.href;
                document.getElementById('base-path').textContent = window.location.pathname.split('/').slice(0, -1).join('/');

                // Tests
                this.testProtocol();
                this.testLibraries();
                this.testMarkdownParser();
                this.testHTMLSanitizer();
                this.testExportFunctions();
                
                this.displayResults();
                this.generateSummary();
            }

            addResult(test, status, message, details = '') {
                this.results.push({ test, status, message, details });
            }

            testProtocol() {
                if (window.location.protocol === 'file:') {
                    this.addResult('Protocole', 'success', 'Protocole file:// d√©tect√© ‚úÖ', 'Fonctionnement local confirm√©');
                } else {
                    this.addResult('Protocole', 'warning', 'Protocole HTTP/HTTPS', 'Test depuis serveur web');
                }
            }

            testLibraries() {
                // Test biblioth√®ques int√©gr√©es
                const libs = [
                    { name: 'marked', obj: window.marked, method: 'parse' },
                    { name: 'DOMPurify', obj: window.DOMPurify, method: 'sanitize' },
                    { name: 'saveAs', obj: window.saveAs },
                    { name: 'createBlob', obj: window.createBlob }
                ];

                libs.forEach(lib => {
                    if (lib.obj && (typeof lib.obj === 'function' || (lib.method && typeof lib.obj[lib.method] === 'function'))) {
                        this.addResult('Biblioth√®que', 'success', `${lib.name} charg√© ‚úÖ`, 'Fonction disponible');
                    } else {
                        this.addResult('Biblioth√®que', 'error', `${lib.name} manquant ‚ùå`, 'Fonction non disponible');
                    }
                });
            }

            testMarkdownParser() {
                const testMarkdown = '# Test\n\n**Gras** et *italique*\n\n- Liste item';
                try {
                    const result = window.marked.parse(testMarkdown);
                    if (result.includes('<h1>') && result.includes('<strong>') && result.includes('<em>')) {
                        this.addResult('Parser Markdown', 'success', 'Conversion r√©ussie ‚úÖ', result);
                    } else {
                        this.addResult('Parser Markdown', 'warning', 'Conversion partielle ‚ö†Ô∏è', result);
                    }
                } catch (error) {
                    this.addResult('Parser Markdown', 'error', 'Erreur conversion ‚ùå', error.message);
                }
            }

            testHTMLSanitizer() {
                const testHTML = '<p>Texte normal</p><script>alert("danger")</script><strong>Important</strong>';
                try {
                    const result = window.DOMPurify.sanitize(testHTML);
                    if (!result.includes('<script>') && result.includes('<p>') && result.includes('<strong>')) {
                        this.addResult('HTML Sanitizer', 'success', 'S√©curisation r√©ussie ‚úÖ', result);
                    } else {
                        this.addResult('HTML Sanitizer', 'warning', 'S√©curisation partielle ‚ö†Ô∏è', result);
                    }
                } catch (error) {
                    this.addResult('HTML Sanitizer', 'error', 'Erreur s√©curisation ‚ùå', error.message);
                }
            }

            testExportFunctions() {
                try {
                    const testBlob = window.createBlob('<h1>Test</h1>', 'text/html');
                    if (testBlob instanceof Blob) {
                        this.addResult('Export Functions', 'success', 'Cr√©ation blob r√©ussie ‚úÖ', 'Export HTML fonctionnel');
                    }
                } catch (error) {
                    this.addResult('Export Functions', 'error', 'Erreur export ‚ùå', error.message);
                }
            }

            displayResults() {
                const container = document.getElementById('test-results');
                container.innerHTML = '';

                this.results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `test-item test-${result.status}`;
                    
                    const icon = result.status === 'success' ? '‚úÖ' : 
                                result.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';

                    div.innerHTML = `
                        <div class="icon">${icon}</div>
                        <div>
                            <strong>${result.test}:</strong> ${result.message}
                            ${result.details ? `<br><small style="opacity: 0.8;">${result.details}</small>` : ''}
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            }

            generateSummary() {
                const successes = this.results.filter(r => r.status === 'success').length;
                const warnings = this.results.filter(r => r.status === 'warning').length;  
                const errors = this.results.filter(r => r.status === 'error').length;
                const total = this.results.length;

                const summary = document.getElementById('test-summary');
                
                let status = 'üî• Excellent';
                let color = '#4ade80';
                
                if (errors > 0) {
                    status = '‚ùå Probl√®mes d√©tect√©s';
                    color = '#f87171';
                } else if (warnings > 0) {
                    status = '‚ö†Ô∏è Attention requise';
                    color = '#fbbf24';
                }

                summary.innerHTML = `
                    <h3 style="color: ${color}; margin-top: 0;">üéØ R√©sum√©: ${status}</h3>
                    <div style="display: flex; gap: 20px; margin: 15px 0;">
                        <span style="color: #4ade80;">‚úÖ Succ√®s: ${successes}</span>
                        <span style="color: #fbbf24;">‚ö†Ô∏è Avertissements: ${warnings}</span>
                        <span style="color: #f87171;">‚ùå Erreurs: ${errors}</span>
                        <span style="color: #60a5fa;">üìä Total: ${total}</span>
                    </div>
                    
                    ${errors === 0 ? 
                        '<p style="color: #4ade80;"><strong>üöÄ √âditeur pr√™t pour fonctionnement file://</strong></p>' :
                        '<p style="color: #f87171;"><strong>‚ö†Ô∏è Corrections n√©cessaires avant utilisation</strong></p>'
                    }
                `;
            }
        }

        // Lancement des tests au chargement
        document.addEventListener('DOMContentLoaded', () => {
            new FileProtocolTester();
        });
    </script>
</body>
</html>