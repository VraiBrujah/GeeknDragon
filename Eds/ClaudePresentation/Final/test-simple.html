<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Architecture Simplifi√©e</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border: 2px dashed #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>

<body>
    <h1>üß™ Test Architecture BaseWidget + WidgetCanvas</h1>
    
    <div class="test-container">
        <h2>√âtat des Modules :</h2>
        <div id="module-status"></div>
    </div>

    <div class="test-container">
        <h2>Test de Cr√©ation Widget :</h2>
        <div id="widget-test"></div>
    </div>

    <!-- Dependencies int√©gr√©es (z√©ro d√©pendance externe) -->
    <script>
        // Parser Markdown simple int√©gr√© (remplace marked.js)
        window.marked = {
            parse: function(markdown) {
                if (!markdown) return '';
                
                // Conversions Markdown ‚Üí HTML basiques mais fonctionnelles
                let html = markdown
                    // Headers
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    // Formatage
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/__(.*?)__/g, '<strong>$1</strong>')
                    .replace(/_(.*?)_/g, '<em>$1</em>')
                    // Liens
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                    // Citations
                    .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
                    // Code inline
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    // Listes
                    .replace(/^\* (.*)$/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                    // Paragraphes
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/^(.*)$/gm, function(match) {
                        if (match.startsWith('<h') || match.startsWith('<ul') || 
                            match.startsWith('<blockquote') || match.startsWith('<li') ||
                            match.trim() === '') {
                            return match;
                        }
                        return '<p>' + match + '</p>';
                    });
                
                return html;
            }
        };

        // S√©curisation HTML simple (remplace DOMPurify)
        window.DOMPurify = {
            sanitize: function(dirty) {
                if (!dirty) return '';
                
                // Suppression tags dangereux de base
                const cleanHtml = dirty
                    .replace(/<script[^>]*>.*?<\/script>/gi, '')
                    .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
                    .replace(/javascript:/gi, '')
                    .replace(/on\w+="[^"]*"/gi, '')
                    .replace(/on\w+='[^']*'/gi, '');
                
                return cleanHtml;
            }
        };
    </script>

    <!-- Core modules -->
    <script src="js/core/BaseWidget.js"></script>
    <script src="js/widgets/WidgetCanvas.js"></script>

    <script>
        // Test de chargement des modules
        function testModules() {
            const statusDiv = document.getElementById('module-status');
            const tests = [];

            // Test BaseWidget
            if (window.WidgetEditor && window.WidgetEditor.BaseWidget) {
                tests.push('<p class="success">‚úÖ BaseWidget charg√©</p>');
            } else {
                tests.push('<p class="error">‚ùå BaseWidget non trouv√©</p>');
            }

            // Test WidgetCanvas  
            if (window.WidgetEditor && window.WidgetEditor.WidgetCanvas) {
                tests.push('<p class="success">‚úÖ WidgetCanvas charg√©</p>');
            } else {
                tests.push('<p class="error">‚ùå WidgetCanvas non trouv√©</p>');
            }

            // Test marked
            if (typeof marked !== 'undefined') {
                tests.push('<p class="success">‚úÖ Marked.js charg√©</p>');
            } else {
                tests.push('<p class="error">‚ùå Marked.js non trouv√©</p>');
            }

            // Test DOMPurify
            if (typeof DOMPurify !== 'undefined') {
                tests.push('<p class="success">‚úÖ DOMPurify charg√©</p>');
            } else {
                tests.push('<p class="error">‚ùå DOMPurify non trouv√©</p>');
            }

            statusDiv.innerHTML = tests.join('');
        }

        // Test de cr√©ation widget
        function testWidgetCreation() {
            const testDiv = document.getElementById('widget-test');
            
            try {
                if (!window.WidgetEditor || !window.WidgetEditor.WidgetCanvas) {
                    testDiv.innerHTML = '<p class="error">‚ùå WidgetCanvas non disponible</p>';
                    return;
                }

                // Simuler un √©diteur minimal
                const mockEditor = {
                    widgets: new Map(),
                    updatePropertiesPanel: () => {},
                    viewer: { render: () => {} }
                };

                // Cr√©er un WidgetCanvas
                const widget = new window.WidgetEditor.WidgetCanvas(
                    mockEditor,
                    'test-widget-1',
                    {
                        content: '# Test WidgetCanvas\n\nCe widget fonctionne !\n\n**Architecture simplifi√©e :** BaseWidget ‚Üí WidgetCanvas',
                        x: 50,
                        y: 50,
                        width: 400,
                        isMarkdown: true
                    }
                );

                testDiv.innerHTML = `
                    <p class="success">‚úÖ WidgetCanvas cr√©√© avec succ√®s</p>
                    <p class="info">ID: ${widget.id}</p>
                    <p class="info">Type: ${widget.constructor.name}</p>
                    <p class="info">Contenu: ${widget.config.content.substring(0, 50)}...</p>
                `;

                // Ajouter le DOM du widget √† la page pour v√©rification visuelle
                if (widget.element) {
                    testDiv.appendChild(widget.element);
                }

            } catch (error) {
                testDiv.innerHTML = `<p class="error">‚ùå Erreur cr√©ation widget: ${error.message}</p>`;
                console.error('Erreur test widget:', error);
            }
        }

        // Ex√©cuter les tests quand tout est charg√©
        setTimeout(() => {
            testModules();
            testWidgetCreation();
        }, 100);
    </script>
</body>
</html>