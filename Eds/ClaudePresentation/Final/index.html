<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- M√©tadonn√©es optimis√©es pour performance et SEO -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âditeur de Widgets Atomiques | EDS Qu√©bec</title>
    <meta name="description" content="√âditeur WYSIWYG avec architecture universelle - WidgetCanvas et BaseWidget">
    
    <!-- Performance optimisations pour protocole file:// -->
    <link rel="preload" href="css/core.css" as="style">
    <link rel="preload" href="js/core/BaseWidget.js" as="script">
    <link rel="preload" href="js/widgets/WidgetCanvas.js" as="script">
    
    <!-- Polices syst√®me optimis√©es pour file:// -->
    <style>
        /* Police syst√®me universelle - fonctionne partout sans internet */
        :root {
            --font-primary: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        /* Ic√¥nes int√©gr√©es - remplacent Font Awesome */
        .fa, .fas { font-style: normal; font-weight: normal; }
        .fa-puzzle-piece:before { content: 'üß©'; }
        .fa-cog:before { content: '‚öôÔ∏è'; }
        .fa-eye:before { content: 'üëÅ'; }
        .fa-download:before { content: 'üì•'; }
        .fa-save:before { content: 'üíæ'; }
        .fa-undo:before { content: '‚Ü∂'; }
        .fa-redo:before { content: '‚Ü∑'; }
        .fa-search:before { content: 'üîç'; }
        .fa-plus-circle:before { content: '‚äï'; }
        .fa-layer-group:before { content: 'üìã'; }
        .fa-cube:before { content: 'üì¶'; }
        .fa-image:before { content: 'üñº'; }
        .fa-lightbulb:before { content: 'üí°'; }
        .fa-chevron-left:before { content: '‚Äπ'; }
        .fa-chevron-right:before { content: '‚Ä∫'; }
        .fa-chevron-up:before { content: '‚åÑ'; }
        .fa-chevron-down:before { content: '‚åÑ'; }
        .fa-border-all:before { content: '‚ñ¶'; }
        .fa-search-minus:before { content: 'üîç‚àí'; }
        .fa-search-plus:before { content: 'üîç+'; }
        .fa-expand-arrows-alt:before { content: '‚§¢'; }
        .fa-sitemap:before { content: 'üóÇ'; }
        .fa-unlock:before { content: 'üîì'; }
        .fa-sync-alt:before { content: 'üîÑ'; }
        .fa-database:before { content: 'üóÑ'; }
        .fa-history:before { content: 'üìú'; }
        .fa-mouse-pointer:before { content: 'üñ±'; }
        .fa-info-circle:before { content: '‚ÑπÔ∏è'; }
        .fa-clock:before { content: 'üïí'; }
    </style>
    
    <!-- Biblioth√®ques int√©gr√©es pour fonctionnement sans serveur -->
    <script>
        // D√©tection protocole file:// et adaptation
        window.isFileProtocol = window.location.protocol === 'file:';
        
        // Parser Markdown simple int√©gr√© (remplace marked.js)
        window.marked = {
            parse: function(markdown) {
                if (!markdown) return '';
                
                // Conversions Markdown ‚Üí HTML basiques mais fonctionnelles
                let html = markdown
                    // Headers
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    // Formatage
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    // Liens
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                    // Paragraphes
                    .replace(/\n\n/g, '</p><p>')
                    // Listes
                    .replace(/^\- (.*$)/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                    // Citations
                    .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
                    
                // Enveloppement paragraphe si n√©cessaire
                if (!html.includes('<h') && !html.includes('<ul') && !html.includes('<blockquote')) {
                    html = '<p>' + html + '</p>';
                }
                
                return html;
            }
        };
        
        // S√©curisation HTML simple (remplace DOMPurify)
        window.DOMPurify = {
            sanitize: function(dirty) {
                if (!dirty) return '';
                
                // Suppression tags dangereux de base
                const cleanHtml = dirty
                    .replace(/<script[^>]*>.*?<\/script>/gi, '')
                    .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
                    .replace(/javascript:/gi, '')
                    .replace(/on\w+="[^"]*"/gi, '')
                    .replace(/on\w+='[^']*'/gi, '');
                    
                return cleanHtml;
            }
        };
        
        // Export simple (remplace JSZip + FileSaver)
        window.saveAs = function(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };
        
        // Helper pour cr√©er blobs
        window.createBlob = function(content, type = 'text/html') {
            return new Blob([content], {type: type});
        };
        
        console.log('‚úÖ Biblioth√®ques int√©gr√©es charg√©es pour protocole file://');
    </script>
    
    <link rel="stylesheet" href="css/core.css">
    <link rel="stylesheet" href="css/widgets.css">
    <link rel="stylesheet" href="css/atomic-widgets.css">
    <link rel="stylesheet" href="css/themes.css">
</head>

<body class="editor-interface">
    <!-- Container principal de l'√©diteur modulaire -->
    <div class="editor-container" id="editor-container">
        
        <!-- En-t√™te de l'√©diteur avec outils globaux -->
        <header class="editor-header" id="editor-header">
            <!-- Logo et branding EDS Qu√©bec -->
            <div class="header-brand">
                <img src="assets/images/logo-eds-quebec.svg" alt="EDS Qu√©bec" class="brand-logo">
                <div class="brand-info">
                    <h1 class="brand-title">√âditeur Atomique</h1>
                    <span class="brand-subtitle">Architecture Universelle - WidgetCanvas</span>
                </div>
            </div>
            
            <!-- Informations projet et contr√¥les rapides -->
            <div class="project-controls">
                <div class="project-info">
                    <input type="text" id="project-name" class="project-name-input" placeholder="Nom du projet..." value="Mon Projet Marketing">
                    <span class="save-status" id="save-status">
                        <i class="fas fa-save"></i>
                        <span class="save-text">Sauvegard√©</span>
                    </span>
                </div>
                
                <!-- Actions principales -->
                <div class="header-actions">
                    <button class="btn-header" id="btn-undo" title="Annuler (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="btn-header" id="btn-redo" title="R√©tablir (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn-header" id="btn-preview" title="Aper√ßu viewer">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-header" id="btn-export" title="Exporter projet">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Interface principale modulaire -->
        <main class="editor-main" id="editor-main">
            
            <!-- Panneau gauche : Banque de widgets -->
            <aside class="widgets-panel" id="widgets-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <i class="fas fa-puzzle-piece"></i>
                        Banque Widgets
                    </h2>
                    <button class="btn-panel-toggle" id="btn-toggle-widgets" title="Masquer/Afficher">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                
                <!-- Recherche et filtres widgets -->
                <div class="widgets-search">
                    <div class="search-input-container">
                        <input type="text" id="widgets-search" class="search-input" placeholder="Rechercher widgets...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <!-- Filtres par cat√©gorie -->
                    <div class="search-filters">
                        <label class="filter-option">
                            <input type="checkbox" id="filter-all" checked>
                            <span>Tous</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="filter-universal">
                            <span>Universels</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="filter-atomic">
                            <span>Atomiques</span>
                        </label>
                    </div>
                </div>
                
                <!-- Liste des widgets disponibles -->
                <div class="widgets-list" id="widgets-list">
                    
                    <!-- Cat√©gorie Widgets Atomiques -->
                    <div class="widget-category" data-category="atomic">
                        <h3 class="category-title">
                            <i class="fas fa-cube"></i>
                            Widgets Atomiques
                            <span class="category-badge ready">Pr√™t</span>
                        </h3>
                        <div class="category-items">
                            
                            <!-- WidgetCanvas Universel -->
                            <div class="widget-item" draggable="true" data-widget-type="canvas">
                                <div class="widget-icon">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <div class="widget-info">
                                    <span class="widget-name">Widget Canvas</span>
                                    <span class="widget-desc">Contenu universel (texte, images, widgets imbriqu√©s)</span>
                                </div>
                                <div class="widget-actions">
                                    <button class="btn-widget-info" title="Widget universel pour tout type de contenu">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Widgets Futurs -->
                            <div class="widget-item disabled" draggable="false" data-widget-type="image">
                                <div class="widget-icon">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="widget-info">
                                    <span class="widget-name">Widget Image</span>
                                    <span class="widget-desc">Bient√¥t disponible</span>
                                </div>
                                <div class="widget-actions">
                                    <button class="btn-widget-info" title="En cours de d√©veloppement">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Information Architecture Atomique -->
                    <div class="widget-category" data-category="info">
                        <h3 class="category-title">
                            <i class="fas fa-lightbulb"></i>
                            Architecture Atomique
                        </h3>
                        <div class="category-items">
                            <div class="widget-info-box">
                                <i class="fas fa-cube"></i>
                                <p><strong>Widgets sp√©cialis√©s</strong> pour chaque besoin</p>
                                <p>‚Ä¢ <em>WidgetCanvas</em> : Contenu universel (texte, Markdown, HTML, widgets imbriqu√©s)</p>
                                <p>‚Ä¢ <em>BaseWidget</em> : Classe parente avec fonctionnalit√©s communes</p>
                                <p>‚Ä¢ <em>Composition</em> : Widgets imbriqu√©s r√©cursivement</p>
                                <p>‚Ä¢ <em>R√©utilisable</em> : H√©ritage BaseWidget pour simplicit√©</p>
                                <p>‚Ä¢ <em>Export HTML</em> : G√©n√©ration standalone propre</p>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </aside>

            <!-- Zone centrale : Grille d'√©dition -->
            <section class="editor-canvas" id="editor-canvas">
                <div class="canvas-header">
                    <div class="canvas-info">
                        <span class="canvas-title">Grille √âdition</span>
                        <span class="canvas-size">Infinie</span>
                    </div>
                    
                    <!-- Outils de grille -->
                    <div class="canvas-tools">
                        <button class="btn-canvas-tool" id="btn-grid-snap" title="Accrochage grille">
                            <i class="fas fa-border-all"></i>
                        </button>
                        <button class="btn-canvas-tool" id="btn-zoom-out" title="Zoom arri√®re">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <span class="zoom-level" id="zoom-level">100%</span>
                        <button class="btn-canvas-tool" id="btn-zoom-in" title="Zoom avant">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn-canvas-tool" id="btn-zoom-fit" title="Ajuster √† la vue">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Grille infinie de composition -->
                <div class="infinite-grid" id="infinite-grid">
                    <!-- Zone de drop principal -->
                    <div class="drop-zone" id="main-drop-zone">
                        <div class="drop-zone-content">
                            <i class="fas fa-plus-circle"></i>
                            <p class="drop-message">Glissez un widget ici pour commencer</p>
                            <p class="drop-hint">ou double-cliquez pour cr√©er un WidgetCanvas</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Panneau droit : Propri√©t√©s contextuelles -->
            <aside class="properties-panel" id="properties-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <i class="fas fa-cog"></i>
                        Propri√©t√©s
                    </h2>
                    <button class="btn-panel-toggle" id="btn-toggle-properties" title="Masquer/Afficher">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Contenu dynamique des propri√©t√©s -->
                <div class="properties-content" id="properties-content">
                    <div class="no-selection">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>S√©lectionnez un widget pour afficher ses propri√©t√©s</p>
                    </div>
                </div>
            </aside>

        </main>

        <!-- Arborescence hi√©rarchique (style Gimp) -->
        <section class="hierarchy-panel" id="hierarchy-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-sitemap"></i>
                    Structure
                </h2>
                <button class="btn-panel-toggle" id="btn-toggle-hierarchy" title="Masquer/Afficher">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="hierarchy-content" id="hierarchy-content">
                <div class="hierarchy-tree">
                    <div class="tree-item root-item" data-widget-id="root">
                        <div class="tree-item-content">
                            <button class="tree-toggle">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="tree-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <span class="tree-name">Grille Principale</span>
                            <div class="tree-actions">
                                <button class="btn-tree-action" title="Visible">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-tree-action" title="D√©verrouill√©">
                                    <i class="fas fa-unlock"></i>
                                </button>
                            </div>
                        </div>
                        <div class="tree-children" id="hierarchy-root">
                            <!-- Les widgets ajout√©s appara√Ætront ici -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statut et informations syst√®me -->
        <footer class="editor-footer" id="editor-footer">
            <div class="footer-status">
                <span class="status-item">
                    <i class="fas fa-sync-alt"></i>
                    <span id="sync-status">Sync: Actif</span>
                </span>
                <span class="status-item">
                    <i class="fas fa-database"></i>
                    <span id="storage-usage">0 widgets</span>
                </span>
                <span class="status-item">
                    <i class="fas fa-history"></i>
                    <span id="history-count">0 actions</span>
                </span>
            </div>
            
            <div class="footer-info">
                <span class="version-info">Architecture Atomique - Widgets Sp√©cialis√©s</span>
                <span class="build-info">v2.0.0</span>
            </div>
        </footer>

    </div>

    <!-- Scripts de l'application - ARCHITECTURE ATOMIQUE -->
    <!-- 1. BaseWidget d'abord (classe parent) -->
    <script src="js/core/BaseWidget.js"></script>
    
    <!-- 2. Widgets atomiques -->
    <script src="js/widgets/WidgetCanvas.js"></script>
    
    <!-- 3. Modules core essentiels -->
    <script src="js/core/Grid.js"></script>
    <script src="js/core/DragDrop.js"></script>
    <script src="js/core/Persistence.js"></script>
    
    <!-- 4. Editor principal en dernier -->
    <script src="js/core/Editor.js"></script>
    
    <!-- 4. Initialisation optimis√©e avec loading progressif -->
    <script>
        // Optimisation chargement : attendre que tous les scripts soient charg√©s
        let modulesLoaded = false;
        let domReady = false;
        
        // V√©rification p√©riodique des modules atomiques
        function checkModulesReady() {
            if (window.WidgetEditor && 
                window.WidgetEditor.Editor && 
                window.WidgetEditor.BaseWidget && 
                window.WidgetEditor.WidgetCanvas) {
                modulesLoaded = true;
                if (domReady) initializeEditor();
            } else {
                setTimeout(checkModulesReady, 50); // Check toutes les 50ms
            }
        }
        
        // Initialisation d√®s que DOM + modules sont pr√™ts
        function initializeEditor() {
            if (!modulesLoaded || !domReady) return;
            
            try {
                // Affichage loading
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-screen';
                loadingDiv.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: linear-gradient(135deg, #0f172a, #1e293b);
                    display: flex; align-items: center; justify-content: center;
                    z-index: 10000; color: white; font-family: Inter, sans-serif;
                `;
                loadingDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üöÄ</div>
                        <h2>Chargement √âditeur Atomique</h2>
                        <p style="opacity: 0.7;">Initialisation widgets atomiques...</p>
                    </div>
                `;
                document.body.appendChild(loadingDiv);
                
                // Cr√©ation instance √©diteur atomique (async pour UI responsive)
                setTimeout(async () => {
                    window.editor = new window.WidgetEditor.Editor();
                    console.log('üöÄ √âditeur Atomique - D√©marr√©');
                    console.log('‚úÖ WidgetCanvas pr√™t - Double-clic direct!');
                    console.log('‚ö° Architecture: BaseWidget + WidgetCanvas universels');
                    
                    // Suppression √©cran loading avec animation
                    loadingDiv.style.opacity = '0';
                    loadingDiv.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => loadingDiv.remove(), 500);
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Erreur d√©marrage √©diteur:', error);
                
                // Affichage erreur optimis√©
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: #FEE2E2; color: #DC2626; padding: 16px 24px;
                    border: 1px solid #FECACA; border-radius: 8px;
                    font-family: Inter, sans-serif; z-index: 9999;
                    max-width: 500px; text-align: center;
                    box-shadow: 0 10px 25px rgba(220, 38, 38, 0.15);
                `;
                errorDiv.innerHTML = `
                    <strong>‚ùå Erreur initialisation √©diteur</strong><br>
                    <small>${error.message}</small><br>
                    <small style="opacity: 0.7;">V√©rifiez la console pour plus de d√©tails</small>
                `;
                document.body.appendChild(errorDiv);
                
                // Auto-remove apr√®s 15 secondes avec animation
                setTimeout(() => {
                    errorDiv.style.opacity = '0';
                    errorDiv.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => errorDiv.remove(), 500);
                }, 15000);
            }
        }
        
        // Event listeners optimis√©s
        document.addEventListener('DOMContentLoaded', () => {
            domReady = true;
            if (modulesLoaded) initializeEditor();
        });
        
        // D√©marrer v√©rification modules imm√©diatement
        checkModulesReady();
        
        // Performance monitoring
        window.addEventListener('load', () => {
            const loadTime = performance.now();
            console.log(`‚ö° Performance: Chargement complet en ${Math.round(loadTime)}ms`);
        });
    </script>

</body>
</html>