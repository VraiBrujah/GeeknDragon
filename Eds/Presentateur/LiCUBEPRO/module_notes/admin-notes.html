<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration Notes - Module Universel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .warning-banner {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            border-left: 5px solid #fdcb6e;
        }

        .warning-banner h3 {
            color: #e17055;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .warning-banner ul {
            color: #6c5ce7;
            margin-left: 20px;
        }

        .content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(116, 185, 255, 0.3);
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .files-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .files-list h3 {
            color: #2d3436;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .file-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .file-info {
            flex-grow: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 5px;
        }

        .file-meta {
            font-size: 12px;
            color: #636e72;
        }

        .danger-zone {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .danger-zone h3 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }

        .danger-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            color: #2d3436;
        }

        .form-group input:focus {
            outline: none;
            border-color: #74b9ff;
            box-shadow: 0 0 0 3px rgba(116, 185, 255, 0.2);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            box-shadow: 0 4px 15px rgba(209, 48, 49, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(209, 48, 49, 0.4);
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #636e72, #2d3436);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(45, 52, 54, 0.3);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #99d3ff;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00cec9, #00b894);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 206, 201, 0.3);
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 206, 201, 0.4);
        }
    </style>
</head>
<body>
    <button class="refresh-btn" onclick="chargerDonnees()" title="Actualiser les donn√©es">
        üîÑ
    </button>

    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Administration Notes</h1>
            <p>Module Universel - Gestion avanc√©e des notes partag√©es</p>
        </div>

        <div class="warning-banner">
            <h3>‚ö†Ô∏è ZONE D'ADMINISTRATION RESTREINTE</h3>
            <p><strong>Cette page est r√©serv√©e aux administrateurs uniquement.</strong></p>
            <ul>
                <li>Toutes les actions sont <strong>IRR√âVERSIBLES</strong></li>
                <li>La suppression des notes est <strong>D√âFINITIVE</strong></li>
                <li>Les utilisateurs ne peuvent pas acc√©der √† cette page</li>
                <li>Utilisez uniquement si n√©cessaire pour maintenance</li>
            </ul>
        </div>

        <div class="content">
            <!-- Statistiques -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-total-files">-</h3>
                    <p>Fichiers de notes</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-total-notes">-</h3>
                    <p>Notes au total</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-total-size">-</h3>
                    <p>Taille totale (Ko)</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-last-activity">-</h3>
                    <p>Derni√®re activit√©</p>
                </div>
            </div>

            <!-- Liste des fichiers -->
            <div class="files-list">
                <h3>üìÅ Fichiers de notes par page</h3>
                <div id="files-container">
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">Chargement des fichiers...</div>
                            <div class="file-meta">Veuillez patienter</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone de danger - Suppression -->
            <div class="danger-zone">
                <h3>üö® ZONE DE DANGER</h3>
                <p style="text-align: center; margin-bottom: 20px; font-size: 16px;">
                    <strong>ATTENTION :</strong> Cette action supprimera <strong>TOUTES</strong> les notes du projet de mani√®re <strong>D√âFINITIVE</strong>.
                    <br>Il n'y a <strong>AUCUN MOYEN</strong> de r√©cup√©rer les donn√©es apr√®s suppression.
                </p>

                <div class="danger-form">
                    <div class="form-group">
                        <label for="confirmation-text">
                            üìù Pour confirmer la suppression, tapez exactement : <strong>SUPPRIMER</strong>
                        </label>
                        <input 
                            type="text" 
                            id="confirmation-text" 
                            placeholder="Tapez SUPPRIMER (en majuscules)"
                            maxlength="50"
                            autocomplete="off"
                        >
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="confirm-understanding">
                        <label for="confirm-understanding">
                            ‚úÖ Je comprends que cette action est <strong>IRR√âVERSIBLE</strong> et supprimera toutes les notes
                        </label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="confirm-responsibility">
                        <label for="confirm-responsibility">
                            ‚öñÔ∏è J'assume l'enti√®re <strong>RESPONSABILIT√â</strong> de cette suppression
                        </label>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                        <button 
                            id="delete-all-btn" 
                            class="btn btn-danger" 
                            onclick="supprimerToutesLesNotes()"
                            disabled
                        >
                            üóëÔ∏è SUPPRIMER TOUTES LES NOTES
                        </button>
                        
                        <button 
                            class="btn btn-secondary" 
                            onclick="annulerSuppression()"
                        >
                            ‚ùå Annuler
                        </button>
                    </div>

                    <div id="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * =====================================================
         * INTERFACE D'ADMINISTRATION NOTES UNIVERSELLES
         * =====================================================
         */

        const AdminNotes = {
            apiUrl: 'notes-handler.php',
            data: {
                stats: null,
                files: null
            }
        };

        // ========================================
        // INITIALISATION
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõ†Ô∏è Administration Notes - Initialisation');
            
            // Charger les donn√©es
            chargerDonnees();
            
            // Configurer les √©v√©nements
            setupEventListeners();
            
            // V√©rification de s√©curit√©
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' ||
                               window.location.hostname.includes('local');
            
            if (!isLocalhost) {
                console.warn('‚ö†Ô∏è Page d\'administration d√©tect√©e en production');
            }
        });

        function setupEventListeners() {
            // Validation en temps r√©el
            const confirmationInput = document.getElementById('confirmation-text');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const deleteBtn = document.getElementById('delete-all-btn');

            function validerFormulaire() {
                const textCorrect = confirmationInput.value.trim() === 'SUPPRIMER';
                const checkboxesCoches = Array.from(checkboxes).every(cb => cb.checked);
                
                deleteBtn.disabled = !(textCorrect && checkboxesCoches);
                
                // Changer la couleur du bouton selon l'√©tat
                if (deleteBtn.disabled) {
                    deleteBtn.style.opacity = '0.5';
                } else {
                    deleteBtn.style.opacity = '1';
                }
            }

            confirmationInput.addEventListener('input', validerFormulaire);
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', validerFormulaire);
            });

            // Raccourci clavier pour actualiser
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    chargerDonnees();
                }
            });
        }

        // ========================================
        // CHARGEMENT DES DONN√âES
        // ========================================

        async function chargerDonnees() {
            console.log('üîÑ Chargement des donn√©es...');
            
            try {
                // Charger les statistiques
                const statsResponse = await fetch(`${AdminNotes.apiUrl}?action=stats`);
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    AdminNotes.data.stats = statsData.data;
                    afficherStatistiques(statsData.data);
                }

                // Charger la liste des fichiers
                const filesResponse = await fetch(`${AdminNotes.apiUrl}?action=list`);
                const filesData = await filesResponse.json();
                
                if (filesData.success) {
                    AdminNotes.data.files = filesData.data.fichiers;
                    afficherFichiers(filesData.data.fichiers);
                }

                console.log('‚úÖ Donn√©es charg√©es avec succ√®s');

            } catch (error) {
                console.error('‚ùå Erreur chargement donn√©es:', error);
                afficherMessage('Erreur de connexion au serveur', 'error');
            }
        }

        function afficherStatistiques(stats) {
            document.getElementById('stat-total-files').textContent = stats.totalFichiers || 0;
            document.getElementById('stat-total-notes').textContent = stats.totalNotes || 0;
            document.getElementById('stat-total-size').textContent = (stats.tailleTotal || 0) + ' Ko';
            document.getElementById('stat-last-activity').textContent = stats.derniereActivite || 'Aucune';
        }

        function afficherFichiers(fichiers) {
            const container = document.getElementById('files-container');
            
            if (!fichiers || fichiers.length === 0) {
                container.innerHTML = `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">üì≠ Aucun fichier de notes</div>
                            <div class="file-meta">Le syst√®me n'a trouv√© aucune note sauvegard√©e</div>
                        </div>
                    </div>
                `;
                return;
            }

            const fichiersHTML = fichiers.map(fichier => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">üìÑ ${fichier.nom}</div>
                        <div class="file-meta">
                            <strong>${fichier.nombreNotes}</strong> note(s) ‚Ä¢ 
                            <strong>${fichier.tailleKo} Ko</strong> ‚Ä¢ 
                            Modifi√©: <strong>${fichier.derniereModification}</strong>
                            ${fichier.urlExtraite ? `<br>üåê ${fichier.urlExtraite}` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = fichiersHTML;
        }

        // ========================================
        // SUPPRESSION DES NOTES
        // ========================================

        async function supprimerToutesLesNotes() {
            const confirmationText = document.getElementById('confirmation-text').value.trim();
            
            // Double v√©rification
            if (confirmationText !== 'SUPPRIMER') {
                alert('‚ùå Vous devez taper exactement "SUPPRIMER" pour confirmer.');
                return;
            }

            // Confirmation finale
            const confirmationFinale = confirm(
                'üö® DERNI√àRE CONFIRMATION\n\n' +
                'Vous √™tes sur le point de SUPPRIMER D√âFINITIVEMENT toutes les notes du projet.\n\n' +
                '‚ö†Ô∏è Cette action est IRR√âVERSIBLE !\n' +
                '‚ö†Ô∏è Toutes les donn√©es seront PERDUES !\n\n' +
                '√ätes-vous ABSOLUMENT S√õR de vouloir continuer ?'
            );

            if (!confirmationFinale) {
                return;
            }

            // Interface de chargement
            afficherMessage('üîÑ Suppression en cours... Veuillez patienter', 'loading');
            const deleteBtn = document.getElementById('delete-all-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'üîÑ Suppression en cours...';

            try {
                // Supprimer tous les fichiers un par un
                const fichiers = AdminNotes.data.files || [];
                let fichiersSupprimes = 0;
                let erreurs = [];

                for (const fichier of fichiers) {
                    try {
                        const response = await fetch(AdminNotes.apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `action=delete&fichier=${encodeURIComponent(fichier.nom)}`
                        });

                        const result = await response.json();
                        if (result.success) {
                            fichiersSupprimes++;
                        } else {
                            erreurs.push(`${fichier.nom}: ${result.error}`);
                        }
                    } catch (error) {
                        erreurs.push(`${fichier.nom}: ${error.message}`);
                    }
                }

                // R√©sultats
                if (erreurs.length === 0) {
                    afficherMessage(
                        `‚úÖ SUPPRESSION TERMIN√âE\n\n` +
                        `${fichiersSupprimes} fichier(s) supprim√©(s) avec succ√®s.\n` +
                        `Toutes les notes ont √©t√© d√©finitivement supprim√©es.`,
                        'success'
                    );
                } else {
                    afficherMessage(
                        `‚ö†Ô∏è SUPPRESSION PARTIELLE\n\n` +
                        `${fichiersSupprimes} fichier(s) supprim√©(s)\n` +
                        `${erreurs.length} erreur(s) rencontr√©e(s):\n\n` +
                        erreurs.join('\n'),
                        'error'
                    );
                }

                // R√©initialiser le formulaire
                annulerSuppression();
                
                // Recharger les donn√©es
                setTimeout(() => {
                    chargerDonnees();
                }, 2000);

            } catch (error) {
                console.error('‚ùå Erreur suppression:', error);
                afficherMessage(
                    `‚ùå ERREUR CRITIQUE\n\n` +
                    `Erreur lors de la suppression: ${error.message}\n` +
                    `Certaines notes peuvent encore exister.`,
                    'error'
                );
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'üóëÔ∏è SUPPRIMER TOUTES LES NOTES';
            }
        }

        function annulerSuppression() {
            // R√©initialiser le formulaire
            document.getElementById('confirmation-text').value = '';
            document.getElementById('confirm-understanding').checked = false;
            document.getElementById('confirm-responsibility').checked = false;
            document.getElementById('delete-all-btn').disabled = true;
            
            // Effacer le message de statut
            document.getElementById('status-message').innerHTML = '';
            
            console.log('‚ùå Suppression annul√©e par l\'utilisateur');
        }

        function afficherMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            
            // Auto-masquage pour les messages de succ√®s
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 10000);
            }
        }

        // ========================================
        // FONCTIONS UTILITAIRES
        // ========================================

        // Emp√™cher la fermeture accidentelle pendant suppression
        window.addEventListener('beforeunload', function(e) {
            const deleteBtn = document.getElementById('delete-all-btn');
            if (deleteBtn && deleteBtn.disabled && deleteBtn.textContent.includes('en cours')) {
                e.preventDefault();
                e.returnValue = 'Une suppression est en cours. √ätes-vous s√ªr de vouloir quitter ?';
            }
        });

        // Log de s√©curit√©
        console.log(`
üõ†Ô∏è ADMINISTRATION NOTES UNIVERSELLES
====================================
Version: 1.0
Page: ${window.location.href}
Heure: ${new Date().toLocaleString()}
====================================
‚ö†Ô∏è  ACC√àS ADMINISTRATEUR D√âTECT√â
‚ö†Ô∏è  Toutes les actions sont logg√©es
====================================
        `);
    </script>

    <!-- Note sur l'impl√©mentation -->
    <!--
    NOTES D'IMPL√âMENTATION :
    
    1. Cette page doit √™tre renomm√©e avec un nom non-√©vident en production
       (ex: admin-secret-xyz.html)
    
    2. L'action 'delete' doit √™tre ajout√©e au PHP notes-handler.php
    
    3. Consid√©rer l'ajout d'une authentification par mot de passe
    
    4. Optionnel: configurer le serveur pour restreindre l'acc√®s √† cette page
       (ex: .htaccess avec restriction IP)
    
    5. En production, s'assurer que cette page n'est pas index√©e par les moteurs
    -->
</body>
</html>