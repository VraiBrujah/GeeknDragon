#!/usr/bin/env node

/**
 * Script de test du convertisseur de monnaie
 * Valide que le convertisseur fonctionne correctement apr√®s optimisations
 */

const fs = require('fs');
const path = require('path');

class CurrencyConverterTester {
    constructor() {
        this.projectRoot = path.join(__dirname, '..');
        this.results = {
            tests: [],
            passed: 0,
            failed: 0
        };
    }

    /**
     * Lance tous les tests de validation
     */
    async runTests() {
        console.log('üß™ Tests du Convertisseur de Monnaie\n');

        this.testFileExistence();
        this.testBundleContent();
        this.testPageIntegration();
        this.testScriptLoader();

        this.displayResults();
        return this.results.failed === 0;
    }

    /**
     * Test l'existence des fichiers n√©cessaires
     */
    testFileExistence() {
        const requiredFiles = [
            'js/app.bundle.min.js',
            'js/currency-converter.js', // fallback
            'js/coin-lot-optimizer.js', // fallback
            'includes/script-loader.php',
            'aide-jeux.php'
        ];

        requiredFiles.forEach(file => {
            const filePath = path.join(this.projectRoot, file);
            const exists = fs.existsSync(filePath);
            
            this.addTest(
                `Fichier ${file} existe`,
                exists,
                exists ? `‚úÖ ${file} trouv√©` : `‚ùå ${file} manquant`
            );
        });
    }

    /**
     * Test le contenu du bundle
     */
    testBundleContent() {
        const bundlePath = path.join(this.projectRoot, 'js', 'app.bundle.min.js');
        
        if (!fs.existsSync(bundlePath)) {
            this.addTest('Bundle disponible', false, '‚ùå Bundle non trouv√©');
            return;
        }

        const bundleContent = fs.readFileSync(bundlePath, 'utf8');
        
        const requiredClasses = [
            'CurrencyConverterPremium',
            'CoinLotOptimizer'
        ];

        const requiredMethods = [
            'findMinimalCoins',
            'updateFromSources',
            'getCurrentValues'
        ];

        const requiredSelectors = [
            'currency-converter-premium',
            'currency-best'
        ];

        requiredClasses.forEach(className => {
            const found = bundleContent.includes(className);
            this.addTest(
                `Classe ${className} dans bundle`,
                found,
                found ? `‚úÖ ${className} pr√©sent` : `‚ùå ${className} manquant`
            );
        });

        requiredMethods.forEach(method => {
            const found = bundleContent.includes(method);
            this.addTest(
                `M√©thode ${method} dans bundle`,
                found,
                found ? `‚úÖ ${method} pr√©sent` : `‚ùå ${method} manquant`
            );
        });

        requiredSelectors.forEach(selector => {
            const found = bundleContent.includes(selector);
            this.addTest(
                `S√©lecteur ${selector} dans bundle`,
                found,
                found ? `‚úÖ ${selector} pr√©sent` : `‚ùå ${selector} manquant`
            );
        });

        // Test de la taille du bundle
        const bundleSize = bundleContent.length;
        const expectedMinSize = 50000; // 50KB minimum
        const hasReasonableSize = bundleSize > expectedMinSize;
        
        this.addTest(
            'Taille bundle raisonnable',
            hasReasonableSize,
            hasReasonableSize ? 
                `‚úÖ Bundle: ${Math.round(bundleSize/1024)}KB` : 
                `‚ùå Bundle trop petit: ${Math.round(bundleSize/1024)}KB`
        );
    }

    /**
     * Test l'int√©gration dans aide-jeux.php
     */
    testPageIntegration() {
        const pagePath = path.join(this.projectRoot, 'aide-jeux.php');
        
        if (!fs.existsSync(pagePath)) {
            this.addTest('Page aide-jeux.php existe', false, '‚ùå Page non trouv√©e');
            return;
        }

        const pageContent = fs.readFileSync(pagePath, 'utf8');

        // Test pr√©sence du container
        const hasContainer = pageContent.includes('id="currency-converter-premium"');
        this.addTest(
            'Container convertisseur pr√©sent',
            hasContainer,
            hasContainer ? '‚úÖ Container trouv√©' : '‚ùå Container manquant'
        );

        // Test utilisation du script-loader
        const usesScriptLoader = pageContent.includes('script-loader.php');
        this.addTest(
            'Utilise script-loader optimis√©',
            usesScriptLoader,
            usesScriptLoader ? '‚úÖ Script-loader utilis√©' : '‚ùå Script-loader non utilis√©'
        );

        // Test pr√©sence de l'initialisation forc√©e
        const hasForcedInit = pageContent.includes('INITIALISATION FORC√âE DU CONVERTISSEUR');
        this.addTest(
            'Initialisation forc√©e pr√©sente',
            hasForcedInit,
            hasForcedInit ? '‚úÖ Initialisation forc√©e ajout√©e' : '‚ùå Initialisation forc√©e manquante'
        );

        // Test pr√©sence des donn√©es produits
        const hasProductsData = pageContent.includes('window.products');
        this.addTest(
            'Donn√©es produits expos√©es',
            hasProductsData,
            hasProductsData ? '‚úÖ window.products trouv√©' : '‚ùå window.products manquant'
        );
    }

    /**
     * Test le script-loader
     */
    testScriptLoader() {
        const loaderPath = path.join(this.projectRoot, 'includes', 'script-loader.php');
        
        if (!fs.existsSync(loaderPath)) {
            this.addTest('Script-loader existe', false, '‚ùå Script-loader non trouv√©');
            return;
        }

        const loaderContent = fs.readFileSync(loaderPath, 'utf8');

        const requiredFunctions = [
            'class ScriptLoader',
            'loadMainBundle',
            'loadGameHelpScripts',
            'function load_optimized_scripts'
        ];

        requiredFunctions.forEach(func => {
            const found = loaderContent.includes(func);
            this.addTest(
                `Script-loader: ${func}`,
                found,
                found ? `‚úÖ ${func} pr√©sent` : `‚ùå ${func} manquant`
            );
        });

        // Test de la logique d'aide-jeux
        const hasGameHelpLogic = loaderContent.includes('aide-jeux') && 
                                 loaderContent.includes('currency-converter');
        this.addTest(
            'Logic aide-jeux dans script-loader',
            hasGameHelpLogic,
            hasGameHelpLogic ? '‚úÖ Logic aide-jeux pr√©sente' : '‚ùå Logic aide-jeux manquante'
        );
    }

    /**
     * Ajoute un r√©sultat de test
     */
    addTest(name, passed, message) {
        this.results.tests.push({ name, passed, message });
        if (passed) {
            this.results.passed++;
        } else {
            this.results.failed++;
        }
    }

    /**
     * Affiche les r√©sultats des tests
     */
    displayResults() {
        console.log('\nüìä R√âSULTATS DES TESTS');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

        // Grouper par cat√©gorie
        const categories = {
            'Fichiers': [],
            'Bundle': [],
            'Page': [],
            'Script-loader': []
        };

        this.results.tests.forEach(test => {
            if (test.name.includes('Fichier')) {
                categories['Fichiers'].push(test);
            } else if (test.name.includes('bundle') || test.name.includes('Bundle') || 
                      test.name.includes('Classe') || test.name.includes('M√©thode') || 
                      test.name.includes('S√©lecteur') || test.name.includes('Taille')) {
                categories['Bundle'].push(test);
            } else if (test.name.includes('Container') || test.name.includes('Page') || 
                      test.name.includes('Initialisation') || test.name.includes('Donn√©es')) {
                categories['Page'].push(test);
            } else {
                categories['Script-loader'].push(test);
            }
        });

        Object.entries(categories).forEach(([category, tests]) => {
            if (tests.length > 0) {
                console.log(`\nüîç ${category}:`);
                tests.forEach(test => {
                    console.log(`  ${test.message}`);
                });
            }
        });

        // R√©sum√©
        const total = this.results.passed + this.results.failed;
        const successRate = ((this.results.passed / total) * 100).toFixed(1);

        console.log('\nüìà R√âSUM√â:');
        console.log(`   ‚úÖ R√©ussis: ${this.results.passed}`);
        console.log(`   ‚ùå √âchou√©s: ${this.results.failed}`);
        console.log(`   üìä Taux de r√©ussite: ${successRate}%`);

        if (this.results.failed === 0) {
            console.log('\nüéØ ‚úÖ TOUS LES TESTS R√âUSSIS ! Le convertisseur devrait fonctionner.');
        } else {
            console.log('\nüéØ ‚ùå CERTAINS TESTS ONT √âCHOU√â. V√©rifier les probl√®mes identifi√©s.');
        }

        // Suggestions d'am√©lioration
        if (this.results.failed > 0) {
            console.log('\nüí° SUGGESTIONS:');
            this.results.tests.filter(t => !t.passed).forEach(test => {
                if (test.name.includes('Bundle')) {
                    console.log('   ‚Ä¢ Ex√©cuter: npm run compress');
                } else if (test.name.includes('Script-loader')) {
                    console.log('   ‚Ä¢ V√©rifier le script includes/script-loader.php');
                } else if (test.name.includes('Container')) {
                    console.log('   ‚Ä¢ V√©rifier l\'HTML du convertisseur dans aide-jeux.php');
                }
            });
        }
    }
}

// Ex√©cution si appel√© directement
if (require.main === module) {
    const tester = new CurrencyConverterTester();
    tester.runTests().then(success => {
        process.exit(success ? 0 : 1);
    }).catch(error => {
        console.error('Erreur pendant les tests:', error);
        process.exit(1);
    });
}

module.exports = CurrencyConverterTester;