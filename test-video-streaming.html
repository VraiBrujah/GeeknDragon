<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test du Streaming Vidéo Optimisé</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container { 
            margin: 20px 0; 
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        video { 
            width: 100%; 
            max-width: 600px; 
            height: auto;
            border-radius: 4px;
        }
        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #ff9800; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
    </style>
</head>
<body>
    <h1>🎬 Test du Streaming Vidéo Optimisé</h1>
    <p>Ce test vérifie que les corrections pour les erreurs HTTP/2 de streaming vidéo fonctionnent correctement.</p>
    
    <div class="test-grid">
        <!-- Test 1: URL directe (ancien système) -->
        <div class="test-container">
            <h3>Test 1: URL Directe (Ancien)</h3>
            <video id="video-direct" controls muted>
                <source src="/media/videos/backgrounds/fontaine4_compressed.mp4" type="video/mp4">
            </video>
            <div class="log" id="log-direct"></div>
            <button onclick="testVideo('video-direct', 'log-direct')">▶️ Tester</button>
            <button onclick="clearLog('log-direct')">🗑️ Vider Log</button>
        </div>

        <!-- Test 2: URL via stream-video.php (nouveau système) -->
        <div class="test-container">
            <h3>Test 2: Streaming Optimisé (Nouveau)</h3>
            <video id="video-stream" controls muted>
                <source src="/stream-video.php?file=media/videos/backgrounds/fontaine4_compressed.mp4" type="video/mp4">
            </video>
            <div class="log" id="log-stream"></div>
            <button onclick="testVideo('video-stream', 'log-stream')">▶️ Tester</button>
            <button onclick="clearLog('log-stream')">🗑️ Vider Log</button>
        </div>

        <!-- Test 3: Hero Videos (système complet) -->
        <div class="test-container">
            <h3>Test 3: Hero Videos (Intégré)</h3>
            <div class="hero-videos" style="height: 300px; position: relative; overflow: hidden; border-radius: 8px;"
                 data-main="/media/videos/backgrounds/mage_compressed.mp4" 
                 data-videos='["/media/videos/backgrounds/fontaine11_compressed.mp4","/media/videos/backgrounds/fontaine4_compressed.mp4"]'>
            </div>
            <div class="log" id="log-hero"></div>
            <button onclick="clearLog('log-hero')">🗑️ Vider Log</button>
        </div>

        <!-- Test 4: Test de charge (plusieurs vidéos) -->
        <div class="test-container">
            <h3>Test 4: Test de Charge</h3>
            <div id="load-test-container"></div>
            <div class="log" id="log-load"></div>
            <button onclick="runLoadTest()">🔥 Test de Charge</button>
            <button onclick="stopLoadTest()">⏹️ Arrêter Test</button>
            <button onclick="clearLog('log-load')">🗑️ Vider Log</button>
        </div>
    </div>

    <div class="test-container">
        <h3>📊 Résumé des Tests</h3>
        <div class="log" id="summary-log"></div>
        <button onclick="runAllTests()">🚀 Lancer Tous les Tests</button>
        <button onclick="clearAllLogs()">🗑️ Tout Vider</button>
    </div>

    <script src="/js/hero-videos.js"></script>
    <script>
        // Fonction utilitaires de log
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLog(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function clearAllLogs() {
            const logs = ['log-direct', 'log-stream', 'log-hero', 'log-load', 'summary-log'];
            logs.forEach(clearLog);
        }

        // Test d'une vidéo spécifique
        function testVideo(videoId, logId) {
            const video = document.getElementById(videoId);
            const startTime = Date.now();
            
            log(logId, `Début du test pour ${videoId}`, 'info');
            
            // Événements de monitoring
            const events = [
                'loadstart', 'durationchange', 'loadedmetadata', 
                'loadeddata', 'progress', 'canplay', 'canplaythrough',
                'playing', 'pause', 'ended', 'error', 'stalled', 'waiting'
            ];
            
            events.forEach(eventType => {
                video.addEventListener(eventType, () => {
                    const elapsed = Date.now() - startTime;
                    log(logId, `${eventType.toUpperCase()} après ${elapsed}ms`, 'success');
                }, { once: true });
            });

            // Gestion spéciale des erreurs
            video.addEventListener('error', (e) => {
                const elapsed = Date.now() - startTime;
                const error = video.error;
                log(logId, `ERREUR après ${elapsed}ms: Code ${error?.code} - ${error?.message || 'Erreur inconnue'}`, 'error');
                log('summary-log', `❌ ${videoId} - Échec après ${elapsed}ms`, 'error');
            }, { once: true });

            // Succès de lecture
            video.addEventListener('canplaythrough', () => {
                const elapsed = Date.now() - startTime;
                log(logId, `✅ Prêt à lire après ${elapsed}ms`, 'success');
                log('summary-log', `✅ ${videoId} - Succès en ${elapsed}ms`, 'success');
            }, { once: true });

            // Démarrer le test
            video.currentTime = 0;
            video.load();
            
            // Timeout de sécurité
            setTimeout(() => {
                if (video.readyState < 3) {
                    log(logId, '⚠️ Timeout - Vidéo non prête après 10s', 'warning');
                    log('summary-log', `⚠️ ${videoId} - Timeout après 10s`, 'warning');
                }
            }, 10000);
        }

        // Test de charge
        let loadTestVideos = [];
        function runLoadTest() {
            log('log-load', 'Démarrage du test de charge...', 'info');
            const container = document.getElementById('load-test-container');
            const videos = [
                '/media/videos/backgrounds/fontaine4_compressed.mp4',
                '/media/videos/backgrounds/fontaine11_compressed.mp4',
                '/media/videos/backgrounds/cascade_HD_compressed.mp4',
                '/media/videos/backgrounds/Carte1_compressed.mp4',
                '/media/videos/backgrounds/mage_compressed.mp4'
            ];

            stopLoadTest(); // Nettoyer d'abord

            videos.forEach((src, index) => {
                const video = document.createElement('video');
                video.controls = true;
                video.muted = true;
                video.style.width = '100%';
                video.style.maxWidth = '200px';
                video.style.margin = '5px';
                
                // Utiliser le système optimisé
                video.src = `/stream-video.php?file=${encodeURIComponent(src)}`;
                
                video.addEventListener('loadeddata', () => {
                    log('log-load', `Vidéo ${index + 1} chargée`, 'success');
                });
                
                video.addEventListener('error', () => {
                    log('log-load', `Erreur vidéo ${index + 1}`, 'error');
                });

                container.appendChild(video);
                loadTestVideos.push(video);
            });

            log('log-load', `${videos.length} vidéos en cours de chargement...`, 'info');
        }

        function stopLoadTest() {
            const container = document.getElementById('load-test-container');
            container.innerHTML = '';
            loadTestVideos = [];
            log('log-load', 'Test de charge arrêté', 'info');
        }

        // Test complet
        function runAllTests() {
            log('summary-log', '🚀 Début des tests automatiques', 'info');
            clearAllLogs();
            
            setTimeout(() => testVideo('video-direct', 'log-direct'), 500);
            setTimeout(() => testVideo('video-stream', 'log-stream'), 2000);
            setTimeout(() => runLoadTest(), 4000);
        }

        // Monitoring global des erreurs réseau
        window.addEventListener('error', (e) => {
            if (e.filename && e.filename.includes('.mp4')) {
                log('summary-log', `🚨 Erreur réseau détectée: ${e.message}`, 'error');
            }
        });

        // Logging pour les hero videos
        document.addEventListener('DOMContentLoaded', () => {
            // Observer les changements dans le conteneur hero
            const heroContainer = document.querySelector('.hero-videos');
            if (heroContainer) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.tagName === 'VIDEO') {
                                log('log-hero', `Nouvelle vidéo hero ajoutée: ${node.src}`, 'info');
                                
                                node.addEventListener('error', () => {
                                    log('log-hero', `Erreur vidéo hero: ${node.src}`, 'error');
                                });
                                
                                node.addEventListener('loadeddata', () => {
                                    log('log-hero', `Vidéo hero chargée: ${node.src}`, 'success');
                                });
                            }
                        });
                    });
                });
                
                observer.observe(heroContainer, { childList: true });
            }
        });

        // Rapport initial
        log('summary-log', '📋 Test du streaming vidéo optimisé initialisé', 'info');
        log('summary-log', '🎯 Objectif: Éliminer les erreurs ERR_CONNECTION_CLOSED et ERR_HTTP2_SERVER_REFUSED_STREAM', 'info');
    </script>
</body>
</html>