<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Affichage Stock</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-product {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            position: relative;
        }
        .test-product[data-stock-status="loaded"] {
            border-color: #4CAF50;
        }
        .test-product.oos {
            opacity: 0.6;
            border-color: #f44336;
        }
        .stock-unavailable-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            color: #f44336;
            font-size: 20px;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test SystÃ¨me de Stock</h1>

    <button onclick="testStock()">ğŸ”„ Tester le stock</button>
    <button onclick="clearCache()">ğŸ—‘ï¸ Vider le cache</button>

    <h2>Produits Test</h2>

    <div class="test-product" data-product-id="triptych-mystery-hero">
        <h3>Triptyques MystÃ¨res (Stock = 0)</h3>
        <p>Ce produit devrait afficher l'overlay "Rupture de stock"</p>
        <button data-i18n="product.add">Ajouter au panier</button>
        <div class="stock-unavailable-overlay">
            ğŸ˜ Rupture de stock
        </div>
    </div>

    <div class="test-product" data-product-id="coin-merchant-essence-double">
        <h3>Essence du Marchand (Stock = 50)</h3>
        <p>Ce produit devrait Ãªtre disponible</p>
        <button data-i18n="product.add">Ajouter au panier</button>
        <div class="stock-unavailable-overlay">
            ğŸ˜ Rupture de stock
        </div>
    </div>

    <div class="test-product" data-product-id="cards-adventurer-arsenal-190">
        <h3>Arsenal de l'Aventurier (Stock = 100)</h3>
        <p>Ce produit devrait Ãªtre disponible</p>
        <button data-i18n="product.add">Ajouter au panier</button>
        <div class="stock-unavailable-overlay">
            ğŸ˜ Rupture de stock
        </div>
    </div>

    <h2>ğŸ“Š Logs</h2>
    <div id="log">En attente de test...</div>

    <script src="/js/async-stock-loader.js"></script>
    <script>
        const log = document.getElementById('log');

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearCache() {
            let cleared = 0;
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.startsWith('stock_')) {
                    localStorage.removeItem(key);
                    cleared++;
                }
            }
            addLog(`âœ… ${cleared} entrÃ©es de cache supprimÃ©es`);
        }

        function testStock() {
            log.textContent = '';
            addLog('ğŸ”„ DÃ©marrage du test...');

            if (!window.asyncStockLoader) {
                addLog('âŒ asyncStockLoader non trouvÃ© !');
                return;
            }

            addLog('âœ… asyncStockLoader trouvÃ©');

            // Vider le cache pour forcer un appel API
            clearCache();

            // Initialiser le chargement
            addLog('ğŸ“¡ Appel initAutoLoad()...');
            window.asyncStockLoader.initAutoLoad();

            // VÃ©rifier aprÃ¨s 3 secondes
            setTimeout(() => {
                addLog('\nğŸ“Š RÃ©sultats aprÃ¨s 3 secondes :');

                document.querySelectorAll('[data-product-id]').forEach(card => {
                    const id = card.getAttribute('data-product-id');
                    const status = card.getAttribute('data-stock-status');
                    const overlay = card.querySelector('.stock-unavailable-overlay');
                    const button = card.querySelector('button');

                    addLog(`\nğŸ“¦ ${id}:`);
                    addLog(`   Status: ${status}`);
                    addLog(`   Overlay visible: ${overlay && overlay.style.display === 'flex' ? 'OUI' : 'NON'}`);
                    addLog(`   Bouton dÃ©sactivÃ©: ${button && button.disabled ? 'OUI' : 'NON'}`);
                    addLog(`   Classe .oos: ${card.classList.contains('oos') ? 'OUI' : 'NON'}`);
                });

                // Afficher les mÃ©triques
                const metrics = window.asyncStockLoader.getMetrics();
                addLog(`\nğŸ“ˆ MÃ©triques:`);
                addLog(`   Total requÃªtes: ${metrics.totalRequests}`);
                addLog(`   Total produits: ${metrics.totalProducts}`);
                addLog(`   Temps moyen: ${metrics.averageResponseTime.toFixed(2)}ms`);
            }, 3000);
        }

        // Auto-test au chargement
        addLog('âœ… Page chargÃ©e');
        addLog('Cliquez sur "Tester le stock" pour lancer le test');
    </script>
</body>
</html>
