# Audit technique Geek & Dragon – février 2025

## Résumé exécutif
- **Forces** : la configuration sensible est entièrement externalisée dans `config.php`, ce qui facilite la séparation des secrets et des environnements déploiement.【F:config.php†L1-L61】 Le formulaire de contact applique une validation défensive (CSRF, longueurs, anti header injection) et journalise les erreurs côté serveur.【F:contact-handler.php†L24-L199】
- **Risques prioritaires** : plusieurs filtres PHP dépréciés (`FILTER_SANITIZE_STRING`) subsistent dans le bootstrap ; ils déclencheront des avertissements en PHP 8.3+ et casseront la détection automatique du schéma si la directive est supprimée.【F:bootstrap.php†L84-L138】 Le script Snipcart neutralise `console.log`/`console.warn` globalement, ce qui empêche de diagnostiquer les parcours d’achat et masque aussi les erreurs provenant d’autres bibliothèques.【F:snipcart-init.php†L200-L223】

## Points forts
- **Gestion de configuration soignée** – Toutes les clés SMTP/Snipcart sont récupérées via `getEnvironmentVariable()` avec valeurs de repli maîtrisées, ce qui évite d’exposer des secrets dans le dépôt et simplifie la configuration par environnement.【F:config.php†L24-L61】
- **Protection du formulaire de contact** – Le handler applique des filtres stricts, compare les tokens CSRF avec `hash_equals` et journalise les tentatives invalides, limitant les risques d’injection et de rejet silencieux des messages clients.【F:contact-handler.php†L33-L199】

## Points de vigilance & recommandations
### 1. Compatibilité future PHP
- **Constat** : `gd_detect_request_scheme()` continue d’utiliser `FILTER_SANITIZE_STRING`, retiré en PHP 8.3, pour nettoyer les en-têtes proxy (`HTTP_X_FORWARDED_PROTO`, `HTTPS`, etc.).【F:bootstrap.php†L96-L138】
- **Impact** : dès une montée de version PHP, vous aurez des avertissements (ou des erreurs fatales si `filter.default` est strict), ce qui peut casser la génération d’URL absolues et tout Snipcart (`data-item-url`).
- **Actions proposées** : remplacer ces filtres par `FILTER_UNSAFE_RAW` + `preg_replace` ciblé ou une whitelist (`in_array($proto, ['http','https'], true)`). Profitez-en pour consolider un test unitaire autour de `gd_build_absolute_url()`.

### 2. Observabilité Snipcart & support
- **Constat** : le bootstrap Snipcart remplace globalement `console.log` et `console.warn` pour ignorer tout message contenant « snipcart » ou « gtag ».【F:snipcart-init.php†L200-L223】
- **Impact** : en production, impossible de diagnostiquer les erreurs Stripe/Snipcart ; en développement, l’équipe perd des signaux utiles (ex. webhooks échoués). Cela peut aussi supprimer des avertissements d’autres scripts mentionnant ces mots-clés.
- **Actions proposées** : ne neutraliser ces logs qu’en production et uniquement après consentement analytics, ou filtrer via `if (!window.DEBUG_MODE)`/`if (!location.hostname.endsWith('.prod'))`. Conserver un canal de remontée (Sentry, `console.error`) pour les incidents critiques.

### 3. Lisibilité des e-mails & remontée d’erreurs
- **Constat** : `sendSendgridMail()` échappe tous les champs avec `htmlspecialchars` avant d’appeler l’API JSON de SendGrid.【F:contact-handler.php†L142-L157】 Les retours d’erreur `curl_error()` / corps de réponse ne sont pas exploités.【F:contact-handler.php†L159-L172】
- **Impact** : les accents et apostrophes arrivent encodés (`&eacute;`) chez le destinataire, ce qui nuit à la lecture. En cas d’échec SMTP, aucun détail n’est renvoyé aux logs, compliquant le support.
- **Actions proposées** : transmettre les valeurs brutes (SendGrid s’attend à du JSON UTF‑8 déjà sécurisé) et enregistrer `curl_error` + réponse HTTP dans `contact_errors.log`. Ajouter un monitoring (ex. statut HTTP >=400).

### 4. Chargement des assets
- **Constat** : `head-common.php` appelle `filemtime()` à chaque requête pour sept feuilles de style et les mêmes fichiers sont parfois demandés plusieurs fois (ex. `vendor.bundle.min.css` en preload puis link immédiat).【F:head-common.php†L77-L124】 De plus, `index.php` réinjecte `shop-grid.css` via `$extraHead`, créant un doublon avec le `<link>` standard.【F:index.php†L12-L38】【F:head-common.php†L91-L92】
- **Impact** : multiplication de `stat()` sur disque, temps CPU, et double téléchargement côté navigateur (le second `<link>` n’apporte que du cache revalidation).
- **Actions proposées** : mettre en cache les timestamps (`$version = file_exists(...) ? filemtime(...) : time()`), mutualiser `vendor.bundle.min.css` dans un helper qui renvoie à la fois `preload` + `stylesheet`, et supprimer la surcharge `$extraHead` devenue inutile.

### 5. Détection navigateur via `eval`
- **Constat** : la bannière d’incompatibilité exécute plusieurs `eval()` pour tester les fonctionnalités modernes.【F:includes/browser-compatibility-check.php†L40-L148】
- **Impact** : `eval` est bloqué par de nombreuses Content Security Policy strictes et ralentit l’exécution initiale. Le script est injecté avant tout le reste, donc un navigateur exotique peut se retrouver avec une page vide si une erreur est levée par la CSP.
- **Actions proposées** : remplacer `eval` par des tests de présence (`if (!('optionalChaining' in parser))` n’existe pas, mais vous pouvez utiliser `try { new Function('return a?.b;'); }` ou, mieux, charger un bundle de polyfills/`core-js` conditionnel via `<script nomodule>`). Pensez aussi à isoler le message dans un composant accessible (`role="alert"`).

## Actions rapides suggérées (30 jours)
1. Refactoriser `gd_detect_request_scheme()` et `gd_build_absolute_url()` pour supprimer `FILTER_SANITIZE_STRING` et couvrir le comportement via tests automatisés.
2. Réintroduire les logs Snipcart conditionnellement (flag `DEBUG_MODE` ou environnement) et consigner les erreurs critiques vers un logger serveur.
3. Mettre à jour `sendSendgridMail()` pour envoyer le corps UTF‑8 brut et journaliser la réponse HTTP détaillée en cas d’échec.
4. Mutualiser la construction des URLs de styles (`filemtime`) afin de limiter les doublons et éviter le second `<link>` `shop-grid.css` sur la page d’accueil.

## Pistes moyen terme (60‑90 jours)
- Ajouter des tests end-to-end (Playwright/Cypress) couvrant un parcours d’achat Snipcart pour détecter les régressions de scripts tiers.
- Introduire un pipeline d’audit automatisé (`npm run audit:security`, `composer audit`) exécuté à chaque déploiement pour garder les dépendances à jour.
- Factoriser le code front (ex. composant hero, actus) dans un moteur de templates ou un builder statique pour réduire la duplication lorsque de nouvelles pages seront ajoutées.
