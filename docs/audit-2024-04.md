# Audit du site Geek & Dragon

## Résumé exécutif
- **Compatibilité serveur fragile** : plusieurs filtres PHP dépréciés provoquent des erreurs fatales avec PHP 8.3, ce qui bloque toute montée de version.
- **Robustesse front-end perfectible** : le chargement conditionnel des feuilles de style et des vidéos ne gère pas les fichiers manquants ni les terminaux contraints, créant des avertissements PHP et des coûts réseau inutiles.
- **Conformité cookies à compléter** : certains scripts déposent des cookies essentiels sans attributs de sécurité modernes, ce qui peut inquiéter les navigateurs et les auditeurs RGPD.

## Analyse détaillée

### 1. Compatibilité PHP (sévérité : élevée)
`bootstrap.php` s'appuie sur `FILTER_SANITIZE_STRING` pour assainir les en-têtes détectant le schéma HTTP. Ce filtre est déprécié depuis PHP 8.1 et a été supprimé en PHP 8.3 : toute migration vers une version à jour lèvera une `Error` au premier chargement de la page. 【F:bootstrap.php†L98-L125】

**Recommandation**
- Remplacer ces appels par `filter_var(..., FILTER_UNSAFE_RAW, FILTER_FLAG_STRIP_LOW | FILTER_FLAG_STRIP_HIGH)` ou par une validation explicite (regex/`in_array`) qui reste compatible PHP 8.3 et supprime la dépendance à des filtres obsolètes.

### 2. Gestion des assets CSS (sévérité : moyenne)
Les inclusions de feuilles de style utilisent `filemtime()` directement (`head-common.php`, `index.php`). Lorsque le fichier ciblé n'est pas présent sur l'environnement (ex. déploiement incrémental, build CSS échouée), PHP émet un avertissement et retourne un en-tête HTML cassé, ce qui casse les tests d'intégration continus. 【F:head-common.php†L77-L92】【F:index.php†L12-L38】

**Recommandation**
- Encapsuler l'accès disque dans un helper (`asset_version('css/styles.css')`) qui vérifie `file_exists()` et retourne un suffixe neutre (`?v=0`) en cas d'absence, tout en journalisant l'erreur.

### 3. Poids du héros vidéo (sévérité : moyenne)
La section d'accueil charge un carrousel vidéo avec une source principale et huit alternatives pré-déclarées. Même avec `preload="metadata"`, chaque ressource déclenche un aller-retour HTTP et un décodage partiel dès le chargement initial, ce qui alourdit la première visite (jusqu'à plusieurs mégaoctets sur mobile). 【F:index.php†L35-L66】【F:js/hero-videos.js†L15-L198】

**Recommandation**
- Réduire la liste aux deux meilleures vidéos ou basculer vers des images statiques sur les points de rupture mobiles (`matchMedia('(pointer: coarse)')`).
- Ajouter une compression supplémentaire (WebM/H.265) et une détection de bande passante pour différer les variantes lourdes.

### 4. Cookies essentiels sans attributs (sévérité : moyenne)
`js/app.js` fixe les cookies `lang` et `snipcartLanguage` via `document.cookie = ...` sans `SameSite` ni `Secure`. Les navigateurs récents marquent désormais ces cookies comme `SameSite=Lax` implicite, mais l'absence explicite peut déclencher des alertes d'audit (Chrome Lighthouse) et des rejets en contexte hybride HTTP/HTTPS. 【F:js/app.js†L149-L176】

**Recommandation**
- Étendre `setCookie` pour ajouter `;SameSite=Lax` (ou `Strict` si compatible) et `;Secure` lorsque `location.protocol === 'https:'`.
- Documenter ces cookies comme « essentiels » dans la CMP pour préserver la conformité.

## Points forts observés
- L'interface d'administration force des cookies de session `Secure`/`HttpOnly`/`SameSite=Strict`, regénère l'ID après authentification et protège toutes les actions par token CSRF. 【F:admin-products.php†L10-L77】
- Le gestionnaire de contact applique une validation stricte (longueur, caractères de contrôle, CSRF) avant d'appeler SendGrid, réduisant les vecteurs d'injection. 【F:contact-handler.php†L33-L178】

## Prochaines étapes proposées
1. Planifier la refactorisation des filtres PHP avant la prochaine montée de version serveur.
2. Introduire un helper d'assets tolérant aux fichiers manquants et ajouter un test automatisé qui vérifie l'absence d'avertissements PHP.
3. Mesurer l'impact réseau du carrousel vidéo (WebPageTest/Lighthouse) puis réduire le nombre de sources servies par défaut.
4. Mettre à jour `setCookie` et la documentation CMP pour expliciter les attributs de sécurité appliqués aux cookies essentiels.
