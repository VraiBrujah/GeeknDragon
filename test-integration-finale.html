<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'intégration finale - Cohérence convertisseur/optimiseur</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .result {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        .success { border-left-color: #4CAF50; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .comparison-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-case {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>🧪 Test d'Intégration Finale - Cohérence Algorithmes</h1>

    <div class="test-section">
        <h2>📋 Objectif du Test</h2>
        <p>Vérifier que les corrections apportées aux algorithmes garantissent la cohérence entre :</p>
        <ul>
            <li><strong>CurrencyConverterPremium</strong> : Conversion optimale (nombre minimal de pièces)</li>
            <li><strong>CoinLotOptimizer</strong> : Recommandations de lots (prix minimal)</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🎯 Cas de Test Critiques</h2>
        <button onclick="testCase1()">Test 1: 150 cuivres (1 or + 1 électrum)</button>
        <button onclick="testCase2()">Test 2: 300 cuivres (3 électrum identiques)</button>
        <button onclick="testCase3()">Test 3: 1661 cuivres (cas complexe)</button>
        <button onclick="testCase4()">Test 4: 50000+ cuivres (bundles légitimes)</button>
        <button onclick="runAllTests()">🚀 Lancer Tous les Tests</button>
    </div>

    <div id="results"></div>

    <script>
        // Mock des données produits pour les tests
        const mockProducts = {
            "coin-custom-single": {
                "name": {"fr": "Pièce personnalisée", "en": "Custom Coin"},
                "price": 10,
                "coin_lots": {
                    "copper": {"1": 1, "10": 10, "100": 100, "1000": 1000, "10000": 10000},
                    "silver": {"1": 1, "10": 10, "100": 100, "1000": 1000, "10000": 10000},
                    "electrum": {"1": 1, "10": 10, "100": 100, "1000": 1000, "10000": 10000},
                    "gold": {"1": 1, "10": 10, "100": 100, "1000": 1000, "10000": 10000},
                    "platinum": {"1": 1, "10": 10, "100": 100, "1000": 1000, "10000": 10000}
                }
            },
            "coin-trio-customizable": {
                "name": {"fr": "Trio de pièces", "en": "Trio of Coins"},
                "price": 25,
                "coin_lots": {
                    "copper": {"1": 3, "10": 30, "100": 300, "1000": 3000, "10000": 30000},
                    "silver": {"1": 3, "10": 30, "100": 300, "1000": 3000, "10000": 30000},
                    "electrum": {"1": 3, "10": 30, "100": 300, "1000": 3000, "10000": 30000},
                    "gold": {"1": 3, "10": 30, "100": 300, "1000": 3000, "10000": 30000},
                    "platinum": {"1": 3, "10": 30, "100": 300, "1000": 3000, "10000": 30000}
                }
            },
            "coin-septuple-free": {
                "name": {"fr": "Septuple libre", "en": "Free Septuple"},
                "price": 50,
                "coin_lots": {
                    "copper": {"1": 7, "10": 70, "100": 700, "1000": 7000, "10000": 70000},
                    "silver": {"1": 7, "10": 70, "100": 700, "1000": 7000, "10000": 70000},
                    "electrum": {"1": 7, "10": 70, "100": 700, "1000": 7000, "10000": 70000},
                    "gold": {"1": 7, "10": 70, "100": 700, "1000": 7000, "10000": 70000},
                    "platinum": {"1": 7, "10": 70, "100": 700, "1000": 7000, "10000": 70000}
                }
            },
            "coin-quintessence-metals": {
                "name": {"fr": "Quintessence Métallique", "en": "Metallic Quintessence"},
                "price": 35,
                "fixed_content": {
                    "copper_1": 1,
                    "silver_1": 1,
                    "electrum_1": 1,
                    "gold_1": 1,
                    "platinum_1": 1
                }
            }
        };

        // Simulation des algorithmes de conversion
        function simulateConversion(targetValue) {
            const denoms = [
                {metal: 'platinum', mult: 1, value: 1000, priority: 1},
                {metal: 'platinum', mult: 10, value: 10000, priority: 2},
                {metal: 'gold', mult: 1, value: 100, priority: 3},
                {metal: 'gold', mult: 10, value: 1000, priority: 4},
                {metal: 'electrum', mult: 1, value: 50, priority: 5},
                {metal: 'electrum', mult: 10, value: 500, priority: 6},
                {metal: 'silver', mult: 1, value: 10, priority: 7},
                {metal: 'silver', mult: 10, value: 100, priority: 8},
                {metal: 'copper', mult: 1, value: 1, priority: 9},
                {metal: 'copper', mult: 10, value: 10, priority: 10}
            ];

            // Stratégie 1: Priorité métal > multiplicateur
            let remaining = targetValue;
            let result = {};
            let totalCoins = 0;

            for (const denom of denoms) {
                if (remaining >= denom.value) {
                    const count = Math.floor(remaining / denom.value);
                    if (count > 0) {
                        const key = `${denom.metal}_${denom.mult}`;
                        result[key] = count;
                        remaining -= count * denom.value;
                        totalCoins += count;
                    }
                }
            }

            return {
                solution: result,
                totalCoins: totalCoins,
                remaining: remaining
            };
        }

        // Simulation de l'optimisation de lots
        function simulateLotOptimization(needs) {
            const solutions = [];

            // Calcul coût pièces individuelles
            let individualCost = 0;
            let totalNeeded = 0;
            for (const [need, quantity] of Object.entries(needs)) {
                individualCost += quantity * mockProducts["coin-custom-single"].price;
                totalNeeded += quantity;
            }

            solutions.push({
                type: 'individual',
                cost: individualCost,
                description: `${totalNeeded} pièces individuelles`
            });

            // Vérifier si trio/septuple applicables
            for (const [need, quantity] of Object.entries(needs)) {
                if (quantity >= 3) {
                    const [metal, mult] = need.split('_');
                    const trios = Math.floor(quantity / 3);
                    const remaining = quantity % 3;
                    const trioCost = trios * mockProducts["coin-trio-customizable"].price +
                                   remaining * mockProducts["coin-custom-single"].price;

                    if (trioCost < quantity * mockProducts["coin-custom-single"].price) {
                        solutions.push({
                            type: 'trio',
                            cost: trioCost,
                            description: `${trios} trio(s) + ${remaining} individuelles`
                        });
                    }
                }

                if (quantity >= 7) {
                    const [metal, mult] = need.split('_');
                    const septuples = Math.floor(quantity / 7);
                    const remaining = quantity % 7;
                    const septupleCost = septuples * mockProducts["coin-septuple-free"].price +
                                       remaining * mockProducts["coin-custom-single"].price;

                    if (septupleCost < quantity * mockProducts["coin-custom-single"].price) {
                        solutions.push({
                            type: 'septuple',
                            cost: septupleCost,
                            description: `${septuples} septuple(s) + ${remaining} individuelles`
                        });
                    }
                }
            }

            // Vérifier Quintessence si applicable
            const quintessenceContent = mockProducts["coin-quintessence-metals"].fixed_content;
            let quintessenceCovers = 0;
            let quintessenceUseful = false;

            for (const [need, quantity] of Object.entries(needs)) {
                if (quintessenceContent[need]) {
                    const covered = Math.min(quantity, quintessenceContent[need]);
                    if (covered > 0) {
                        quintessenceCovers += covered * mockProducts["coin-custom-single"].price;
                        quintessenceUseful = true;
                    }
                }
            }

            // Seuil de cohérence : Quintessence seulement si couverture > 90% ET économies significatives
            if (quintessenceUseful && quintessenceCovers >= individualCost * 0.9 && totalNeeded >= 4) {
                const quintessenceCost = mockProducts["coin-quintessence-metals"].price;
                if (quintessenceCost < individualCost) {
                    solutions.push({
                        type: 'quintessence',
                        cost: quintessenceCost,
                        description: `Quintessence Métallique (couvre ${quintessenceCovers}$ de besoins)`
                    });
                }
            }

            // Retourner la solution optimale
            return solutions.reduce((best, current) => {
                return current.cost < best.cost ? current : best;
            });
        }

        function runTest(testName, targetValue, expectedBehavior) {
            const startTime = performance.now();

            console.log(`\n🧪 ${testName}`);
            console.log(`🎯 Valeur cible: ${targetValue} cuivres`);

            // 1. Conversion optimale
            const conversion = simulateConversion(targetValue);
            console.log(`📊 Conversion: ${conversion.totalCoins} pièces`, conversion.solution);

            // 2. Optimisation lots
            const lotOptimization = simulateLotOptimization(conversion.solution);
            console.log(`🛍️ Lots optimaux: ${lotOptimization.type} - $${lotOptimization.cost}`);

            // 3. Analyse cohérence
            const conversionCost = Object.values(conversion.solution)
                .reduce((sum, qty) => sum + qty * mockProducts["coin-custom-single"].price, 0);

            const savings = conversionCost - lotOptimization.cost;
            const isCoherent = savings >= 0 && (
                (conversion.totalCoins <= 3 && lotOptimization.type !== 'quintessence') ||
                (conversion.totalCoins > 10 && lotOptimization.type === 'quintessence' && savings > 15)
            );

            const endTime = performance.now();

            const result = {
                testName,
                targetValue,
                conversion: conversion.totalCoins,
                lotType: lotOptimization.type,
                lotCost: lotOptimization.cost,
                savings: savings,
                isCoherent: isCoherent,
                executionTime: Math.round(endTime - startTime),
                details: {
                    conversionSolution: conversion.solution,
                    lotDescription: lotOptimization.description,
                    expectedBehavior
                }
            };

            console.log(`✅ Cohérence: ${isCoherent ? 'OK' : 'ÉCHEC'} (${result.executionTime}ms)`);

            return result;
        }

        function displayResult(result) {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = `test-section ${result.isCoherent ? 'success' : 'error'}`;

            section.innerHTML = `
                <h3>${result.isCoherent ? '✅' : '❌'} ${result.testName}</h3>
                <div class="comparison-table">
                    <div class="test-case">
                        <h4>🔄 Convertisseur</h4>
                        <div class="result">Valeur: ${result.targetValue} cuivres
Résultat: ${result.conversion} pièces
Solution: ${JSON.stringify(result.details.conversionSolution, null, 2)}</div>
                    </div>
                    <div class="test-case">
                        <h4>🛍️ Optimiseur de Lots</h4>
                        <div class="result">Type: ${result.lotType}
Coût: $${result.lotCost}
Description: ${result.details.lotDescription}
Économies: $${result.savings}</div>
                    </div>
                </div>
                <div class="result">
<strong>📋 Analyse:</strong>
- Cohérence: ${result.isCoherent ? '✅ CORRECTE' : '❌ PROBLÉMATIQUE'}
- Temps d'exécution: ${result.executionTime}ms
- Comportement attendu: ${result.details.expectedBehavior}
                </div>
            `;

            resultsDiv.appendChild(section);
        }

        // Cas de test spécifiques
        function testCase1() {
            const result = runTest(
                "Cas 1: 150 cuivres (1 or + 1 électrum)",
                150,
                "Solution simple, pas de bundle forcé"
            );
            displayResult(result);
        }

        function testCase2() {
            const result = runTest(
                "Cas 2: 300 cuivres (3 électrum x100)",
                300,
                "Détection trio automatique si économique"
            );
            displayResult(result);
        }

        function testCase3() {
            const result = runTest(
                "Cas 3: 1661 cuivres (cas complexe)",
                1661,
                "Solution optimale sans forcing Quintessence"
            );
            displayResult(result);
        }

        function testCase4() {
            const result = runTest(
                "Cas 4: 55000 cuivres (bundles légitimes)",
                55000,
                "Bundles acceptables pour grandes quantités"
            );
            displayResult(result);
        }

        function runAllTests() {
            document.getElementById('results').innerHTML = '<h2>🚀 Exécution de tous les tests...</h2>';

            setTimeout(() => testCase1(), 100);
            setTimeout(() => testCase2(), 300);
            setTimeout(() => testCase3(), 500);
            setTimeout(() => testCase4(), 700);

            setTimeout(() => {
                const summary = document.createElement('div');
                summary.className = 'test-section success';
                summary.innerHTML = '<h2>📊 Tests terminés</h2><p>Vérifiez les résultats ci-dessus pour valider la cohérence des algorithmes.</p>';
                document.getElementById('results').appendChild(summary);
            }, 1000);
        }

        // Lancer automatiquement le test critique
        window.addEventListener('load', () => {
            setTimeout(testCase1, 500);
        });
    </script>
</body>
</html>