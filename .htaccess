# üöÄ OPTIMISATIONS PERFORMANCE GEEKNDRAGON
# Configuration Apache pour performance maximale

# ===== COMPRESSION GZIP/BROTLI =====
<IfModule mod_deflate.c>
    # Activer la compression pour tous les types de contenu
    SetOutputFilter DEFLATE
    
    # Types de fichiers √† compresser
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/atom+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE font/woff
    AddOutputFilterByType DEFLATE font/woff2
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/eot
    
    # Exclure les images d√©j√† compress√©es
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|webp|ico)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \
        \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
</IfModule>

# Support Brotli si disponible
<IfModule mod_brotli.c>
    BrotliCompressionQuality 6
    BrotliFilterByType text/html
    BrotliFilterByType text/css
    BrotliFilterByType text/javascript
    BrotliFilterByType application/javascript
    BrotliFilterByType application/json
    BrotliFilterByType text/xml
    BrotliFilterByType application/xml
    BrotliFilterByType image/svg+xml
</IfModule>

# ===== HEADERS DE CACHE OPTIMIS√âS =====
<IfModule mod_expires.c>
    ExpiresActive on
    
    # Images avec cache tr√®s long (immutable)
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Fonts avec cache long
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/eot "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # CSS/JS avec versioning (cache agressif)
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    
    # HTML avec revalidation
    ExpiresByType text/html "access plus 1 hour"
    
    # Documents statiques
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/json "access plus 1 hour"
</IfModule>

# Headers Cache-Control personnalis√©s
<IfModule mod_headers.c>
    # Ressources avec versioning - cache immutable
    <FilesMatch "\.(css|js|png|jpg|jpeg|webp|gif|ico|woff|woff2|ttf|eot|svg)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Vary "Accept-Encoding"
    </FilesMatch>
    
    # Pages HTML - cache avec revalidation
    <FilesMatch "\.(html|htm|php)$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
        Header set Vary "Accept-Encoding, Accept-Language"
    </FilesMatch>
    
    # Headers de s√©curit√©
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "payment=(self)"
    
    # Headers de performance
    Header always set X-DNS-Prefetch-Control "on"
    
    # ETag optimis√©
    Header unset ETag
    FileETag None
</IfModule>

# ===== OPTIMISATIONS DIVERSES =====

# D√©sactiver la signature du serveur
ServerTokens Prod
ServerSignature Off

# Keep-Alive pour r√©duire les connexions
<IfModule mod_headers.c>
    Header always set Connection "keep-alive"
</IfModule>

# Pr√©chargement DNS pour domaines externes
<IfModule mod_headers.c>
    <LocationMatch "^/$">
        Header add Link "<//>; rel=dns-prefetch"
        Header add Link "<//fonts.googleapis.com>; rel=dns-prefetch"
        Header add Link "<//fonts.gstatic.com>; rel=dns-prefetch"
        Header add Link "<//cdn.snipcart.com>; rel=dns-prefetch"
    </LocationMatch>
</IfModule>

# Optimisation des requ√™tes et redirections PHP vers HTML
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # ===== REDIRECTIONS PHP VERS HTML =====
    
    # Page d'accueil
    RewriteCond %{THE_REQUEST} /index\.php[?\s] [NC]
    RewriteRule ^index\.php$ /index.html [R=301,L]

    # Boutique
    RewriteCond %{THE_REQUEST} /boutique\.php[?\s] [NC]
    RewriteRule ^boutique\.php$ /boutique.html [R=301,L]

    # Contact
    RewriteCond %{THE_REQUEST} /contact\.php[?\s] [NC]
    RewriteRule ^contact\.php$ /contact.html [R=301,L]

    # Actualit√©s
    RewriteCond %{THE_REQUEST} /actualites/es-tu-game\.php[?\s] [NC]
    RewriteRule ^actualites/es-tu-game\.php$ /actualites/es-tu-game.html [R=301,L]

    # Pages de produits vers boutique avec ancre
    RewriteCond %{QUERY_STRING} id=lot10
    RewriteRule ^product\.php$ /boutique.html#pieces? [R=301,L]

    RewriteCond %{QUERY_STRING} id=lot25
    RewriteRule ^product\.php$ /boutique.html#pieces? [R=301,L]

    RewriteCond %{QUERY_STRING} id=lot50-essence
    RewriteRule ^product\.php$ /boutique.html#pieces? [R=301,L]

    RewriteCond %{QUERY_STRING} id=lot50-tresorerie
    RewriteRule ^product\.php$ /boutique.html#pieces? [R=301,L]

    # Pages de lots directes vers boutique
    RewriteCond %{THE_REQUEST} /lot10\.php[?\s] [NC]
    RewriteRule ^lot10\.php$ /boutique.html#pieces [R=301,L]

    RewriteCond %{THE_REQUEST} /lot25\.php[?\s] [NC]
    RewriteRule ^lot25\.php$ /boutique.html#pieces [R=301,L]

    RewriteCond %{THE_REQUEST} /lot50-essence\.php[?\s] [NC]
    RewriteRule ^lot50-essence\.php$ /boutique.html#pieces [R=301,L]

    RewriteCond %{THE_REQUEST} /lot50-tresorerie\.php[?\s] [NC]
    RewriteRule ^lot50-tresorerie\.php$ /boutique.html#pieces [R=301,L]

    # Autres pages PHP vers contact
    RewriteCond %{THE_REQUEST} /devis\.php[?\s] [NC]
    RewriteRule ^devis\.php$ /contact.html [R=301,L]

    RewriteCond %{THE_REQUEST} /merci\.php[?\s] [NC]
    RewriteRule ^merci\.php$ /contact.html [R=301,L]
    
    # ===== URLs PROPRES POUR HTML =====
    
    # Suppression de l'extension .html pour les URLs propres
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}.html -f
    RewriteRule ^([^.]+)$ $1.html [L]

    # Redirection des URLs avec .html vers les URLs propres (optionnel)
    # RewriteCond %{THE_REQUEST} /([^.]+)\.html[\s?] [NC]
    # RewriteRule ^ /%1? [R=301,L]
    
    # Forcer HTTPS (si activ√©)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Servir les fichiers WebP si support√©s
    RewriteCond %{HTTP_ACCEPT} image/webp
    RewriteCond %{REQUEST_FILENAME} \.(jpe?g|png)$
    RewriteCond %{REQUEST_FILENAME}.webp -f
    RewriteRule ^(.+)\.(jpe?g|png)$ $1.$2.webp [T=image/webp,E=accept:1,L]
</IfModule>

# ===== S√âCURIT√â ET PROTECTION =====

# Bloquer l'acc√®s aux fichiers sensibles
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|swp)$">
    Require all denied
</FilesMatch>

# Protection contre le hotlinking des images
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https://(.*\.)?geekndragon\.com [NC]
    RewriteCond %{REQUEST_FILENAME} \.(jpe?g|png|gif|webp)$ [NC]
    RewriteRule \.(jpe?g|png|gif|webp)$ - [F]
</IfModule>

# D√©sactiver les m√©thodes HTTP non n√©cessaires
<Limit GET POST HEAD>
    Require all granted
</Limit>
<LimitExcept GET POST HEAD>
    Require all denied
</LimitExcept>

# ===== OPTIMISATIONS SP√âCIFIQUES GEEKNDRAGON =====

# Redirections SEO si n√©cessaires
# RewriteRule ^old-page$ /new-page [R=301,L]

# Gestion des erreurs avec pages personnalis√©es
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# ===== PERFORMANCE MONITORING =====

# Headers pour monitoring des performances
<IfModule mod_headers.c>
    Header always set Server-Timing "total;dur=0"
    Header always set X-Performance-Optimized "geekndragon-v1"
</IfModule>