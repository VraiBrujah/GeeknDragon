<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Algorithme Recommandation</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #060; }
        pre { background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Debug Algorithme de Recommandation</h1>
    
    <div id="debug-output"></div>
    
    <script>
        function debugLog(message, data = null) {
            const debugDiv = document.getElementById('debug-output');
            const logDiv = document.createElement('div');
            logDiv.className = 'debug';
            
            let content = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            if (data) {
                content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            logDiv.innerHTML = content;
            debugDiv.appendChild(logDiv);
        }
        
        // Charger les produits
        debugLog('Chargement des produits...');
        
        fetch('/data/products.json')
            .then(response => response.json())
            .then(products => {
                window.products = products;
                debugLog('Produits chargés', {
                    total: Object.keys(products).length,
                    coinProducts: Object.keys(products).filter(id => id.startsWith('coin-')),
                    quintessence: products['coin-quintessence-metals'] ? 'Trouvé' : 'Manquant'
                });
                
                // Vérifier la Quintessence Métallique
                if (products['coin-quintessence-metals']) {
                    debugLog('Quintessence Métallique:', products['coin-quintessence-metals']);
                }
                
                // Charger et tester l'algorithme
                loadAndTestAlgorithm();
            })
            .catch(error => {
                debugLog('ERREUR chargement produits:', error);
            });
        
        function loadAndTestAlgorithm() {
            // Charger le script
            const script = document.createElement('script');
            script.src = '/js/coin-lot-recommender.js';
            script.onload = () => {
                debugLog('Script coin-lot-recommender.js chargé');
                
                if (window.CoinLotRecommender) {
                    debugLog('Classe CoinLotRecommender disponible');
                    testAlgorithm();
                } else {
                    debugLog('ERREUR: CoinLotRecommender non disponible', null);
                }
            };
            script.onerror = () => {
                debugLog('ERREUR: Impossible de charger coin-lot-recommender.js', null);
            };
            document.head.appendChild(script);
        }
        
        function testAlgorithm() {
            try {
                const recommender = new window.CoinLotRecommender();
                recommender.debugMode = true;
                
                // Test cas critique: 5 métaux × 1
                const needs = {
                    "copper_1": 1,
                    "silver_1": 1,
                    "electrum_1": 1,
                    "gold_1": 1,
                    "platinum_1": 1
                };
                
                debugLog('Test besoins:', needs);
                
                const result = recommender.findOptimalLotCombination(needs);
                
                debugLog('Résultat algorithme:', result);
                
                if (result && result.length > 0) {
                    const totalCost = result.reduce((sum, item) => sum + item.totalCost, 0);
                    const products = result.map(item => item.displayName);
                    
                    debugLog('Analyse résultat:', {
                        produits: products,
                        coutTotal: totalCost,
                        attendu: 'Quintessence Métallique pour 35$',
                        succes: totalCost <= 35 && products.some(p => p.includes('Quintessence'))
                    });
                } else {
                    debugLog('ERREUR: Aucun résultat retourné', null);
                }
                
            } catch (error) {
                debugLog('ERREUR test algorithme:', error);
            }
        }
    </script>
</body>
</html>