<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation Finale Cache Dynamique</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .header { text-align: center; margin-bottom: 30px; }
        .test-suite { margin: 20px 0; padding: 20px; border-radius: 10px; }
        .suite-1 { background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; }
        .suite-2 { background: linear-gradient(45deg, #2196F3, #03A9F4); color: white; }
        .suite-3 { background: linear-gradient(45deg, #FF9800, #FFC107); color: white; }
        .validation-item { background: rgba(255,255,255,0.2); margin: 10px 0; padding: 15px; border-radius: 8px; }
        .status { font-weight: bold; font-size: 1.2em; }
        .success { color: #4CAF50; }
        .pending { color: #FF9800; }
        .error { color: #F44336; }
        .final-report { background: #2c3e50; color: white; padding: 25px; border-radius: 15px; margin: 30px 0; text-align: center; }
        .button-group { text-align: center; margin: 20px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #0056b3; transform: translateY(-2px); transition: all 0.3s; }
        .metric { display: inline-block; margin: 0 20px; }
        .big-number { font-size: 2em; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Validation Finale Cache Dynamique</h1>
            <p>Tests exhaustifs du syst√®me de cache du calculateur D&D</p>
        </div>

        <div class="test-suite suite-1">
            <h2>‚úÖ Suite 1: Tests Cache Basiques</h2>
            <div class="validation-item">
                <div><strong>Cache Miss Initial:</strong> <span id="test1Status" class="status pending">‚è≥ En attente</span></div>
                <div>V√©rification calcul dynamique premi√®re fois</div>
            </div>
            <div class="validation-item">
                <div><strong>Cache Hit R√©p√©tition:</strong> <span id="test2Status" class="status pending">‚è≥ En attente</span></div>
                <div>V√©rification r√©cup√©ration cache (< 1ms)</div>
            </div>
            <div class="validation-item">
                <div><strong>Mise en Cache:</strong> <span id="test3Status" class="status pending">‚è≥ En attente</span></div>
                <div>Validation sauvegarde automatique r√©sultats</div>
            </div>
        </div>

        <div class="test-suite suite-2">
            <h2>üî• Suite 2: Tests Stress Performance</h2>
            <div class="validation-item">
                <div><strong>Calculs Multiples:</strong> <span id="test4Status" class="status pending">‚è≥ En attente</span></div>
                <div>100 calculs rapides pour test stabilit√©</div>
            </div>
            <div class="validation-item">
                <div><strong>Limite Cache:</strong> <span id="test5Status" class="status pending">‚è≥ En attente</span></div>
                <div>Validation nettoyage automatique √† 1000 entr√©es</div>
            </div>
            <div class="validation-item">
                <div><strong>Performance Globale:</strong> <span id="test6Status" class="status pending">‚è≥ En attente</span></div>
                <div>Mesure gain vitesse cache vs calcul</div>
            </div>
        </div>

        <div class="test-suite suite-3">
            <h2>‚ö° Suite 3: Validation Fonctionnelle</h2>
            <div class="validation-item">
                <div><strong>Consistance R√©sultats:</strong> <span id="test7Status" class="status pending">‚è≥ En attente</span></div>
                <div>M√™me combinaison = m√™me recommandation</div>
            </div>
            <div class="validation-item">
                <div><strong>Int√©grit√© Cache:</strong> <span id="test8Status" class="status pending">‚è≥ En attente</span></div>
                <div>V√©rification corruption donn√©es cache</div>
            </div>
            <div class="validation-item">
                <div><strong>Gestion M√©moire:</strong> <span id="test9Status" class="status pending">‚è≥ En attente</span></div>
                <div>Contr√¥le utilisation m√©moire cache</div>
            </div>
        </div>

        <div class="button-group">
            <button onclick="runFullValidation()" id="validationBtn">üöÄ Lancer Validation Compl√®te</button>
            <button onclick="showDetailedReport()">üìä Rapport D√©taill√©</button>
            <button onclick="resetValidation()">üîÑ Reset Tests</button>
        </div>

        <div class="final-report" id="finalReport" style="display: none;">
            <h2>üéâ Rapport Final de Validation</h2>
            <div class="metric">
                <div class="big-number" id="successRate">0%</div>
                <div>Taux de R√©ussite</div>
            </div>
            <div class="metric">
                <div class="big-number" id="avgPerformance">0ms</div>
                <div>Performance Moyenne</div>
            </div>
            <div class="metric">
                <div class="big-number" id="cacheEfficiency">0%</div>
                <div>Efficacit√© Cache</div>
            </div>
            <div id="finalConclusion" style="margin-top: 20px; font-size: 1.2em;"></div>
        </div>

        <div id="detailedResults" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;"></div>
    </div>

    <!-- Inclusion du calculateur dynamique -->
    <script src="/js/dynamic-coin-recommender.js"></script>
    
    <script>
        let calculator = null;
        let validationResults = {};
        let testMetrics = {
            totalTests: 0,
            successfulTests: 0,
            totalTime: 0,
            cacheHits: 0,
            cacheMisses: 0
        };

        // === INITIALISATION ===
        async function initializeCalculator() {
            try {
                let attempts = 0;
                while (!window.dynamicRecommender && attempts < 20) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                calculator = window.dynamicRecommender;
                
                attempts = 0;
                while (!calculator.products && attempts < 20) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                if (calculator && calculator.products) {
                    console.log('üéØ Validation finale: Calculateur pr√™t');
                    document.getElementById('validationBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('Erreur initialisation validation finale:', error);
            }
        }

        // === TESTS DE VALIDATION ===
        async function runFullValidation() {
            const btn = document.getElementById('validationBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Validation en cours...';

            // Reset m√©triques
            testMetrics = {
                totalTests: 0,
                successfulTests: 0,
                totalTime: 0,
                cacheHits: 0,
                cacheMisses: 0
            };

            // Vider le cache pour tests propres
            if (calculator.cache) {
                calculator.cache.clear();
            }

            // Ex√©cuter les 9 tests de validation
            await runTest1(); // Cache Miss Initial
            await runTest2(); // Cache Hit R√©p√©tition
            await runTest3(); // Mise en Cache
            await runTest4(); // Calculs Multiples
            await runTest5(); // Limite Cache
            await runTest6(); // Performance Globale
            await runTest7(); // Consistance R√©sultats
            await runTest8(); // Int√©grit√© Cache
            await runTest9(); // Gestion M√©moire

            // G√©n√©rer rapport final
            generateFinalReport();

            btn.disabled = false;
            btn.textContent = '‚úÖ Validation Termin√©e';
        }

        // === TESTS INDIVIDUELS ===
        async function runTest1() {
            const testId = 'test1Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                const needs = { copper: 5, silver: 3, electrum: 2, gold: 4, platinum: 1 };
                const cacheKey = JSON.stringify(needs);
                const wasCached = calculator.cache.has(cacheKey);
                
                const start = performance.now();
                const result = calculator.recommend(5, 3, 2, 4, 1);
                const time = performance.now() - start;
                
                const isNowCached = calculator.cache.has(cacheKey);
                
                if (!wasCached && isNowCached && result.length > 0 && time > 0.5) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                    testMetrics.cacheMisses++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                testMetrics.totalTime += time;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest2() {
            const testId = 'test2Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                // M√™me calcul que test 1
                const needs = { copper: 5, silver: 3, electrum: 2, gold: 4, platinum: 1 };
                const cacheKey = JSON.stringify(needs);
                const wasCached = calculator.cache.has(cacheKey);
                
                const start = performance.now();
                const result = calculator.recommend(5, 3, 2, 4, 1);
                const time = performance.now() - start;
                
                if (wasCached && result.length > 0 && time < 1) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                    testMetrics.cacheHits++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                testMetrics.totalTime += time;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest3() {
            const testId = 'test3Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                const initialSize = calculator.cache.size;
                const needs = { copper: 8, silver: 5, electrum: 3, gold: 6, platinum: 2 };
                
                calculator.recommend(8, 5, 3, 6, 2);
                const finalSize = calculator.cache.size;
                
                if (finalSize > initialSize) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest4() {
            const testId = 'test4Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                let allSuccessful = true;
                const times = [];
                
                for (let i = 0; i < 100; i++) {
                    const start = performance.now();
                    const result = calculator.recommend(
                        Math.floor(Math.random() * 10) + 1,
                        Math.floor(Math.random() * 8) + 1,
                        Math.floor(Math.random() * 5) + 1,
                        Math.floor(Math.random() * 6) + 1,
                        Math.floor(Math.random() * 4) + 1
                    );
                    const time = performance.now() - start;
                    times.push(time);
                    
                    if (!result || result.length === 0) {
                        allSuccessful = false;
                        break;
                    }
                    
                    // Pause micro pour √©viter freeze
                    if (i % 20 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 1));
                    }
                }
                
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                
                if (allSuccessful && avgTime < 50) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                testMetrics.totalTime += times.reduce((a, b) => a + b, 0);
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest5() {
            const testId = 'test5Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                // Remplir le cache au-del√† de la limite
                let testsAdded = 0;
                while (calculator.cache.size < 1010 && testsAdded < 1500) {
                    calculator.recommend(
                        Math.floor(Math.random() * 20) + 1,
                        Math.floor(Math.random() * 15) + 1,
                        Math.floor(Math.random() * 10) + 1,
                        Math.floor(Math.random() * 12) + 1,
                        Math.floor(Math.random() * 8) + 1
                    );
                    testsAdded++;
                    
                    if (testsAdded % 100 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 1));
                    }
                }
                
                if (calculator.cache.size <= 1000) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest6() {
            const testId = 'test6Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                // Test performance cache vs sans cache
                const needs = { copper: 12, silver: 7, electrum: 4, gold: 9, platinum: 3 };
                
                // Premier calcul (sans cache)
                const start1 = performance.now();
                calculator.recommend(12, 7, 4, 9, 3);
                const time1 = performance.now() - start1;
                
                // Deuxi√®me calcul (avec cache)
                const start2 = performance.now();
                calculator.recommend(12, 7, 4, 9, 3);
                const time2 = performance.now() - start2;
                
                const speedup = time1 / time2;
                
                if (speedup > 5) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                testMetrics.totalTime += time1 + time2;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest7() {
            const testId = 'test7Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                // Test consistance r√©sultats
                const result1 = calculator.recommend(6, 4, 2, 5, 2);
                const result2 = calculator.recommend(6, 4, 2, 5, 2);
                const result3 = calculator.recommend(6, 4, 2, 5, 2);
                
                const consistent = JSON.stringify(result1) === JSON.stringify(result2) && 
                                  JSON.stringify(result2) === JSON.stringify(result3);
                
                if (consistent && result1.length > 0) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest8() {
            const testId = 'test8Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                // Test int√©grit√© cache
                const initialSize = calculator.cache.size;
                const testKey = JSON.stringify({ copper: 999, silver: 999, electrum: 999, gold: 999, platinum: 999 });
                
                // Ajouter une entr√©e
                calculator.recommend(999, 999, 999, 999, 999);
                
                // V√©rifier que l'entr√©e existe
                const hasKey = calculator.cache.has(testKey);
                const finalSize = calculator.cache.size;
                
                if (hasKey && finalSize > initialSize) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        async function runTest9() {
            const testId = 'test9Status';
            setTestStatus(testId, 'pending', '‚è≥ Test...');
            
            try {
                // Test gestion m√©moire
                const cacheSize = calculator.cache.size;
                const memoryEstimate = cacheSize * 100; // Estimation basique
                
                // V√©rification limite raisonnable
                if (cacheSize <= 1000 && memoryEstimate < 100000) {
                    setTestStatus(testId, 'success', '‚úÖ R√©ussi');
                    testMetrics.successfulTests++;
                } else {
                    setTestStatus(testId, 'error', '‚ùå √âchec');
                }
                
                testMetrics.totalTests++;
                
            } catch (error) {
                setTestStatus(testId, 'error', '‚ùå Erreur');
                testMetrics.totalTests++;
            }
        }

        // === UTILITAIRES ===
        function setTestStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = 'status ' + status;
            element.textContent = text;
        }

        function generateFinalReport() {
            const successRate = Math.round((testMetrics.successfulTests / testMetrics.totalTests) * 100);
            const avgPerformance = Math.round(testMetrics.totalTime / testMetrics.totalTests * 100) / 100;
            const cacheEfficiency = testMetrics.cacheHits + testMetrics.cacheMisses > 0 ? 
                Math.round((testMetrics.cacheHits / (testMetrics.cacheHits + testMetrics.cacheMisses)) * 100) : 0;

            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('avgPerformance').textContent = avgPerformance + 'ms';
            document.getElementById('cacheEfficiency').textContent = cacheEfficiency + '%';

            let conclusion = '';
            if (successRate >= 90) {
                conclusion = 'üéâ VALIDATION R√âUSSIE - Cache dynamique enti√®rement fonctionnel !';
            } else if (successRate >= 70) {
                conclusion = '‚ö†Ô∏è VALIDATION PARTIELLE - Quelques optimisations requises';
            } else {
                conclusion = '‚ùå VALIDATION √âCHOU√âE - Corrections n√©cessaires';
            }

            document.getElementById('finalConclusion').textContent = conclusion;
            document.getElementById('finalReport').style.display = 'block';
        }

        function showDetailedReport() {
            const detailsDiv = document.getElementById('detailedResults');
            detailsDiv.innerHTML = `
                <h3>üìä Rapport D√©taill√©</h3>
                <div><strong>Tests total:</strong> ${testMetrics.totalTests}</div>
                <div><strong>Tests r√©ussis:</strong> ${testMetrics.successfulTests}</div>
                <div><strong>Temps total:</strong> ${testMetrics.totalTime.toFixed(2)}ms</div>
                <div><strong>Cache hits:</strong> ${testMetrics.cacheHits}</div>
                <div><strong>Cache misses:</strong> ${testMetrics.cacheMisses}</div>
                <div><strong>Taille cache:</strong> ${calculator ? calculator.cache.size : 'N/A'} entr√©es</div>
            `;
            detailsDiv.style.display = 'block';
        }

        function resetValidation() {
            // Reset tous les status
            for (let i = 1; i <= 9; i++) {
                setTestStatus(`test${i}Status`, 'pending', '‚è≥ En attente');
            }
            
            document.getElementById('finalReport').style.display = 'none';
            document.getElementById('detailedResults').style.display = 'none';
            document.getElementById('validationBtn').textContent = 'üöÄ Lancer Validation Compl√®te';
            document.getElementById('validationBtn').disabled = false;
        }

        // === INITIALISATION ===
        window.addEventListener('load', initializeCalculator);
    </script>
</body>
</html>